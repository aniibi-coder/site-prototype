<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meow meow land</title>
  
<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
  :root { --bg:#0b1220; --card:#121a2b; --text:#eaf0ff; --muted:#9fb0d0; --line:#24304a; }
body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
header { padding:14px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:12px; }
header .badge { font-size:12px; color:var(--muted); border:1px solid var(--line); padding:4px 8px; border-radius:999px; }
.wrap { display:grid; grid-template-columns: 1.6fr 1fr; height: calc(100vh - 56px); }
#map { height:100%; }
.side { padding:14px; border-left:1px solid var(--line); overflow:auto; }
.card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:12px; }
.title { font-size:18px; margin:0 0 6px 0; }
.muted { color:var(--muted); font-size:13px; }
.row { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
.pill { border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:13px; color:var(--muted); }
button { cursor:pointer; width:100%; border:0; border-radius:12px; padding:10px 12px; background:#2a6dff; color:white; font-weight:600; margin-top:12px; }
button:disabled { opacity:.6; cursor:not-allowed; }
.hint { font-size:13px; color:var(--muted); line-height:1.4; }

/* ‚úÖ controls ‚Äî –í–ù–ï media */
.control { margin-top:10px; }
.control label {
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:13px;
  color:var(--muted);
}
input[type="range"] { width:100%; margin-top:8px; }

.toggle { display:flex; gap:8px; margin-top:10px; }
.toggle button{
  flex:1;
  background:transparent;
  border:1px solid var(--line);
  color:var(--muted);
  padding:10px 12px;
  border-radius:12px;
  font-weight:700;
  width:auto;
  margin-top:0;
}
.toggle button.active{
  background:#2a6dff;
  border-color:#2a6dff;
  color:#fff;
}
.kpi { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    .avatarBox{
  border:1px dashed var(--line);
  border-radius:14px;
  padding:10px;
  background: rgba(255,255,255,0.02);
}
/* –∞–≤–∞—Ç–∞—Ä */
.avatarStage{
  position: relative;
  width: 100%;
  max-width: 280px;
  aspect-ratio: 3/4; /* —É–¥–æ–±–Ω–æ –ø–æ–¥ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
  margin: 0 auto;
  border-radius: 12px;
  overflow: hidden;
  background: radial-gradient(circle at 30% 10%, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
}

.avatarStage img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit: contain;
  image-rendering: auto;
}

/* üì± mobile */
@media (max-width: 900px){
  .wrap { grid-template-columns: 1fr; }
  .side { border-left:0; border-top:1px solid var(--line); height:42vh; }
  #map { height: calc(58vh); }
}
  </style>
</head>

<body>
  <header>
    <div style="font-weight:700;">Ski Touring Gear Finder</div>
    <div class="badge">MVP ‚Ä¢ one page ‚Ä¢ Leaflet</div>
  </header>

  <div class="wrap">
    <div id="map"></div>

   <div class="side">

  <!-- 1) Panel: mountain details -->
  <div class="card" id="panel">
    <h2 class="title">Pick a mountain</h2>
    <div class="hint">
      Click a marker on the map. Today we set up the map + locations. Next: temperature & budget logic.
    </div>
  </div>

  <!-- 2) Controls (–µ—Å–ª–∏ —Ç—ã —É–∂–µ –≤—Å—Ç–∞–≤–∏–ª controls —Ä–∞–Ω—å—à–µ ‚Äî –æ—Å—Ç–∞–≤—å –æ–¥–∏–Ω, –Ω–µ –¥—É–±–ª–∏—Ä—É–π) -->
  <div class="card" id="controls">
    <h2 class="title">Setup</h2>

    <div class="toggle" role="tablist" aria-label="Sport switch">
      <button id="btnSki" class="active" type="button">Ski</button>
      <button id="btnSnow" type="button">Snowboard</button>
    </div>

    <div class="control">
      <label>
        <span>Temperature</span>
        <span class="pill" id="tempVal">-8¬∞C</span>
      </label>
      <input id="tempRange" type="range" min="-25" max="5" step="1" value="-8">
    </div>

    <div class="control">
      <label>
        <span>Budget</span>
        <span class="pill" id="budgetVal">‚Ç¨800</span>
      </label>
      <input id="budgetRange" type="range" min="300" max="2000" step="50" value="800">
    </div>

    <div class="kpi">
      <div class="pill" id="sportVal">Sport: Ski</div>
      <div class="pill" id="levelVal">Level: Normal</div>
    </div>

    <div class="hint" style="margin-top:10px;">
      Today: sliders + toggle. Next: outfit preview (PNG layers) will change based on these values.
    </div>
  </div>

  <!-- 3) Outfit preview -->
  <div class="card" id="outfitCard">
    <h2 class="title">Outfit preview</h2>
    <div class="muted">Tomorrow: layers will change based on temp + budget.</div>

    <div class="avatarBox" style="margin-top:10px;">
      <div class="avatarStage">
        <img id="charBase" alt="Character base" />
        <img id="layerBase" alt="Base layer" />
        <img id="layerMid" alt="Mid layer" />
        <img id="layerShell" alt="Shell" />
        <img id="layerPants" alt="Pants" />
        <img id="layerGloves" alt="Gloves" />
      </div>
    </div>

    <div class="hint" style="margin-top:10px;">
      Tip: upload PNG layers later to <code>assets/character</code> and <code>assets/gear</code>.
    </div>
  </div>

  <!-- 4) Disclaimer -->
  <div class="card">
    <div class="muted">
      Disclaimer (draft): Recommendations are generic and informational only. Always check real weather & avalanche bulletin before touring.
    </div>
  </div>

</div>

  </div>

<script>
  // --- 1) Data (Day 1): a small, editable list of places ---
  // tempProfile is "typical" for now: will be replaced/extended later.
  
async function loadLocations() {
  const res = await fetch("./data/locations.geojson");
  if (!res.ok) throw new Error("Failed to load GeoJSON: " + res.status);
  const geo = await res.json();

  return geo.features.map(f => {
    const p = f.properties;
    const [lon, lat] = f.geometry.coordinates;

    return {
      id: p.id,
      name: p.name,
      region: p.region,
      country: p.country,
      image: p.image || null,   // ‚úÖ –í–û–¢ –¢–£–¢
      lat, lon,
      base_m: p.base_m,
      top_m: p.top_m,
      tempProfile: { mild: p.mild, normal: p.normal, cold: p.cold }
    };
  });
}

  // --- 2) Map init ---
  const map = L.map('map', { zoomControl:true }).setView([45.5, 6.6], 8);

  // Free tiles (OpenStreetMap)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const markersLayer = L.markerClusterGroup({
  showCoverageOnHover: false,
  spiderfyOnMaxZoom: true
});
map.addLayer(markersLayer);
  
// ---------- Weather (Open-Meteo) ----------
const weatherCache = new Map(); // key -> { ts, data }
const WEATHER_TTL_MS = 15 * 60 * 1000; // 15 minutes

function cacheKey(lat, lon) {
  // –æ–∫—Ä—É–≥–ª–∏–º, —á—Ç–æ–±—ã –∫–µ—à —Ä–∞–±–æ—Ç–∞–ª —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ
  return `${lat.toFixed(3)},${lon.toFixed(3)}`;
}

function weatherCodeToText(code) {
  const map = {
    0: "Clear",
    1: "Mostly clear",
    2: "Partly cloudy",
    3: "Overcast",
    45: "Fog",
    48: "Depositing rime fog",
    51: "Light drizzle",
    53: "Drizzle",
    55: "Heavy drizzle",
    56: "Freezing drizzle",
    57: "Heavy freezing drizzle",
    61: "Light rain",
    63: "Rain",
    65: "Heavy rain",
    66: "Freezing rain",
    67: "Heavy freezing rain",
    71: "Light snow",
    73: "Snow",
    75: "Heavy snow",
    77: "Snow grains",
    80: "Rain showers",
    81: "Rain showers",
    82: "Violent rain showers",
    85: "Snow showers",
    86: "Heavy snow showers",
    95: "Thunderstorm",
    96: "Thunderstorm + hail",
    99: "Thunderstorm + heavy hail"
  };
  return map[code] ?? `Weather code ${code}`;
}

function degToCompass(deg) {
  const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  const i = Math.round((deg % 360) / 22.5) % 16;
  return dirs[i];
}

async function getWeather(lat, lon) {
  const key = cacheKey(lat, lon);
  const cached = weatherCache.get(key);
  if (cached && (Date.now() - cached.ts) < WEATHER_TTL_MS) return cached.data;

  const url =
    `https://api.open-meteo.com/v1/forecast` +
    `?latitude=${encodeURIComponent(lat)}` +
    `&longitude=${encodeURIComponent(lon)}` +
    `&current_weather=true` +
    `&hourly=precipitation,snowfall,cloudcover` +
    `&timezone=auto`;

  const res = await fetch(url);
  if (!res.ok) throw new Error(`Weather API error: ${res.status}`);
  const data = await res.json();

  weatherCache.set(key, { ts: Date.now(), data });
  return data;
}

function pickHourlyAtTime(hourly, targetTimeStr) {
  // targetTimeStr –æ–±—ã—á–Ω–æ –∫–∞–∫ "2026-01-02T10:00"
  const times = hourly?.time || [];
  const idx = times.indexOf(targetTimeStr);
  if (idx === -1) return null;
  return {
    precipitation: hourly.precipitation?.[idx] ?? null,
    snowfall: hourly.snowfall?.[idx] ?? null,
    cloudcover: hourly.cloudcover?.[idx] ?? null
  };
}

function deriveConditions(current, hourlyAt) {
  const temp = current.temperature;
  const wind = current.windspeed;
  const code = current.weathercode;
  const base = weatherCodeToText(code);

  const snow = hourlyAt?.snowfall ?? 0;
  const rain = hourlyAt?.precipitation ?? 0;
  const cloud = hourlyAt?.cloudcover ?? null;

  // –ø—Ä–æ—Å—Ç–∞—è ‚Äú—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∞—è‚Äù –º–µ—Ç–∫–∞ –¥–ª—è —É—Å–ª–æ–≤–∏–π (–¥–ª—è MVP)
  let tags = [];

  if (snow >= 0.2) tags.push("Snowfall");
  else if (rain >= 0.5) tags.push("Wet");

  if (wind >= 35) tags.push("Very windy");
  else if (wind >= 20) tags.push("Windy");

  if (temp <= -12) tags.push("Very cold");
  else if (temp <= -6) tags.push("Cold");
  else if (temp <= 0) tags.push("Near freezing");
  else tags.push("Mild");

  if (cloud !== null) {
    if (cloud >= 80) tags.push("Overcast");
    else if (cloud >= 40) tags.push("Cloudy");
    else tags.push("Sunny-ish");
  }

  return { base, tags };
}

let selectedLocationId = null;

function renderPanel(loc){
  selectedLocationId = loc.id;

  const panel = document.getElementById('panel');
 panel.innerHTML = `
  ${loc.image ? `
    <div style="
      margin:-14px -14px 12px -14px;
      height:160px;
      background-image:
  linear-gradient(to bottom, rgba(0,0,0,.15), rgba(0,0,0,.55)),
  url('${loc.image}');
      background-size:cover;
      background-position:center;
      border-radius:14px 14px 0 0;
      border-bottom:1px solid var(--line);
    "></div>
  ` : ``}

  <h2 class="title">${loc.name}</h2>
  
    <div class="muted">${loc.region}, ${loc.country}</div>

    <div class="row">
      <div class="pill">Base: ${loc.base_m} m</div>
      <div class="pill">Top: ${loc.top_m} m</div>
    </div>

    <div style="margin-top:12px;" id="weatherBox">
      <div class="muted">Live weather (Open-Meteo)</div>
      <div class="hint" style="margin-top:6px;">Loading‚Ä¶</div>
    </div>

    <button id="nextBtn">Next: budget + gear logic</button>
    <div class="hint" style="margin-top:10px;">
      Next we add: budget slider + gear recommendation using these conditions.
    </div>
  `;

  document.getElementById('nextBtn').onclick = () => {
    alert("Nice. Next: budget + gear logic.");
  };

  // –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥—ã (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
  updateWeatherFor(loc);
}

async function updateWeatherFor(loc) {
  const box = document.getElementById('weatherBox');
  try {
    const data = await getWeather(loc.lat, loc.lon);

    // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∫–ª–∏–∫–Ω—É–ª –¥—Ä—É–≥—É—é –≥–æ—Ä—É ‚Äî –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç–æ—á–∫—É
    if (selectedLocationId !== loc.id) return;

    const current = data.current_weather;
    state.tempC = Math.round(current.temperature);

const tempRange = document.getElementById("tempRange");
if (tempRange) tempRange.value = state.tempC;

if (typeof updateSetupUI === "function") updateSetupUI();
    const hourlyAt = pickHourlyAtTime(data.hourly, current.time);
    const cond = deriveConditions(current, hourlyAt);

    const windDir = degToCompass(current.winddirection);

    const precip = hourlyAt?.precipitation;
    const snow = hourlyAt?.snowfall;
    const cloud = hourlyAt?.cloudcover;

    box.innerHTML = `
      <div class="muted">Live weather (Open-Meteo)</div>

      <div class="row" style="margin-top:8px;">
        <div class="pill">Temp: ${Math.round(current.temperature)}¬∞C</div>
        <div class="pill">Wind: ${Math.round(current.windspeed)} km/h ${windDir}</div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="pill">${cond.base}</div>
        ${cond.tags.map(t => `<div class="pill">${t}</div>`).join("")}
      </div>

      <div class="hint" style="margin-top:10px;">
        ${precip != null ? `Precip: ${precip} mm/h` : "Precip: n/a"} ‚Ä¢
        ${snow != null ? `Snow: ${snow} cm/h` : "Snow: n/a"} ‚Ä¢
        ${cloud != null ? `Cloud: ${cloud}%` : "Cloud: n/a"} ‚Ä¢
        Updated: ${current.time}
      </div>
    `;
  } catch (e) {
    console.error(e);
    box.innerHTML = `
      <div class="muted">Live weather (Open-Meteo)</div>
      <div class="hint" style="margin-top:6px;">
        Couldn‚Äôt load weather. Try refresh (Ctrl+F5).<br/>
        <span class="muted">${e.message}</span>
      </div>
    `;
  }
}
  
let LOCATIONS = [];

(async () => {
  try {
    LOCATIONS = await loadLocations();
    addMarkers();

    const bounds = L.latLngBounds(LOCATIONS.map(l => [l.lat, l.lon]));
    map.fitBounds(bounds.pad(0.35));
  } catch (e) {
    console.error(e);
    document.getElementById('panel').innerHTML = `
      <h2 class="title">Error loading locations</h2>
      <div class="muted">${e.message}</div>
      <div class="hint" style="margin-top:10px;">
        Check that <code>data/locations.geojson</code> exists and is committed.
      </div>
    `;
  }
})();

  function addMarkers(){
    markersLayer.clearLayers();
    LOCATIONS.forEach(loc => {
      const m = L.marker([loc.lat, loc.lon]);
      m.bindPopup(`<b>${loc.name}</b><br>${loc.region}, ${loc.country}`);
      m.on('click', () => renderPanel(loc));
      markersLayer.addLayer(m);
    });
  }
  // ---------- UI State (Temperature + Budget + Sport) ----------
const state = {
  sport: "ski",   // "ski" | "snow"
  tempC: -8,
  budget: 800,
};

function budgetTier(b) {
  if (b < 600) return "Low";
  if (b < 1200) return "Mid";
  return "High";
}

function tempLevel(t) {
  if (t <= -12) return "Very cold";
  if (t <= -6) return "Cold";
  if (t <= 0) return "Near freezing";
  return "Mild";
}

function updateSetupUI() {
  document.getElementById("tempVal").textContent = `${state.tempC}¬∞C`;
  document.getElementById("budgetVal").textContent = `‚Ç¨${state.budget}`;
  document.getElementById("sportVal").textContent = `Sport: ${state.sport === "ski" ? "Ski" : "Snowboard"}`;
  document.getElementById("levelVal").textContent = `Level: ${tempLevel(state.tempC)} ‚Ä¢ ${budgetTier(state.budget)}`;

  // TODO –∑–∞–≤—Ç—Ä–∞: updateOutfitPreview(state)
}

function wireSetupControls() {
  const tempRange = document.getElementById("tempRange");
  const budgetRange = document.getElementById("budgetRange");
  const btnSki = document.getElementById("btnSki");
  const btnSnow = document.getElementById("btnSnow");

  tempRange.value = state.tempC;
  budgetRange.value = state.budget;

  tempRange.addEventListener("input", () => {
    state.tempC = parseInt(tempRange.value, 10);
    updateSetupUI();
  });

  budgetRange.addEventListener("input", () => {
    state.budget = parseInt(budgetRange.value, 10);
    updateSetupUI();
  });

  btnSki.addEventListener("click", () => {
    state.sport = "ski";
    btnSki.classList.add("active");
    btnSnow.classList.remove("active");
    updateSetupUI();
  });

  btnSnow.addEventListener("click", () => {
    state.sport = "snow";
    btnSnow.classList.add("active");
    btnSki.classList.remove("active");
    updateSetupUI();
  });

  updateSetupUI();
}

document.addEventListener("DOMContentLoaded", () => {
  wireSetupControls();
});


</script>
</body>
</html>
