<!doctype html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ST9720GK2Y"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  
  gtag('config', 'G-ST9720GK2Y');
</script>
  <meta charset="utf-8" />
  
    <!-- ===== FAVICONS ===== -->
    <!-- ===== FAVICONS ===== -->
<link rel="icon" type="image/png" sizes="32x32" href="./assets/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="./assets/icons/favicon-16x16.png">
<link rel="icon" href="./assets/icons/favicon.ico" sizes="any">
<link rel="apple-touch-icon" href="./assets/icons/apple-touch-icon.png">
<meta name="theme-color" content="#080d16">
<meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- ===================== SEO (edit me) ===================== -->
  <!-- SEO: Title shown in Google -->
  <title>Ridekit ‚Äî Outfit selection helper for ski & snowboard</title>

  <!-- SEO: Short description for Google snippet -->
  <meta name="description" content="Ridekit is a prototype that helps you explore ski & snowboard outfit recommendations based on mountain weather conditions. Pick a location, check forecast, and see a suggested layering setup.">

  <!-- SEO: Indexing rules -->
  <meta name="robots" content="index,follow">

  <!-- SEO: Canonical URL (update if you change domain/path) -->
  <link rel="canonical" href="https://ridekit.fr/">

  <!-- SEO: Open Graph (social sharing) -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="RIDEKIT.FR">
  <meta property="og:title" content="Ridekit ‚Äî Outfit selection helper">
  <meta property="og:description" content="Prototype: outfit recommendations for skiing & snowboarding based on weather and conditions.">
  <meta property="og:url" content="https://ridekit.fr/">
  <meta property="og:image" content="https://ridekit.fr/assets/icons/apple-touch-icon.png">

  <!-- SEO: Twitter card -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Ridekit ‚Äî Outfit selection helper">
  <meta name="twitter:description" content="Prototype: outfit recommendations for skiing & snowboarding based on weather and conditions.">
  <meta name="twitter:image" content="https://ridekit.fr/assets/icons/apple-touch-icon.png">

  <!-- SEO: Structured data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "RIDEKIT.FR",
    "url": "https://ridekit.fr/"
  }
  </script>
  <!-- =================== /SEO (edit me) =================== -->

<!-- Favicon -->
<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Press+Start+2P&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
/* ===== WINTER ALPINE DESIGN SYSTEM ===== */
:root {
  --bg: #080d16;
  --bg-secondary: #0c1221;
  --card: #101828;
  --card-hover: #151f35;

  --text: #eaf4ff;
  --text-muted: #8ba4c7;
  --text-dim: #5a7299;

  --ice: #38bdf8;
  --ice-glow: #7dd3fc;
  --frost: #a5f3fc;
  --aurora-blue: #2563eb;
  --aurora-purple: #8b5cf6;
  --aurora-pink: #ec4899;
  --snow: #f0f9ff;
  --green-glow: #4ade80;

  --line: #1e3a5f;
  --line-light: #2a4a70;
  --glass-border: rgba(56, 189, 248, 0.15);

  --shadow-glow: 0 0 40px rgba(56, 189, 248, 0.15);
  --shadow-frost: 0 8px 32px rgba(8, 13, 22, 0.8);
  --gradient-aurora: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(236, 72, 153, 0.1) 50%, rgba(56, 189, 248, 0.15) 100%);
  --gradient-night: linear-gradient(180deg, #0c1221 0%, #080d16 100%);
  --gradient-card: linear-gradient(135deg, rgba(16, 24, 40, 0.9) 0%, rgba(12, 18, 33, 0.95) 100%);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow-y: auto;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

.font-pixel {
  font-family: 'Press Start 2P', monospace;
  letter-spacing: 1px;
}

/* ===== SNOWFALL ANIMATION ===== */
.snowfall {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 20; /* behind header/cards, above map tiles a bit */
  overflow: hidden;
  mix-blend-mode: screen;
  opacity: .7;
}

.snowflake {
  position: absolute;
  background: white;
  border-radius: 50%;
  opacity: 0;
  animation: fall linear infinite;
  filter: blur(.2px);
}

@keyframes fall {
  0% { opacity: 0; transform: translateY(-10vh) translateX(0) rotate(0deg); }
  10% { opacity: 1; }
  90% { opacity: 0.8; }
  100% { opacity: 0; transform: translateY(100vh) translateX(30px) rotate(360deg); }
}

/* ===== FADE IN ANIMATIONS ===== */
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideInLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

/* ===== HEADER (fixed, stays on top) ===== */
header {
      height: 64px;
      padding: 0 24px;
      border-bottom: 1px solid var(--line);

      /* ‚úÖ Always pinned to viewport (won't scroll with content) */
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;

      background: rgba(8, 13, 22, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 10000;

      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 16px;
      animation: fadeIn 0.5s ease-out;
    }

.headerLeft { display:flex; align-items:center; gap:16px; min-width:0; }
.badge{
  font-size: 10px;
  color: var(--text-muted);
  border: 1px solid var(--line);
  padding: 6px 12px;
  border-radius: 999px;
  background: rgba(16, 24, 40, 0.5);
  backdrop-filter: blur(6px);
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space:nowrap;
}

.headerNav{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}
.headerNav a{
  color: var(--text-muted);
  text-decoration:none;
  font-weight: 600;
  font-size: 13px;
  border: 1px solid var(--line);
  padding: 8px 16px;
  border-radius: 999px;
  background: rgba(16, 24, 40, 0.6);
  backdrop-filter: blur(8px);
  transition: all 0.3s ease;
  display:flex;
  align-items:center;
  gap:8px;
}
.headerNav a:hover{
  color: var(--text);
  background: rgba(30, 58, 95, 0.4);
  border-color: var(--line-light);
  transform: translateY(-2px);
}
.headerNav a.active{
  background: rgba(56, 189, 248, 0.15);
  border-color: rgba(56, 189, 248, 0.4);
  color: var(--ice);
  box-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
}
.headerRight{ justify-self:end; }

    .langSwitch{
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(16, 24, 40, 0.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .langIcon{
      font-size: 13px;
      color: var(--text-muted);
      margin-right: 2px;
      opacity: 0.9;
    }
    .langBtn{
      border:1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      letter-spacing:0.6px;
      cursor:pointer;
      transition: all 0.25s ease;
      font-family: inherit;
    }
    .langBtn:hover{
      color: var(--text);
      background: rgba(30, 58, 95, 0.35);
      border-color: var(--line-light);
      transform: translateY(-1px);
    }
    .langBtn.active{
      background: rgba(56, 189, 248, 0.15);
      border-color: rgba(56, 189, 248, 0.4);
      color: var(--ice);
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.18);
    }
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(10px);
      background: rgba(16, 24, 40, 0.92);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease, transform .25s ease;
      z-index: 10000;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow-frost);
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }


@media (max-width: 768px){
  header{ height:auto; grid-template-columns: 1fr; padding: 12px 16px; gap:12px; }
  .headerLeft{ justify-content:center; flex-wrap:wrap; }
  .headerRight{ justify-self:center; }
}

/* ===== MAIN LAYOUT ===== */
.wrap{
  padding-top: 80px; /* header space */
  min-height: 100vh;
  display:grid;
  grid-template-columns: 1.15fr 1fr;
  grid-template-rows: 400px auto auto;
  gap: 16px;
  padding: 80px 16px 16px;
  max-width: 1600px;
  margin: 0 auto;
  align-content:start;
}
@media (max-width: 1100px){
  .wrap{ grid-template-columns: 1fr; grid-template-rows: 300px auto auto auto; }
}

/* ===== CARDS ===== */
.card{
  background: var(--gradient-card);
  border: 1px solid var(--line);
  border-radius: 20px;
  padding: 20px;
  overflow:hidden;
  position:relative;
  transition: all 0.4s ease;
  min-height:0;
}
.card::before{
  content:'';
  position:absolute;
  inset:0;
  background: var(--gradient-aurora);
  opacity:0;
  transition: opacity 0.4s ease;
  pointer-events:none;
}
.card:hover::before{ opacity:1; }
.card:hover{
  border-color: var(--glass-border);
  transform: translateY(-2px);
  box-shadow: var(--shadow-glow);
}

.title{
  font-family: 'Press Start 2P', monospace;
  font-size: 14px;
  margin: 0 0 8px 0;
  color: var(--snow);
  text-shadow: 0 0 20px rgba(240, 249, 255, 0.3);
  letter-spacing: 1px;
  text-transform: uppercase;
}
.muted{ color: var(--text-muted); font-size: 13px; }
.hint{ font-size: 13px; color: var(--text-muted); line-height: 1.5; }
.row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; align-items:center; }
.pill{
  border: 1px solid var(--line);
  border-radius: 999px;
  padding: 6px 14px;
  font-size: 12px;
  color: var(--text-muted);
  background: rgba(16, 24, 40, 0.6);
  backdrop-filter: blur(8px);
  white-space: nowrap;
  transition: all 0.3s ease;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.pill:hover{ border-color: var(--line-light); background: rgba(30, 58, 95, 0.4); }

.divider{
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, var(--line) 50%, transparent 100%);
  margin: 16px 0;
}

/* ===== MAP ===== */
#mapCard{ grid-column:1; grid-row:1; padding:0; overflow:hidden; animation: fadeInUp .6s ease-out; }
#map{ width:100%; height:100%; border-radius: 20px; }
.leaflet-container{ background: var(--bg-secondary) !important; }

/* Map search */
.mapSearch{
  position:absolute;
  top: 14px;
  left: 60px;
  z-index: 1000;
  display:flex;
  align-items:flex-start;
  gap: 10px;
  pointer-events:auto;
}
.mapSearchBtn{
  width: 44px;
  height: 44px;
  border-radius: 14px;
  border: 1px solid var(--line);
  background: rgba(16, 24, 40, 0.8);
  color: var(--text);
  cursor:pointer;
  font-size: 18px;
  display:flex;
  align-items:center;
  justify-content:center;
  backdrop-filter: blur(12px);
  transition: all .3s ease;
}
.mapSearchBtn:hover{
  background: rgba(56, 189, 248, 0.15);
  border-color: rgba(56, 189, 248, 0.4);
  transform: scale(1.05);
}
.mapSearchPanel{
  width: min(360px, calc(100vw - 100px));
  border: 1px solid var(--line);
  border-radius: 16px;
  background: rgba(16, 24, 40, 0.9);
  backdrop-filter: blur(20px);
  overflow:hidden;
  box-shadow: var(--shadow-frost);
  animation: slideInLeft .3s ease-out;
}
.mapSearchPanel input{
  width:100%;
  border:0;
  outline:none;
  padding: 14px 16px;
  font-size:14px;
  color: var(--text);
  background: transparent;
  font-family: inherit;
}
.mapSearchPanel input::placeholder{ color: var(--text-dim); }
.mapSearchResults{
  max-height: 280px;
  overflow:auto;
  border-top: 1px solid var(--line);
}
.mapSearchItem{
  padding: 12px 16px;
  cursor:pointer;
  border-top: 1px solid rgba(30, 58, 95, 0.5);
  transition: all .2s ease;
}
.mapSearchItem:first-child{ border-top:none; }
.mapSearchItem:hover{ background: rgba(56, 189, 248, 0.1); }
.mapSearchItem b{ display:block; font-size:13px; color: var(--text); font-weight:600; }
.mapSearchItem span{ display:block; margin-top:4px; font-size:12px; color: var(--text-muted); }
.mapSearch.collapsed .mapSearchPanel{ display:none; }

/* ===== INFO CARD ===== */
#infoCard{
  grid-column:2; grid-row:1;
  padding:0;
  display:flex;
  flex-direction:column;
  animation: fadeInUp .6s ease-out .1s backwards;
}
@media (max-width: 1100px){
  #infoCard{ grid-column:1; grid-row:2; height:auto; }
}

.infoHero{
  position:relative;
  height: 130px;
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg) 100%);
  overflow:hidden;
  border-bottom: 1px solid var(--line);
  flex: 0 0 auto;
}
.infoHero .bg{
  position:absolute;
  inset:0;
  background-size: cover;
  background-position:center;
  filter: blur(8px) brightness(.7);
  transform: scale(1.1);
  opacity: .8;
  transition: all .6s ease;
}
.infoHero .overlay{
  position:absolute;
  inset:0;
  background: linear-gradient(to bottom, rgba(8, 13, 22, 0.2) 0%, rgba(8, 13, 22, 0.9) 100%);
}
.infoHeroContent{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  padding: 16px 20px;
  z-index:2;
}
.infoHeroTopRow{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; }
.infoHeroTitle{
  margin:0;
  font-size: 18px;
  color: var(--snow);
  text-shadow: 0 4px 20px rgba(0,0,0,.5);
  letter-spacing: .5px;
}
.infoHeroSub{ margin-top: 4px; color: rgba(234,244,255,.7); font-size: 13px; text-shadow: 0 4px 20px rgba(0,0,0,.5); }
.infoBody{ padding: 16px 20px; overflow:auto; flex: 1 1 auto; }

#datePick{
  background: rgba(16, 24, 40, 0.6);
  border: 1px solid var(--line);
  color: var(--text);
  padding: 8px 12px;
  border-radius: 12px;
  outline:none;
  font-family: inherit;
  cursor:pointer;
  transition: all .3s ease;
}
#datePick:hover, #datePick:focus{
  border-color: var(--ice);
  background: rgba(56, 189, 248, 0.1);
}

/* ===== DAILY STRIP ===== */
.dailyRow{
  display:flex;
  gap:10px;
  overflow-x:auto;
  padding: 8px 4px;
  margin-top: 12px;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
}
.dayCard{
  flex: 0 0 auto;
  width: 88px;
  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 10px 8px;
  background: rgba(16, 24, 40, 0.5);
  cursor:pointer;
  user-select:none;
  text-align:center;
  scroll-snap-align:start;
  transition: all .3s ease;
}
.dayCard:hover{ background: rgba(30, 58, 95, 0.4); border-color: var(--line-light); transform: translateY(-3px); }
.dayCard.active{ border-color: rgba(56,189,248,.5); background: rgba(56,189,248,.12); box-shadow: 0 0 20px rgba(56,189,248,.2); }
.dayName{ font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; }
.dayEmoji{ font-size: 22px; margin-top: 6px; filter: drop-shadow(0 2px 4px rgba(0,0,0,.3)); }
.dayTemps{ font-size: 11px; margin-top: 6px; color: var(--text-muted); }
.dayTemps b{ font-size: 13px; color: var(--text); }

/* ===== METRIC BUTTONS ===== */
.seg{ display:flex; gap: 6px; margin-top: 12px; }
.seg button{
  flex:1;
  background: rgba(16, 24, 40, 0.5);
  border: 1px solid var(--line);
  color: var(--text-muted);
  padding: 8px 10px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 11px;
  cursor:pointer;
  transition: all .3s ease;
  font-family: inherit;
}
.seg button:hover{ background: rgba(30, 58, 95, 0.4); border-color: var(--line-light); }
.seg button.active{
  background: rgba(56,189,248,.15);
  border-color: rgba(56,189,248,.4);
  color: var(--ice);
  box-shadow: 0 0 15px rgba(56,189,248,.2);
}

/* ===== HOURLY ===== */
.hourlyWrap{ margin-top: 16px; border-top: 1px solid var(--line); padding-top: 16px; animation: fadeIn .4s ease-out; }
.hourlyChart{
  width:100%; height: 80px;
  border: 1px solid var(--line);
  border-radius: 14px;
  background: rgba(16, 24, 40, 0.4);
  overflow:hidden;
  margin-top: 12px;
}
.hourlyRow{ margin-top: 12px; display:flex; gap: 10px; overflow-x:auto; padding: 8px 4px; scroll-snap-type:x mandatory; -webkit-overflow-scrolling: touch; }
.hourCard{
  flex:0 0 auto;
  width: 100px;
  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 12px;
  background: rgba(16, 24, 40, 0.5);
  scroll-snap-align:start;
  transition: all .3s ease;
}
.hourCard:hover{ background: rgba(30, 58, 95, 0.4); border-color: var(--line-light); transform: translateY(-2px); }
.hourTop{ display:flex; justify-content:space-between; align-items:center; gap:6px; }
.hourTime{ font-size: 11px; color: var(--text-muted); font-weight: 600; }
.hourEmoji{ font-size: 18px; }
.hourBig{ font-size: 20px; font-weight: 800; margin-top: 8px; color: var(--text); }
.hourMeta{ font-size: 11px; color: var(--text-muted); margin-top: 4px; line-height: 1.3; }

/* ===== OUTFIT CARD ===== */
#outfitCard{ grid-column: 1 / 3; grid-row: 2; animation: fadeInUp .6s ease-out .2s backwards; }
@media (max-width: 1100px){ #outfitCard{ grid-column:1; grid-row:3; } }

.outfitGrid{ margin-top: 16px; }
.avatarBox{
  border: 1px dashed var(--line);
  border-radius: 20px;
  padding: 20px;
  background: rgba(255,255,255,0.01);
}
.avatarLayout{
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  display:grid;
  grid-template-columns: minmax(340px, 1fr) 380px;
  gap: 24px;
  align-items:start;
}
@media (max-width: 900px){
  .avatarLayout{ grid-template-columns: 1fr; justify-items:center; }
}
.avatarRow{
  width:100%;
  max-width: 780px;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  gap: 16px;
}
@media (max-width: 640px){
  .avatarRow{ flex-direction:column; align-items:center; }
}
@media (max-width: 640px){
  :root{ --avatarStageScale: 0.4; }
}

.layerTabs{ display:flex; flex-direction:column; gap: 10px; padding-top: 8px; }
@media (max-width: 640px){ .layerTabs{ flex-direction:row; padding-top: 0; } }
.layerTabs button{
  width: 80px;
  padding: 12px 14px;
  font-size: 11px;
  font-weight: 700;
  border-radius: 14px;
  background: rgba(16, 24, 40, 0.6);
  border: 1px solid var(--line);
  color: var(--text-muted);
  cursor:pointer;
  transition: all .3s ease;
  font-family: inherit;
  text-transform: uppercase;
  letter-spacing: .5px;
}
.layerTabs button:hover{ background: rgba(30, 58, 95, 0.4); border-color: var(--line-light); }
.layerTabs button.active{
  background: rgba(56, 189, 248, 0.15);
  border-color: rgba(56, 189, 248, 0.4);
  color: var(--ice);
  box-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
}

.avatarStage{
  position: relative;
  width: calc(715px * var(--avatarStageScale, 1));
  max-width: 100%;
  aspect-ratio: 715 / 1138;
  border-radius: 16px;
  overflow:hidden;
  background: radial-gradient(circle at 30% 10%, rgba(56, 189, 248, 0.08) 0%, rgba(139, 92, 246, 0.04) 50%, transparent 100%);
}
.avatarCanvas{
  position:absolute; inset:0;
  width: 715px; height: 1138px;
  transform-origin: 0 0;
  pointer-events:none;
}
.avatarCanvas img{
  position:absolute;
  width:auto; height:auto;
  pointer-events:none;
  transition: filter .4s ease;
  user-select:none;
}
.avatarCanvas img.tinted{
  filter: drop-shadow(0 0 15px rgba(74, 222, 128, 0.8)) drop-shadow(0 0 6px rgba(74, 222, 128, 0.5));
}

.checkCanvas{
  position:absolute; inset:0;
  width:715px; height:1138px;
  transform-origin: 0 0;
  pointer-events:none;
  z-index: 120;
}
.checkPin{
  position:absolute;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 8px;
  pointer-events:auto;
  cursor:pointer;
  transition: transform .3s ease;
  user-select:none;
}
.checkPin:hover{ transform: scale(1.1); }
.checkPin.side-left{ transform: translateX(-100%); }
.checkPin.side-right{ transform: translateX(0%); }
.checkPin.side-left:hover{ transform: translateX(-100%) scale(1.1); }
.checkPin.side-right:hover{ transform: translateX(0%) scale(1.1); }

.checkTitle{
  font-size: 10px;
  color: var(--text);
  background: rgba(16, 24, 40, 0.8);
  border: 1px solid var(--line);
  padding: 4px 10px;
  border-radius: 999px;
  white-space:nowrap;
  backdrop-filter: blur(8px);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: .5px;
}
.checkPin input[type="checkbox"]{
  width: 20px; height: 20px;
  cursor:pointer;
  accent-color: var(--green-glow);
}

.controlsWrap{
  width: 380px;
  max-width: 100%;
  border: 1px solid var(--line);
  border-radius: 20px;
  padding: 20px;
  background: rgba(16, 24, 40, 0.6);
  backdrop-filter: blur(12px);
}
.controlsHeader{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom: 16px; }
.controlsHeaderTitle{ font-size: 12px; color: var(--snow); text-shadow: 0 0 20px rgba(240,249,255,.3); font-weight: 800; }
.control{ margin-top: 16px; }
.control label{ display:flex; justify-content:space-between; align-items:center; font-size: 13px; color: var(--text-muted); }
input[type="range"]{
  width:100%;
  margin-top: 10px;
  height: 6px;
  border-radius: 3px;
  background: var(--line);
  -webkit-appearance:none;
  cursor:pointer;
      font-family: 'Press Start 2P', monospace;
    }
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--ice);
  box-shadow: 0 0 15px rgba(56,189,248,.5);
  transition: all .3s ease;
}
input[type="range"]::-webkit-slider-thumb:hover{
  transform: scale(1.2);
  box-shadow: 0 0 25px rgba(56,189,248,.7);
}
.kpi{ display:flex; gap: 10px; flex-wrap:wrap; margin-top: 16px; }

details.setBox{
  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 14px;
  background: rgba(16, 24, 40, 0.4);
  margin-top: 12px;
  transition: all .3s ease;
}
details.setBox:hover{ border-color: var(--line-light); }
details.setBox[open]{ background: rgba(30, 58, 95, 0.2); }
details.setBox > summary{
  cursor:pointer;
  user-select:none;
  font-weight: 700;
  font-size: 12px;
  color: var(--text);
  list-style:none;
  outline:none;
  display:flex;
  align-items:center;
  gap: 10px;
}
details.setBox > summary::-webkit-details-marker{ display:none; }
details.setBox > summary::before{
  content:"‚ñ∏";
  color: var(--ice);
  font-size: 12px;
  transition: transform .3s ease;
}
details.setBox[open] > summary::before{ transform: rotate(90deg); }

.setList{ margin-top: 14px; }
.setItem{
  padding: 12px;
  border-top: 1px solid rgba(30, 58, 95, 0.5);
  transition: all .3s ease;
}
.setItem:first-child{ border-top:none; }
.setItem:hover{ background: rgba(30, 58, 95, 0.3); border-radius: 10px; }
.setItemTop{ display:flex; justify-content:space-between; gap:12px; align-items:baseline; }
.setItemTop b{ color: var(--text); font-size: 13px; }
.setFile{ color: var(--text-dim); font-size: 11px; font-family: monospace; }
.setDesc{ margin-top: 6px; color: var(--text-muted); font-size: 12px; line-height: 1.4; }

.setItem.checked{
  background: rgba(74, 222, 128, 0.08);
  border-radius: 12px;
  border-left: 3px solid var(--green-glow);
}
.setItem.checked b{ color: rgba(134,239,172,.98); }
.setItem.checked .setFile{ color: rgba(134,239,172,.7); }
.setItem.checked .setDesc{ color: rgba(187,247,208,.85); }

/* ===== LIST CARD ===== */
#listCard{ grid-column: 1 / 3; grid-row: 3; animation: fadeInUp .6s ease-out .3s backwards; overflow:visible; }
@media (max-width: 1100px){ #listCard{ grid-column:1; grid-row:4; } }

.item{
  display:grid;
  grid-template-columns: 100px 1fr 130px;
  gap: 16px;
  padding: 16px;
  border: 1px solid var(--line);
  border-radius: 16px;
  margin-top: 12px;
  align-items:center;
  transition: all .3s ease;
  background: rgba(16, 24, 40, 0.4);
}
.item:hover{
  border-color: var(--line-light);
  background: rgba(30, 58, 95, 0.3);
  transform: translateX(4px);
}
@media (max-width: 640px){
  .item{ grid-template-columns: 1fr; text-align:center; }
  .thumb{ margin: 0 auto; }
}
.thumb{
  width: 100px;
  height: 80px;
  border-radius: 12px;
  border: 1px solid var(--line);
  background: rgba(56, 189, 248, 0.05);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 28px;
}
.item h4{ margin:0 0 6px 0; font-size: 14px; color: var(--text); font-weight: 600; }
.item a{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap: 8px;
  padding: 12px 20px;
  border-radius: 14px;
  background: rgba(56, 189, 248, 0.15);
  border: 1px solid rgba(56, 189, 248, 0.35);
  color: var(--ice);
  text-decoration:none;
  font-weight: 700;
  font-size: 13px;
  transition: all .3s ease;
}
.item a:hover{
  background: rgba(56, 189, 248, 0.25);
  border-color: var(--ice);
  transform: translateY(-2px);
  box-shadow: 0 0 20px rgba(56, 189, 248, 0.3);
}


/* ===== CTA ===== */
#ctaCard{
  grid-column: 1 / 3;
  grid-row: 3;
  text-align: center;
  animation: fadeInUp .6s ease-out .35s backwards;
}
@media (max-width: 1100px){
  #ctaCard{ grid-column:1; grid-row:4; }
}
.ctaRow{ margin-top: 16px; display:flex; justify-content:center; }
.ctaBtn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap: 10px;
  padding: 16px 22px;
  border-radius: 16px;
  background: rgba(56, 189, 248, 0.18);
  border: 1px solid rgba(56, 189, 248, 0.45);
  color: var(--snow);
  text-decoration:none;
  font-size: 12px;
  line-height: 1.2;
  box-shadow: 0 0 30px rgba(56, 189, 248, 0.14);
  transition: all .25s ease;
}
.ctaBtn:hover{
  transform: translateY(-2px);
  background: rgba(56, 189, 248, 0.26);
  border-color: rgba(56, 189, 248, 0.7);
  box-shadow: 0 0 40px rgba(56, 189, 248, 0.22);
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar{ width: 8px; height: 8px; }
::-webkit-scrollbar-track{ background: var(--bg-secondary); border-radius: 4px; }
::-webkit-scrollbar-thumb{ background: var(--line); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover{ background: var(--ice); }
  
    /* ===== FOOTER ===== */
    footer.siteFooter{
      margin-top: 18px;
      padding: 28px 16px;
      border-top: 1px solid var(--line);
      background: rgba(0,0,0,0.15);
    }
    .footerInner{
      max-width: 1600px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap: 18px;
      align-items:start;
    }
    .footerBrand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
    }
    .footerDesc{
      margin-top:10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
      max-width: 520px;
    }
    .footerCol h4{
      margin: 0 0 10px 0;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(234,240,255,0.92);
      font-family: 'Press Start 2P', monospace;
    }
    .footerLinks{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .footerLinks a{
      color: rgba(159,176,208,0.95);
      text-decoration:none;
      font-size: 13px;
      width:max-content;
      border-bottom: 1px solid transparent;
      padding-bottom:2px;
    }
    .footerLinks a:hover{
      color: #eaf0ff;
      border-bottom-color: rgba(42,109,255,0.55);
    }
    .footerBottom{
      max-width: 1600px;
      margin: 18px auto 0 auto;
      padding-top: 14px;
      border-top: 1px solid rgba(36,48,74,0.7);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      color: rgba(159,176,208,0.9);
      font-size: 12px;
    }
    @media (max-width: 900px){
      .footerInner{ grid-template-columns: 1fr; }
    }

  
    /* ===== OUTFIT LAYOUT EDITOR (DEV TOOL) ===== */
    .layoutEditor{
      margin-top: 14px;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: rgba(16, 24, 40, 0.38);
    }
    .layoutEditor summary{
      cursor:pointer;
      user-select:none;
      font-weight:800;
      font-size: 12px;
      color: var(--text);
      list-style:none;
      outline:none;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .layoutEditor summary::-webkit-details-marker{ display:none; }
    .layoutEditor summary::before{ content:"üõ†Ô∏è"; opacity:.9; }
    .layoutGrid{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items:end;
    }
    .layoutGrid .full{ grid-column: 1 / -1; }
    .layoutGrid label{
      display:block;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .layoutGrid select,
    .layoutGrid input[type="number"]{
      width:100%;
      border: 1px solid var(--line);
      background: rgba(16, 24, 40, 0.65);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      outline:none;
      font-family: inherit;
      transition: all .25s ease;
    }
    .layoutGrid select:focus,
    .layoutGrid input[type="number"]:focus{
      border-color: rgba(56, 189, 248, 0.55);
      box-shadow: 0 0 0 3px rgba(56,189,248,.08);
    }
    .layoutBtns{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .layoutBtns button{
      border: 1px solid var(--line);
      background: rgba(16, 24, 40, 0.55);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 800;
      cursor:pointer;
      transition: all .25s ease;
      font-family: inherit;
    }
    .layoutBtns button:hover{
      background: rgba(30, 58, 95, 0.35);
      border-color: var(--line-light);
      transform: translateY(-1px);
    }
    .layoutBtns button.primary{
      background: rgba(56, 189, 248, 0.15);
      border-color: rgba(56, 189, 248, 0.35);
      color: var(--ice);
    }
    .layoutHint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.45;
    }
    .editMode .avatarCanvas{ pointer-events:auto; }
    .editMode .avatarCanvas img{ pointer-events:auto; cursor: grab; }
    .editMode .avatarCanvas img.dragging{ cursor: grabbing; }


    /* ===== LAYOUT EDITOR (DEV) ===== */
    .layoutEditBtn{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 10050;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: 0.5px;
      color: var(--text);
      background: rgba(16, 24, 40, 0.82);
      backdrop-filter: blur(12px);
      cursor: pointer;
      box-shadow: var(--shadow-frost);
      transition: all .25s ease;
    }
    .layoutEditBtn:hover{
      transform: translateY(-2px);
      border-color: rgba(56, 189, 248, 0.45);
      box-shadow: 0 0 22px rgba(56, 189, 248, 0.22);
    }

    .layoutEditPanel{
      position: fixed;
      right: 18px;
      bottom: 64px;
      width: min(420px, calc(100vw - 36px));
      border: 1px solid var(--line);
      border-radius: 18px;
      background: rgba(16, 24, 40, 0.92);
      backdrop-filter: blur(18px);
      box-shadow: var(--shadow-frost);
      z-index: 10060;
      display: none;
      overflow: hidden;
      animation: fadeInUp .25s ease-out;
    }
    .layoutEditPanel.open{ display:block; }

    .layoutEditHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(30, 58, 95, 0.55);
      background: rgba(8, 13, 22, 0.35);
    }
    .layoutEditTitle{
      font-size: 12px;
      font-weight: 900;
      color: var(--snow);
      letter-spacing: 0.6px;
      text-transform: uppercase;
    }
    .layoutEditClose{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(16, 24, 40, 0.55);
      color: var(--text);
      cursor: pointer;
      transition: all .2s ease;
    }
    .layoutEditClose:hover{
      border-color: rgba(56, 189, 248, 0.45);
      background: rgba(56, 189, 248, 0.12);
    }

    .layoutEditBody{ padding: 14px; }
    .layoutEditRow{ display:flex; flex-direction:column; gap:8px; }
    .layoutEditLabel{ font-size: 12px; color: var(--text-muted); font-weight: 700; }
    .layoutEditSelect, .layoutEditInput{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(12, 18, 33, 0.55);
      color: var(--text);
      outline: none;
      font-family: inherit;
    }
    .layoutEditSelect:focus, .layoutEditInput:focus{
      border-color: rgba(56, 189, 248, 0.55);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.12);
    }
    .layoutEditGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .layoutEditField{ display:flex; flex-direction:column; gap:8px; }

    .layoutEditHint{
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.45;
    }
    .layoutEditActions{
      display:flex;
      gap: 10px;
      margin-top: 12px;
    }
    .layoutEditActionBtn{
      flex:1;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(56, 189, 248, 0.35);
      background: rgba(56, 189, 248, 0.14);
      color: var(--ice);
      font-weight: 900;
      cursor: pointer;
      transition: all .2s ease;
    }
    .layoutEditActionBtn:hover{
      background: rgba(56, 189, 248, 0.22);
      border-color: rgba(56, 189, 248, 0.6);
      transform: translateY(-1px);
    }
    .layoutEditActionBtn.ghost{
      border-color: var(--line);
      background: rgba(16, 24, 40, 0.5);
      color: var(--text);
    }
    .layoutEditActionBtn.ghost:hover{
      border-color: var(--line-light);
      background: rgba(30, 58, 95, 0.3);
      transform: translateY(-1px);
    }

</style>
</head>

<body>
  <div class="snowfall" id="snowfall" aria-hidden="true"></div>
 <header>
  <div class="headerLeft">
    <a class="logo" href="index.html" style="text-decoration:none;"><span class="logo-icon">üèîÔ∏è</span><span class="font-pixel" style="font-weight:900;">RIDEKIT.FR</span></a>
    <div class="badge">MVP ‚Ä¢ one page ‚Ä¢ Leaflet</div>
  </div>

  <nav class="headerNav" aria-label="Pages">
    <a href="index.html" data-page="home">Map</a>
    <a href="gear.html" data-page="gear">Gear finder</a>
  </nav>

  <div class="headerRight">
    <div class="langSwitch" role="group" aria-label="Language selector">
      <span class="langIcon" aria-hidden="true">üåê</span>
      <button class="langBtn active" type="button" data-lang="en" aria-label="English">EN</button>
      <button class="langBtn" type="button" data-lang="fr" aria-label="Fran√ßais">FR</button>
      <button class="langBtn" type="button" data-lang="ru" aria-label="–†—É—Å—Å–∫–∏–π">RU</button>
      <button class="langBtn" type="button" data-lang="de" aria-label="Deutsch">DE</button>
    </div>
  </div>
</header>

  <div class="wrap">
    <!-- MAP -->
    <div class="card" id="mapCard">
      <div id="map"></div>

      <!-- MAP SEARCH (toggle) -->
      <div class="mapSearch collapsed" id="mapSearch" aria-label="Search mountains">
        <button class="mapSearchBtn" id="mapSearchBtn" type="button" title="Search">üîé</button>
        <div class="mapSearchPanel" id="mapSearchPanel">
          <input id="mapSearchInput" type="text" placeholder="Search mountain‚Ä¶" autocomplete="off">
          <div class="mapSearchResults" id="mapSearchResults"></div>
        </div>
      </div>
    </div>

    <!-- INFO -->
    <div class="card" id="infoCard">
      <div class="infoHero">
        <div class="bg" id="infoBg"></div>
        <div class="overlay"></div>

        <div class="infoHeroContent">
          <div class="infoHeroTopRow">
            <div>
              <h2 class="infoHeroTitle" id="infoTitle">Pick a mountain</h2>
              <div class="infoHeroSub" id="infoSub">Click a marker on the map</div>
            </div>
            <div class="row" style="margin-top:0;">
              <div class="pill" id="pillBase" style="display:none;">Base: ‚Äî</div>
              <div class="pill" id="pillTop" style="display:none;">Top: ‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <div class="infoBody" id="panelBody">
        <div class="muted">Forecast (Open-Meteo)</div>
        <div class="hint" style="margin-top:10px;">Pick a mountain to load forecast.</div>
      </div>
    </div>

    <!-- OUTFIT -->
    <div class="card" id="outfitCard">
      <h2 class="title font-pixel">OUTFIT SELECTION HELPER</h2>
      <div class="muted">Prototype: depending on weather (temperature, wind, snowfall), we recommend an approximate outfit setup. Use it as a starting point ‚Äî always double‚Äëcheck the forecast and your own comfort.</div>

      <div class="outfitGrid">
        <div class="avatarBox">

          <div class="avatarLayout">

          <div class="avatarRow">
            <!-- LEFT TABS -->
            <div class="layerTabs" aria-label="Outfit category">
              <button id="tabBase" class="active" type="button">Base</button>
              <button id="tabShell" type="button">Shell</button>
            </div>

            <!-- AVATAR -->
            <div class="avatarStage" id="avatarStage">
              <div class="avatarCanvas" id="avatarCanvas">
                <!-- Layer order (CSS z-index controls the real stacking):
                     socks -> pants -> head (under tops) -> gloves (under tops) -> base/hood -> shell jacket -->
                <img id="layerSocks" alt="Socks">
                <img id="layerPants" alt="Pants">
                <img id="layerHead" alt="Balaclava / head (UNDER all tops)">
                <img id="layerGloves" alt="Gloves (UNDER tops)">
                <img id="layerBaseTop" alt="Base layer top (Base only)">
                <img id="layerHood" alt="Sweater (Base only)">
                <img id="layerShell" alt="Shell jacket (Shell only)">
              </div>
              <div class="checkCanvas" id="checkCanvas"></div>

            </div>
          </div>

          <!-- CONTROLS -->
          <div class="controlsWrap" id="controlsWrap">
            <div class="controlsHeader">
              <div>
                <div class="controlsHeaderTitle">Setup</div>
                <div class="muted" style="margin-top:4px;">Temperature</div>
              </div>
              <div class="pill" id="levelVal">Level: Cold</div>
            </div>
<div class="control">
              <label>
                <span>Temperature</span>
                <span class="pill" id="tempVal">-8¬∞C</span>
              </label>
              <input id="tempRange" type="range" min="-25" max="5" step="1" value="-8">
            </div>

            <div class="kpi">
<div class="pill" id="modeVal">Mode: Base</div>
            </div>
<div class="divider"></div>

<div class="hint" id="outfitHeader">
  <div><span class="muted">Based on:</span> <b id="outfitLoc">‚Äî</b></div>
  <div style="margin-top:4px;">
    <span class="muted">Day:</span> <b id="outfitDay">‚Äî</b>
    <span class="muted"> ‚Ä¢ Avg temp:</span> <b id="outfitTemp">‚Äî</b>
  </div>
  <div class="muted" style="margin-top:6px;">Recommended now: <b id="outfitModeText">‚Äî</b></div>
</div>

<details class="setBox" open>
  <summary>Base set (layering)</summary>
  <div class="setList" id="setBase">‚Äî</div>
</details>

<details class="setBox">
  <summary>Shell set (wind / snow)</summary>
  <div class="setList" id="setShell">‚Äî</div>
</details>

<div class="hint" style="margin-top:12px;">
              Tip: pick a mountain + day to auto-set temperature from forecast.
            </div>
          </div>

          </div>

        </div>
      </div>
    </div>


    <!-- CTA -->
    <div class="card" id="ctaCard">
      <h2 class="title font-pixel">WANT TO EQUIP FOR YOUR TRIP?</h2>
      <div class="muted">Jump into the gear finder to get sizing hints + recommended items for your trip.</div>
      <div class="ctaRow">
        <a class="ctaBtn font-pixel" href="gear.html">OPEN GEAR FINDER ‚Üí</a>
      </div>
    </div>

    <!-- LIST -->
        <!-- Recommended gear moved to gear.html -->
  </div>


  <footer class="siteFooter" role="contentinfo">
    <div class="footerInner">
      <div>
        <div class="footerBrand">
          <span style="filter: drop-shadow(0 0 10px rgba(42,109,255,0.35));">üèîÔ∏è</span>
          <span>RIDEKIT.FR</span>
        </div>
        <div class="footerDesc">
          A simple helper for choosing ski / snowboard gear based on weather and conditions.
          Always double‚Äëcheck real forecasts and avalanche bulletins before going to the mountains.
        </div>
      </div>

      <div class="footerCol">
        <h4>Navigation</h4>
        <div class="footerLinks">
          <a href="index.html">Resort map</a>
          <a href="gear.html">Gear finder</a>
        </div>
      </div>

      <div class="footerCol">
        <h4>Data & Sources</h4>
        <div class="footerLinks">
          <a href="https://open-meteo.com/" target="_blank" rel="noopener">Forecast: Open‚ÄëMeteo API</a>
          <a href="https://www.openstreetmap.org/" target="_blank" rel="noopener">Map: OpenStreetMap</a>
          <a href="privacy.html">Privacy policy</a>
        </div>
      </div>
    </div>

    <div class="footerBottom">
      <div>Made with ‚ù§Ô∏è for snowy adventures</div>
      <div>¬© 2026 RIDEKIT. All rights reserved.</div>
    </div>
  </footer>


<script>
// ===== SNOWFALL EFFECT (visual only) =====
function createSnowfall() {
  const container = document.getElementById('snowfall');
  if (!container) return;
  container.innerHTML = "";
  const count = 60;

  for (let i = 0; i < count; i++) {
    const flake = document.createElement('div');
    flake.className = 'snowflake';
    flake.style.left = Math.random() * 100 + '%';
    const size = (2 + Math.random() * 4);
    flake.style.width = size + 'px';
    flake.style.height = size + 'px';
    flake.style.animationDuration = (8 + Math.random() * 12) + 's';
    flake.style.animationDelay = (Math.random() * 10) + 's';
    flake.style.opacity = (0.25 + Math.random() * 0.65).toFixed(2);
    container.appendChild(flake);
  }
}
createSnowfall();

const PLACEHOLDER_MOUNTAIN_IMAGE = "./assets/mountains/zaplatka.jpg";

// ========= LOAD LOCATIONS =========
  async function loadLocations() {
    const res = await fetch("./data/locations.geojson");
    if (!res.ok) throw new Error("Failed to load GeoJSON: " + res.status);
    const geo = await res.json();

    return geo.features.map(f => {
      const p = f.properties;
      const [lon, lat] = f.geometry.coordinates;
      return {
        id: p.id,
        name: p.name,
        region: p.region,
        country: p.country,
        image: (p.image && String(p.image).trim()) ? p.image : PLACEHOLDER_MOUNTAIN_IMAGE,
        lat, lon,
        base_m: p.base_m,
        top_m: p.top_m,
        tempProfile: { mild: p.mild, normal: p.normal, cold: p.cold }
      };
    });
  }

  // ========= MAP INIT =========
  const map = L.map("map", { zoomControl:true }).setView([45.5, 6.6], 8);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  const markersLayer = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true });
  map.addLayer(markersLayer);

  setTimeout(() => map.invalidateSize(), 250);

  // ========= WEATHER (Open-Meteo) =========
  const weatherCache = new Map();
  const WEATHER_TTL_MS = 15 * 60 * 1000;
  function cacheKey(lat, lon){ return `${lat.toFixed(3)},${lon.toFixed(3)}`; }

  function weatherCodeToText(code) {
    const m = {
      0:"Clear",1:"Mostly clear",2:"Partly cloudy",3:"Overcast",45:"Fog",48:"Rime fog",
      51:"Light drizzle",53:"Drizzle",55:"Heavy drizzle",
      61:"Light rain",63:"Rain",65:"Heavy rain",
      71:"Light snow",73:"Snow",75:"Heavy snow",
      80:"Rain showers",85:"Snow showers",
      95:"Thunderstorm"
    };
    return m[code] ?? `Weather code ${code}`;
  }

  function weatherCodeToEmoji(code){
    if (code === 0) return "‚òÄÔ∏è";
    if (code === 1) return "üå§Ô∏è";
    if (code === 2) return "‚õÖ";
    if (code === 3) return "‚òÅÔ∏è";
    if (code === 45 || code === 48) return "üå´Ô∏è";
    if (code >= 51 && code <= 55) return "üå¶Ô∏è";
    if (code >= 61 && code <= 65) return "üåßÔ∏è";
    if (code === 80) return "üå¶Ô∏è";
    if (code === 95) return "‚õàÔ∏è";
    if (code === 71 || code === 73 || code === 75) return "‚ùÑÔ∏è";
    if (code === 85) return "üå®Ô∏è";
    return "üå°Ô∏è";
  }

  async function getWeather(lat, lon){
    const key = cacheKey(lat, lon);
    const cached = weatherCache.get(key);
    if (cached && (Date.now() - cached.ts) < WEATHER_TTL_MS) return cached.data;

    const url =
      `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${encodeURIComponent(lat)}` +
      `&longitude=${encodeURIComponent(lon)}` +
      `&current_weather=true` +
      `&hourly=temperature_2m,precipitation,snowfall,windspeed_10m,weathercode` +
      `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,snowfall_sum,windspeed_10m_max,weathercode` +
      `&forecast_days=16` +
      `&timezone=auto`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`Weather API error: ${res.status}`);
    const data = await res.json();
    weatherCache.set(key, { ts: Date.now(), data });
    return data;
  }

  function pickDaily(daily, idx){
    return {
      date: daily.time?.[idx],
      tmin: daily.temperature_2m_min?.[idx],
      tmax: daily.temperature_2m_max?.[idx],
      precip: daily.precipitation_sum?.[idx],
      snow: daily.snowfall_sum?.[idx],
      windMax: daily.windspeed_10m_max?.[idx],
      code: daily.weathercode?.[idx],
    };
  }

  function pickDailyByDate(daily, dateStr){
    const times = daily?.time || [];
    const idx = times.indexOf(dateStr);
    if (idx === -1) return null;
    return pickDaily(daily, idx);
  }

  function pickHourlyForDate(hourly, dateStr){
    const times = hourly?.time || [];
    const out = [];
    for (let i=0;i<times.length;i++){
      if (times[i].startsWith(dateStr)){
        out.push({
          time: times[i],
          temp: hourly.temperature_2m?.[i],
          precip: hourly.precipitation?.[i],
          snow: hourly.snowfall?.[i],
          wind: hourly.windspeed_10m?.[i],
          code: hourly.weathercode?.[i],
        });
      }
    }
    return out;
  }

  function svgSparkline(values, w=900, h=76, pad=10, unitText=""){
    const nums = values.filter(v => typeof v === "number" && isFinite(v));
    if (!nums.length) return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="100%"></svg>`;

    const minV = Math.min(...nums);
    const maxV = Math.max(...nums);
    const range = (maxV - minV) || 1;

    const stepX = (w - pad*2) / Math.max(values.length - 1, 1);

    const pts = values.map((v, idx) => {
      const safe = (typeof v === "number" && isFinite(v)) ? v : minV;
      const x = pad + idx * stepX;
      const y = pad + (h - pad*2) * (1 - ((safe - minV) / range));
      return `${x.toFixed(1)},${y.toFixed(1)}`;
    }).join(" ");

    const minLabel = `${Math.round(minV)}${unitText}`;
    const maxLabel = `${Math.round(maxV)}${unitText}`;

    return `
      <svg viewBox="0 0 ${w} ${h}" width="100%" height="100%" preserveAspectRatio="none">
        <polyline points="${pts}" fill="none" stroke="rgba(234,240,255,0.85)" stroke-width="2" />
        <text x="${pad}" y="${pad+14}" fill="rgba(159,176,208,0.9)" font-size="12">${minLabel}</text>
        <text x="${w-pad-50}" y="${pad+14}" fill="rgba(159,176,208,0.9)" font-size="12">${maxLabel}</text>
      </svg>
    `;
  }

  function metricSeries(hours, metric){
    if (metric === "precip") return hours.map(h => h.precip);
    if (metric === "wind") return hours.map(h => h.wind);
    return hours.map(h => h.temp);
  }
  function metricUnit(metric){
    if (metric === "precip") return "mm";
    if (metric === "wind") return "km/h";
    return "¬∞C";
  }

  function renderHourlyForecast(hours){
    const slice = hours.slice(0, 24);
    if (!slice.length){
      return `
        <div class="hourlyWrap">
          <div class="muted">Hourly</div>
          <div class="hint" style="margin-top:8px;">No hourly data for this date.</div>
        </div>
      `;
    }

    const series = metricSeries(slice, state.metric);
    const unit = metricUnit(state.metric);
    const chart = svgSparkline(series, 900, 76, 10, unit === "¬∞C" ? "¬∞" : "");

    const cards = slice.map(h => {
      const hh = h.time.split("T")[1]?.slice(0,5) || "";
      const emoji = weatherCodeToEmoji(h.code);
      const txt = weatherCodeToText(h.code);

      const valTemp = (typeof h.temp === "number") ? `${Math.round(h.temp)}¬∞` : "‚Äî";
      const valPrecip = (typeof h.precip === "number") ? `${h.precip.toFixed(1)}mm` : "‚Äî";
      const valSnow = (typeof h.snow === "number") ? `${h.snow.toFixed(1)}cm` : "‚Äî";
      const valWind = (typeof h.wind === "number") ? `${Math.round(h.wind)}km/h` : "‚Äî";

      let big = valTemp;
      let meta1 = `Wind: ${valWind}`;
      let meta2 = `P: ${valPrecip} ‚Ä¢ S: ${valSnow}`;

      if (state.metric === "precip"){
        big = valPrecip;
        meta1 = `Temp: ${valTemp}`;
        meta2 = `Wind: ${valWind} ‚Ä¢ Snow: ${valSnow}`;
      } else if (state.metric === "wind"){
        big = valWind;
        meta1 = `Temp: ${valTemp}`;
        meta2 = `Precip: ${valPrecip} ‚Ä¢ Snow: ${valSnow}`;
      }

      return `
        <div class="hourCard">
          <div class="hourTop">
            <div class="hourTime">${hh}</div>
            <div class="hourEmoji" title="${txt}">${emoji}</div>
          </div>
          <div class="hourBig">${big}</div>
          <div class="hourMeta">${txt}</div>
          <div class="hourMeta">${meta1}</div>
          <div class="hourMeta">${meta2}</div>
        </div>
      `;
    }).join("");

    return `
      <div class="hourlyWrap">
        <div class="muted">Hourly (24h)</div>

        <div class="hourlyChart">${chart}</div>

        <div class="seg hourlySeg" style="margin-top:10px;">
          <button type="button" data-m="temp" class="${state.metric==="temp"?"active":""}">üå°Ô∏è Temp</button>
          <button type="button" data-m="precip" class="${state.metric==="precip"?"active":""}">üåßÔ∏è Precip</button>
          <button type="button" data-m="wind" class="${state.metric==="wind"?"active":""}">üí® Wind</button>
        </div>

        <div class="hourlyRow">${cards}</div>
      </div>
    `;
  }

  // ========= STATE =========
  const state = {
    tempC: -8,
    date: null,
    metric: "temp",
    outfitMode: "base", // "base" | "shell"

    // Checkbox pins state (what user has checked)
    checks: { base: {}, shell: {} }
  };

  let selectedLocationId = null;
  let LAST_WEATHER_DATA = null;
  let CURRENT_LOC = null;

  function tempLevel(t){
    if (t <= -12) return "Very cold";
    if (t <= -6) return "Cold";
    if (t <= 0) return "Near freezing";
    return "Mild";
  }

  // ========= AVATAR ENGINE (PNG layers) =========
  const AVATAR_BASE_W = 715;
  const AVATAR_BASE_H = 1138;
  const ASSET = (name) => `./assets/outfit/${name}`;

  function updateAvatarScale(){
    const stage = document.getElementById("avatarStage");
    const canvas = document.getElementById("avatarCanvas");
    const checks = document.getElementById("checkCanvas");
    if (!stage || !canvas) return;
    const scale = stage.clientWidth / AVATAR_BASE_W;
    canvas.style.transform = `scale(${scale})`;
    if (checks) checks.style.transform = `scale(${scale})`;
  }
  window.addEventListener("resize", updateAvatarScale);

  function applyLayer(id, cfg){
    const el = document.getElementById(id);
    if (!el) return;

    if (!cfg || !cfg.src){
      el.style.display = "none";
      el.removeAttribute("src");
      return;
    }
    el.src = cfg.src;
    el.style.display = "";

    el.style.left = `${cfg.x ?? 0}px`;
    el.style.top  = `${cfg.y ?? 0}px`;

    const r = cfg.r ?? 0;
    el.style.transform = `rotate(${r}deg)`;
    el.style.transformOrigin = cfg.origin || "50% 20%";
    el.style.zIndex = `${cfg.z ?? 10}`;
  }

  
  // ===== LAYOUT OVERRIDES STORAGE (DEV TOOL) =====
  (function initLayoutOverrides(){
    const KEY = "mml_layout_overrides_v1";
    try{
      const raw = localStorage.getItem(KEY);
      window.LAYOUT_OVERRIDES = raw ? JSON.parse(raw) : {};
    }catch(e){
      window.LAYOUT_OVERRIDES = {};
    }
    window.__SAVE_LAYOUT_OVERRIDES = function(){
      try{ localStorage.setItem(KEY, JSON.stringify(window.LAYOUT_OVERRIDES || {})); }catch(e){}
    };
  })();

// ===== Positions (from your Figma notes) =====
  const POS = {
    head_light:   { src: ASSET("light_head.png"),    x:237,   y:48,     r:0,    z:55, origin:"50% 50%" },
    // head light position was changed because it doesn't correspond to Figma for some reason, so now the standart is x 233, y 48
    base_top:     { src: ASSET("light_base.png"),    x:100,   y:125,    r:0,    z:60, origin:"50% 50%" },

    pants_base:   { src: ASSET("base_pants.png"),    x:132,   y:532,    r:0,    z:20, origin:"50% 50%" },
    pants_medium: { src: ASSET("medium_pants.png"),  x:115,   y:508,    r:0,    z:20, origin:"50% 50%" },

    // Shell pants (windproof)
    pants_shell:  { src: ASSET("heavy_pants.png"), x: -15,  y:410, r:-1.0, z:20, origin:"50% 50%" },
    pants_shell_2: { src: ASSET("heavy_pants_2.png"), x:110, y:515, r:2.45, z:20, origin:"50% 50%" },

    socks_light:  { src: ASSET("light_socks.png"),   x:100,   y:959,    r:0,    z:10, origin:"50% 50%" },
    socks_heavy:  { src: ASSET("heavy_socks.png"),   x:59,    y:983,    r:0,    z:10, origin:"50% 50%" },

    gloves_light: { src: ASSET("light_gloves.png"),  x:155,   y:520,    r:0,    z:50, origin:"50% 50%" },
    gloves_heavy: { src: ASSET("heavy_gloves.png"),  x:138,   y:533,    r:2.94, z:50, origin:"50% 50%" },

    // Shell jacket (always in Shell tab)
    jacket_light:  { src: ASSET("light_jacket.png"),  x:75.16, y:149.61, r:1.3,  z:80, origin:"50% 50%" },
    jacket_medium: { src: ASSET("medium_jacket.png"), x:85.18, y:173.15, r:1.21, z:80, origin:"50% 50%" },
    jacket_heavy:  { src: ASSET("heavy_jacket.png"),  x:85.81, y:150.07, r:0.47, z:80, origin:"50% 50%" },

    // Hood = sweater (Base tab only)
    hood_01: { src: ASSET("heavy_hood_01.png"), x:88,    y:118,    r: 2.23, z:70, origin:"50% 50%" },
    hood_02: { src: ASSET("heavy_hood_2.png"),  x:46,    y:195,    r: 3.0, z:70, origin:"50% 50%" },
    hood_03: { src: ASSET("heavy_hood_3.png"),  x:74.26, y:188.09, r: 1.19, z:70, origin:"50% 50%" },
  };
    // ========= LAYOUT EDITOR (DEV TOOL) =========
    const __POS_ORIGINAL__ = JSON.parse(JSON.stringify(POS));

    function __posKeys__() { return Object.keys(POS || {}); }

    function __openLayoutEditor__(open) {
      const p = document.getElementById("layoutEditPanel");
      if (!p) return;
      p.classList.toggle("open", !!open);
      p.setAttribute("aria-hidden", open ? "false" : "true");
    }

    function __syncEditorFields__(key) {
      const cfg = POS[key];
      if (!cfg) return;
      const x = document.getElementById("layoutEditX");
      const y = document.getElementById("layoutEditY");
      const r = document.getElementById("layoutEditR");
      const z = document.getElementById("layoutEditZ");
      if (x) x.value = cfg.x ?? 0;
      if (y) y.value = cfg.y ?? 0;
      if (r) r.value = cfg.r ?? 0;
      if (z) z.value = cfg.z ?? 10;
    }

    function __applyFromFields__(key) {
      const cfg = POS[key];
      if (!cfg) return;

      const x = parseFloat(document.getElementById("layoutEditX")?.value ?? cfg.x ?? 0);
      const y = parseFloat(document.getElementById("layoutEditY")?.value ?? cfg.y ?? 0);
      const r = parseFloat(document.getElementById("layoutEditR")?.value ?? cfg.r ?? 0);
      const z = parseInt(document.getElementById("layoutEditZ")?.value ?? cfg.z ?? 10, 10);

      cfg.x = isFinite(x) ? x : (cfg.x ?? 0);
      cfg.y = isFinite(y) ? y : (cfg.y ?? 0);
      cfg.r = isFinite(r) ? r : (cfg.r ?? 0);
      cfg.z = isFinite(z) ? z : (cfg.z ?? 10);

      // Re-apply current outfit to see changes immediately
      try { applyOutfit(); updateAvatarScale(); } catch(e) {}
    }

    function __copyPOSJson__() {
      const pretty = JSON.stringify(POS, null, 2);
      navigator.clipboard?.writeText(pretty).then(() => {
        const btn = document.getElementById("layoutEditCopy");
        if (btn) {
          const old = btn.textContent;
          btn.textContent = "Copied!";
          setTimeout(() => btn.textContent = old, 900);
        }
      }).catch(() => {
        alert("Couldn't copy. Your browser blocked clipboard access.");
      });
    }

    function __resetPOS__() {
      // restore original
      __posKeys__().forEach(k => delete POS[k]);
      Object.keys(__POS_ORIGINAL__).forEach(k => POS[k] = JSON.parse(JSON.stringify(__POS_ORIGINAL__[k])));
      const sel = document.getElementById("layoutEditSelect");
      const key = sel?.value || __posKeys__()[0];
      if (key) __syncEditorFields__(key);
      try { applyOutfit(); updateAvatarScale(); } catch(e) {}
    }

    function wireLayoutEditor() {
      const btn = document.getElementById("layoutEditBtn");
      const close = document.getElementById("layoutEditClose");
      const panel = document.getElementById("layoutEditPanel");
      const sel = document.getElementById("layoutEditSelect");

      if (!btn || !panel || !sel) return;

      // populate select
      sel.innerHTML = __posKeys__().map(k => `<option value="${k}">${k}</option>`).join("");

      const initialKey = sel.value || __posKeys__()[0];
      if (initialKey) __syncEditorFields__(initialKey);

      btn.addEventListener("click", () => __openLayoutEditor__(!panel.classList.contains("open")));
      close?.addEventListener("click", () => __openLayoutEditor__(false));

      sel.addEventListener("change", () => __syncEditorFields__(sel.value));

      ["layoutEditX", "layoutEditY", "layoutEditR", "layoutEditZ"].forEach(id => {
        document.getElementById(id)?.addEventListener("input", () => __applyFromFields__(sel.value));
      });

      document.getElementById("layoutEditCopy")?.addEventListener("click", __copyPOSJson__);
      document.getElementById("layoutEditReset")?.addEventListener("click", __resetPOS__);

      // close on ESC
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") __openLayoutEditor__(false);
      });
    }


  // glove overrides when hood variant is used (your notes)
  const GLOVES_OVERRIDE_BY_HOOD = {
    "heavy_hood_01.png": {
      light: { x:155, y:540, r:0 },
      heavy: { x:142, y:506, r:2.94 }
    },
    "heavy_hood_2.png": {
      light: { x:155, y:540, r:0 },
      heavy: { x:139, y:513, r:2.94 }
    },
    "heavy_hood_3.png": {
      light: { x:164, y:539, r:0 },
      heavy: { x:132, y:516, r:2.94 }
    },
  };

    // 
  
  function setGloves(type, hoodFileNameOrNull){
    const base = (type === "heavy") ? POS.gloves_heavy : POS.gloves_light;

    if (hoodFileNameOrNull){
      const o = GLOVES_OVERRIDE_BY_HOOD[hoodFileNameOrNull];
      if (o){
        const adj = (type === "heavy") ? o.heavy : o.light;
        if (adj){
          const cfg = { ...base, x: adj.x, y: adj.y, r: adj.r ?? base.r };
          applyLayer("layerGloves", cfg);
          return cfg;
        }
      }
    }
    applyLayer("layerGloves", base);
    return base;
  }

  // Choose which hood picture to use when hood is enabled
  // ================= Sweater (hood) selection =================
// NOTE: "hood" = sweater / mid-layer top in your project naming.
//
// ‚úÖ THIS IS THE PLACE TO CHANGE HOW SWEATER VARIANTS DEPEND ON TEMPERATURE.
// If you want to force a specific sweater for testing, set HOOD_FORCE_VARIANT
// to: "heavy_hood_01.png" | "heavy_hood_2.png" | "heavy_hood_3.png"
// and refresh.
let HOOD_FORCE_VARIANT = null;

function chooseHoodVariant(tempC){
  // ===== CHANGE HOOD TEMPERATURE THRESHOLDS HERE =====
  // Sweater (hood_01/02/03) changes with temperature.
  // You can tweak these numbers anytime later.
  if (HOOD_FORCE_VARIANT) return HOOD_FORCE_VARIANT;

  if (tempC <= -12) return "heavy_hood_3.png";   // very cold -> warmest sweater
  if (tempC <= -8)  return "heavy_hood_2.png";   // cold
  return "heavy_hood_01.png";                    // slightly cold (-8..-6)
}


// ================= Shell pants (auto) =================
// NOTE: Shell pants are ONLY used in Shell tab.
// We auto-pick between heavy_pants.png and heavy_pants_2.png depending on temperature.
//
// ‚úÖ CHANGE THRESHOLD HERE if you want:
//   temp <= -10  -> heavy_pants_2 (warmer / different cut)
//   else         -> heavy_pants   (lighter shell pants)
function chooseShellPantsCfg(tempC){
  if (tempC <= -10) return POS.pants_shell_2; // heavy_pants_2.png
  return POS.pants_shell;                    // heavy_pants.png
}
// heavy_hood_01.png | heavy_hood_2.png | heavy_hood_3.png

  // ================= Checkbox pins (Base / Shell) =================
  // Pins are positioned in the same 715x1138 coordinate system as the avatar.
  // You can move them by changing x/y below.
  const CHECK_UI = {
    base: [
      { key:"head",   label:"Balaclava",  x:210, y:120, side:"left",  targets:["layerHead"] },
      { key:"top",    label:"Top",        x:560, y:270, side:"right", targets:["layerBaseTop","layerHood"] },
      { key:"gloves", label:"Gloves",     x:180, y:560, side:"left",  targets:["layerGloves"] },
      { key:"pants",  label:"Pants",      x:565, y:720, side:"right", targets:["layerPants"] },
      { key:"socks",  label:"Socks",      x:190, y:1000,side:"left",  targets:["layerSocks"] },
    ],
    shell: [
      { key:"head",   label:"Balaclava",  x:210, y:120, side:"left",  targets:["layerHead"] },
      { key:"jacket", label:"Shell",      x:560, y:240, side:"right", targets:["layerShell"] },
      { key:"gloves", label:"Gloves",     x:180, y:560, side:"left",  targets:["layerGloves"] },
      { key:"pants",  label:"Pants",      x:565, y:760, side:"right", targets:["layerPants"] },
      { key:"socks",  label:"Socks",      x:190, y:1000,side:"left",  targets:["layerSocks"] },
    ]
  };

  function applyCheckTints(){
    // remove tint from all layers first
    ["layerSocks","layerPants","layerHead","layerGloves","layerBaseTop","layerHood","layerShell"]
      .forEach(id => document.getElementById(id)?.classList.remove("tinted"));

    const mode = state.outfitMode;
    const store = state.checks?.[mode] || {};
    const items = CHECK_UI[mode] || [];

    items.forEach(it => {
      if (!store[it.key]) return;
      (it.targets || []).forEach(tid => {
        const el = document.getElementById(tid);
        if (!el) return;
        // tint only if the layer is actually visible
        if (el.style.display !== "none") el.classList.add("tinted");
      });
    });
  }

  function renderCheckPins(){
    const box = document.getElementById("checkCanvas");
    if (!box) return;

    const mode = state.outfitMode;
    const items = CHECK_UI[mode] || [];
    const store = state.checks[mode];

    box.innerHTML = items.map(it => {
      const checked = store[it.key] ? "checked" : "";
      const sideCls = (it.side === "left") ? "side-left" : "side-right";
      return `
        <label class="checkPin ${sideCls}" style="left:${it.x}px; top:${it.y}px" data-key="${it.key}">
          <div class="checkTitle">${it.label}</div>
          <input type="checkbox" ${checked}>
        </label>
      `;
    }).join("");

    // wire events
    box.querySelectorAll("input[type=checkbox]").forEach(inp => {
      inp.addEventListener("change", (e) => {
        const wrap = e.target.closest(".checkPin");
        const key = wrap?.dataset?.key;
        if (!key) return;
        store[key] = e.target.checked;
        applyCheckTints();
        updateOutfitPanels();
      });
    });

    applyCheckTints();
  }

  /*
    ========= TEMPERATURE -> SELECTION (IMPORTANT, –ø–æ–¥–ø–∏—Å–∞–Ω–æ –∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª) =========

    1) Gloves:
       - temp <= -12  -> heavy_gloves
       - else         -> light_gloves

    2) Socks:
       - temp <= -6   -> heavy_socks
       - else         -> light_socks

    3) Base mode (Base tab):
       - Base top: always ON
       - Hood (sweater): ON when temp <= -6, OFF when temp > -6
       - Pants:
           temp <= -6 -> medium_pants
           else       -> base_pants
       - Jacket: OFF (never)

    4) Shell mode (Shell tab):
       - Jacket:
           temp <= -12 -> heavy_jacket
           temp <= -6  -> medium_jacket
           else        -> light_jacket
       - Shell pants (windproof): always ON (heavy_pants_2)
       - Hood: OFF (never)
       - Base top: OFF (optional, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ ‚Äî –≤–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ –µ—Å–ª–∏ –Ω–∞–¥–æ)
  */
  // ===== Outfit text panel (right side) =====
function renderSet(containerId, items){
  const el = document.getElementById(containerId);
  if (!el) return;
  if (!items || !items.length){
    el.textContent = "‚Äî";
    return;
  }

  // ‚úÖ highlight list items when the corresponding checkbox pin is checked
  const store = (containerId === "setShell") ? state.checks.shell : state.checks.base;

  el.innerHTML = items.map(it => {
    const checkedCls = (it.key && store[it.key]) ? "checked" : "";
    const keyAttr = it.key ? `data-key="${it.key}"` : "";
    return `
      <div class="setItem ${checkedCls}" ${keyAttr}>
        <div class="setItemTop">
          <b>${it.title}</b>
          <span class="setFile">${it.file}</span>
        </div>
        <div class="setDesc">${it.desc}</div>
      </div>
    `;
  }).join("");
}

function buildBaseSet(tempC){
  const socksFile = (tempC <= -6) ? "heavy_socks.png" : "light_socks.png";
  const glovesFile = (tempC <= -12) ? "heavy_gloves.png" : "light_gloves.png";
  const pantsFile = (tempC <= -6) ? "medium_pants.png" : "base_pants.png";

  const items = [
    { key:"head", title: "Balaclava", file: "light_head.png",
      desc: "Face + neck protection from wind. Breathable so it doesn‚Äôt get wet inside." },

    { key:"socks", title: "Socks", file: socksFile,
      desc: (tempC <= -6) ? "Warm merino / thermal socks for cold mornings." : "Lighter socks for milder days." },

    { key:"pants", title: "Pants (base/mid)", file: pantsFile,
      desc: (tempC <= -6) ? "Mid-layer pants for insulation (still breathable for touring)." : "Light base pants for mobility and sweat management." },

    { key:"gloves", title: "Gloves", file: glovesFile,
      desc: (tempC <= -12) ? "Warm gloves for very cold conditions." : "Lighter gloves for active touring." },
  ];

  // In Base tab you said: either Base top OR Sweater (never together)
  if (tempC <= -6){
    const hoodFile = chooseHoodVariant(tempC);
    items.splice(2, 0, {
      key:"top", title: "Sweater (mid layer)",
      file: hoodFile,
      desc: "Insulating sweater between base and shell. Auto-selected by temperature (see code comment near chooseHoodVariant)."
    });
  } else {
    items.splice(2, 0, {
      key:"top", title: "Base top",
      file: "light_base.png",
      desc: "Next-to-skin layer that wicks sweat and dries fast."
    });
  }

  return items;
}

function buildShellSet(tempC){
  const socksFile = (tempC <= -6) ? "heavy_socks.png" : "light_socks.png";
  const glovesFile = (tempC <= -12) ? "heavy_gloves.png" : "light_gloves.png";

  const jacketFile =
    (tempC <= -12) ? "heavy_jacket.png" :
    (tempC <= -6)  ? "medium_jacket.png" :
                     "light_jacket.png";

  const pantsFile = (tempC <= -10) ? "heavy_pants_2.png" : "heavy_pants.png";
  return [
    { key:"head", title: "Balaclava", file: "light_head.png",
      desc: "Still useful under shell hood/helmet in wind and snowfall." },

    { key:"socks", title: "Socks", file: socksFile,
      desc: (tempC <= -6) ? "Warm socks for cold + long exposure." : "Lighter socks for comfort when it‚Äôs warmer." },

    { key:"jacket", title: "Shell jacket", file: jacketFile,
      desc: "Windproof layer for descents and storms (selection depends on temperature)." },

    { key:"pants", title: "Shell pants (windproof)", file: pantsFile,
      desc: "Windproof pants for strong wind / snow. Keeps you dry and blocks drafts." },

    { key:"gloves", title: "Gloves", file: glovesFile,
      desc: "Shown under the jacket sleeves (z-index). Use warm gloves if very cold." },
  ];
}

function updateOutfitPanels(){
  const locName = CURRENT_LOC ? CURRENT_LOC.name : "‚Äî";
  const dayText = state.date || "‚Äî";

  const elLoc  = document.getElementById("outfitLoc");
  const elDay  = document.getElementById("outfitDay");
  const elTemp = document.getElementById("outfitTemp");
  const elMode = document.getElementById("outfitModeText");

  if (elLoc)  elLoc.textContent = locName;
  if (elDay)  elDay.textContent = dayText;
  if (elTemp) elTemp.textContent = `${state.tempC}¬∞C`;
  if (elMode) elMode.textContent = (state.outfitMode === "base") ? "Base" : "Shell";

  renderSet("setBase", buildBaseSet(state.tempC));
  renderSet("setShell", buildShellSet(state.tempC));
}

function applyOutfit(){
  // Reset everything first (avoid mixing)
  applyLayer("layerHood", null);
  applyLayer("layerShell", null);
  applyLayer("layerBaseTop", null);
  applyLayer("layerPants", null);

  // Always visible (and UNDER sweater/jacket/base top)
const headCfg = { ...POS.head_light };

// –µ—Å–ª–∏ Base —Ä–µ–∂–∏–º –ò –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è base_top (light base)
// —Ç–æ –ø–æ–¥–Ω–∏–º–∞–µ–º –±–∞–ª–∞–∫–ª–∞–≤—É –≤—ã—à–µ
if (state.outfitMode === "base" && state.tempC > -6) {
  headCfg.z = 75; // –≤—ã—à–µ base_top (60), –Ω–∏–∂–µ hood/jacket
}

 applyLayer("layerHead", headCfg);


  // Socks depend on temperature (shown in both sets)
  applyLayer("layerSocks", (state.tempC <= -6) ? POS.socks_heavy : POS.socks_light);

  // Gloves depend on temperature, but stay UNDER tops (see z-index in POS)
  const glovesType = (state.tempC <= -12) ? "heavy" : "light";

  if (state.outfitMode === "base"){
    // BASE TAB:
    // - Pants: base or medium
    applyLayer("layerPants", (state.tempC <= -6) ? POS.pants_medium : POS.pants_base);

    // - Either sweater OR base top (never both)
    let hoodFile = null;
    if (state.tempC <= -6){
      hoodFile = chooseHoodVariant(state.tempC);
      if (hoodFile === "heavy_hood_2.png") applyLayer("layerHood", POS.hood_02);
      else if (hoodFile === "heavy_hood_3.png") applyLayer("layerHood", POS.hood_03);
      else applyLayer("layerHood", POS.hood_01);
    } else {
      applyLayer("layerBaseTop", POS.base_top);
    }

    // Gloves with possible override if sweater variant changes hand cutouts
    setGloves(glovesType, hoodFile);

  } else {
    // SHELL TAB:
    // - Jacket always on (windproof)
    const jacketCfg =
      (state.tempC <= -12) ? POS.jacket_heavy :
      (state.tempC <= -6)  ? POS.jacket_medium :
                             POS.jacket_light;
    applyLayer("layerShell", jacketCfg);
    // - Shell pants: auto-pick (heavy_pants / heavy_pants_2)
    applyLayer("layerPants", chooseShellPantsCfg(state.tempC));
// Gloves (no sweater override)
    setGloves(glovesType, null);
  }

  updateOutfitPanels();
  updateAvatarScale();
  renderCheckPins();
}
// ========= HEADER NAV ACTIVE STATE =========
(function(){
  const path = (location.pathname || "").toLowerCase();
  const isGear = path.endsWith("/gear.html") || path.endsWith("gear.html");
  const homeLink = document.querySelector('.headerNav a[data-page="home"]');
  const gearLink = document.querySelector('.headerNav a[data-page="gear"]');
  if (!homeLink || !gearLink) return;
  (isGear ? gearLink : homeLink).classList.add("active");
})();

    // ========= LANGUAGE SWITCH (placeholder) =========
    (function () {
      const STORAGE_KEY = "mml_lang";

      const btns = Array.from(document.querySelectorAll(".langBtn[data-lang]"));
      if (!btns.length) return;

      function normalize(lang) {
        lang = (lang || "").toString().toLowerCase();
        if (lang.startsWith("en")) return "en";
        if (lang.startsWith("fr")) return "fr";
        if (lang.startsWith("ru")) return "ru";
        if (lang.startsWith("de")) return "de";
        return "en";
      }

      function showToast(msg) {
        let t = document.getElementById("langToast");
        if (!t) {
          t = document.createElement("div");
          t.id = "langToast";
          t.className = "toast";
          document.body.appendChild(t);
        }
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(t._hideTimer);
        t._hideTimer = setTimeout(() => t.classList.remove("show"), 2200);
      }

      function setLang(code, persist) {
        const c = normalize(code);
        document.documentElement.setAttribute("lang", c);
        document.documentElement.dataset.lang = c;
        btns.forEach(b => b.classList.toggle("active", b.dataset.lang === c));
        if (persist) localStorage.setItem(STORAGE_KEY, c);
        showToast(`Language: ${c.toUpperCase()} (translations coming soon)`);
      }

      const saved = localStorage.getItem(STORAGE_KEY);
      const auto = normalize(navigator.language || navigator.userLanguage || "");
      setLang(saved || auto, false);

      btns.forEach(b => b.addEventListener("click", () => setLang(b.dataset.lang, true)));
    })();


  

// ===== OUTFIT LAYOUT EDITOR (DEV TOOL) =====
(function wireLayoutEditor(){
  const editor = document.getElementById("layoutEditor");
  if (!editor) return;

  const elSelect = document.getElementById("leLayer");
  const elX = document.getElementById("leX");
  const elY = document.getElementById("leY");
  const elR = document.getElementById("leR");
  const elZ = document.getElementById("leZ");
  const btnToggle = document.getElementById("leToggle");
  const btnApply = document.getElementById("leApply");
  const btnResetOne = document.getElementById("leResetOne");
  const btnResetAll = document.getElementById("leResetAll");
  const btnCopy = document.getElementById("leCopy");

  const layerIds = [
    "layerSocks","layerPants","layerHead","layerGloves","layerBaseTop","layerHood","layerShell"
  ];

  let editOn = false;
  let dragging = null; // { id, startX, startY, origLeft, origTop, scale }

  const stage = document.getElementById("avatarStage");

  function getScale(){
    if (!stage) return 1;
    return stage.clientWidth / AVATAR_BASE_W;
  }

  function pxToNum(v){
    const n = parseFloat(String(v||"").replace("px",""));
    return isFinite(n) ? n : 0;
  }

  function getCurrentLayerStyle(id){
    const el = document.getElementById(id);
    if (!el) return { x:0, y:0, r:0, z:10, origin:"50% 20%" };

    const x = pxToNum(el.style.left);
    const y = pxToNum(el.style.top);
    const z = parseInt(el.style.zIndex || "10", 10) || 10;

    let r = 0;
    const tr = el.style.transform || "";
    const m = tr.match(/rotate\(([-0-9.]+)deg\)/);
    if (m) r = parseFloat(m[1]) || 0;

    const origin = el.style.transformOrigin || "50% 20%";
    return { x, y, r, z, origin };
  }

  function selectedId(){
    return elSelect.value || layerIds[0];
  }

  function setInputsFromLayer(id){
    const base = getCurrentLayerStyle(id);
    const ov = (window.LAYOUT_OVERRIDES && window.LAYOUT_OVERRIDES[id]) ? window.LAYOUT_OVERRIDES[id] : {};
    const v = { ...base, ...ov };

    elX.value = Math.round(v.x ?? 0);
    elY.value = Math.round(v.y ?? 0);
    elR.value = (v.r ?? 0);
    elZ.value = (v.z ?? base.z ?? 10);
  }

  function refreshLayerList(){
    const cur = selectedId();
    elSelect.innerHTML = layerIds.map(id => {
      const el = document.getElementById(id);
      const shown = el && el.style.display !== "none";
      const label = id.replace("layer","").replace(/([A-Z])/g, " $1").trim();
      return `<option value="${id}">${label}${shown ? "" : " (hidden)"}</option>`;
    }).join("");
    if (layerIds.includes(cur)) elSelect.value = cur;
    setInputsFromLayer(selectedId());
  }

  function applyFromInputs(){
    const id = selectedId();
    const x = parseFloat(elX.value);
    const y = parseFloat(elY.value);
    const r = parseFloat(elR.value);
    const z = parseInt(elZ.value, 10);

    if (!window.LAYOUT_OVERRIDES) window.LAYOUT_OVERRIDES = {};
    window.LAYOUT_OVERRIDES[id] = {
      x: isFinite(x) ? x : 0,
      y: isFinite(y) ? y : 0,
      r: isFinite(r) ? r : 0,
      z: isFinite(z) ? z : (getCurrentLayerStyle(id).z || 10)
    };
    window.__SAVE_LAYOUT_OVERRIDES?.();
    applyOutfit();
  }

  function resetOne(){
    const id = selectedId();
    if (window.LAYOUT_OVERRIDES && window.LAYOUT_OVERRIDES[id]){
      delete window.LAYOUT_OVERRIDES[id];
      window.__SAVE_LAYOUT_OVERRIDES?.();
      applyOutfit();
      setInputsFromLayer(id);
    }
  }

  function resetAll(){
    window.LAYOUT_OVERRIDES = {};
    window.__SAVE_LAYOUT_OVERRIDES?.();
    applyOutfit();
    refreshLayerList();
  }

  function setEditMode(on){
    editOn = !!on;
    document.body.classList.toggle("editMode", editOn);
    btnToggle.textContent = editOn ? "Disable edit mode" : "Enable edit mode";
  }

  // Dragging (only the selected layer)
  function onPointerDown(e){
    if (!editOn) return;
    const id = selectedId();
    const el = document.getElementById(id);
    if (!el || el.style.display === "none") return;
    if (e.target !== el) return;

    el.classList.add("dragging");
    const scale = getScale();
    const startX = e.clientX;
    const startY = e.clientY;
    const cur = getCurrentLayerStyle(id);

    dragging = { id, startX, startY, origLeft: cur.x, origTop: cur.y, scale };
    e.preventDefault();
  }

  function onPointerMove(e){
    if (!dragging) return;
    const dx = (e.clientX - dragging.startX) / dragging.scale;
    const dy = (e.clientY - dragging.startY) / dragging.scale;

    const nx = dragging.origLeft + dx;
    const ny = dragging.origTop + dy;

    if (!window.LAYOUT_OVERRIDES) window.LAYOUT_OVERRIDES = {};
    const prev = window.LAYOUT_OVERRIDES[dragging.id] || {};
    window.LAYOUT_OVERRIDES[dragging.id] = { ...prev, x: nx, y: ny };
    window.__SAVE_LAYOUT_OVERRIDES?.();

    const el = document.getElementById(dragging.id);
    if (el){
      el.style.left = `${nx}px`;
      el.style.top  = `${ny}px`;
    }

    elX.value = Math.round(nx);
    elY.value = Math.round(ny);
  }

  function onPointerUp(){
    if (!dragging) return;
    const el = document.getElementById(dragging.id);
    if (el) el.classList.remove("dragging");
    dragging = null;
  }

  async function copyJson(){
    const data = window.LAYOUT_OVERRIDES || {};
    const pretty = JSON.stringify(data, null, 2);
    try{
      await navigator.clipboard.writeText(pretty);
      alert("Layout JSON copied to clipboard.");
    }catch(e){
      prompt("Copy JSON:", pretty);
    }
  }

  elSelect.addEventListener("change", () => setInputsFromLayer(selectedId()));
  btnToggle.addEventListener("click", () => setEditMode(!editOn));
  btnApply.addEventListener("click", applyFromInputs);
  btnResetOne.addEventListener("click", resetOne);
  btnResetAll.addEventListener("click", resetAll);
  btnCopy.addEventListener("click", copyJson);

  // Keep list fresh after outfit changes
  const _applyOutfit = window.applyOutfit;
  if (typeof _applyOutfit === "function") {
    window.applyOutfit = function(){
      const r = _applyOutfit.apply(this, arguments);
      try{ refreshLayerList(); }catch(e){}
      return r;
    };
  }

  document.addEventListener("pointerdown", onPointerDown, { passive:false });
  document.addEventListener("pointermove", onPointerMove, { passive:false });
  document.addEventListener("pointerup", onPointerUp, { passive:true });
  document.addEventListener("pointercancel", onPointerUp, { passive:true });

  refreshLayerList();
  setEditMode(false);
})();


function updateSetupUI(){
  const tempVal  = document.getElementById("tempVal");
  const levelVal = document.getElementById("levelVal");
  const modeVal  = document.getElementById("modeVal");

  if (tempVal)  tempVal.textContent  = `${state.tempC}¬∞C`;
  if (levelVal) levelVal.textContent = `Level: ${tempLevel(state.tempC)}`;
  if (modeVal)  modeVal.textContent  = `Mode: ${state.outfitMode === "base" ? "Base" : "Shell"}`;

  // Re-apply outfit layers for the new temperature/mode
  applyOutfit();

  // Keep tint + list highlight in sync
  applyCheckTints();
  updateOutfitPanels();
}

  function wireSetupControls(){
  const tempRange = document.getElementById("tempRange");
  const tabBase = document.getElementById("tabBase");
  const tabShell = document.getElementById("tabShell");

  // ‚úÖ Temperature slider works again
  if (tempRange){
    tempRange.value = state.tempC;
    tempRange.addEventListener("input", () => {
      state.tempC = parseInt(tempRange.value, 10);
      updateSetupUI();
    });
  }

  tabBase.addEventListener("click", () => {
    state.outfitMode = "base";
    tabBase.classList.add("active");
    tabShell.classList.remove("active");
    updateSetupUI();
  });

  tabShell.addEventListener("click", () => {
    state.outfitMode = "shell";
    tabShell.classList.add("active");
    tabBase.classList.remove("active");
    updateSetupUI();
  });

  updateSetupUI();
}

  // ========= INFO HERO RENDER =========
  function setInfoImage(url){
    const bg = document.getElementById("infoBg");
    if (!bg) return;

    const tryUrl = (url && String(url).trim()) ? url : PLACEHOLDER_MOUNTAIN_IMAGE;

    // Preload image to detect missing files (404) and fall back to zaplatka
    const img = new Image();
    img.onload = () => {
      bg.style.backgroundImage = `url('${tryUrl}')`;
      bg.style.display = "";
    };
    img.onerror = () => {
      bg.style.backgroundImage = `url('${PLACEHOLDER_MOUNTAIN_IMAGE}')`;
      bg.style.display = "";
    };
    img.src = tryUrl;
  }

  function setHeroText(loc){
    document.getElementById("infoTitle").textContent = loc ? loc.name : "Pick a mountain";
    document.getElementById("infoSub").textContent = loc ? `${loc.region}, ${loc.country}` : "Click a marker on the map";

    const pillBase = document.getElementById("pillBase");
    const pillTop = document.getElementById("pillTop");

    if (loc){
      pillBase.style.display = "";
      pillTop.style.display = "";
      pillBase.textContent = `Base: ${loc.base_m}m`;
      pillTop.textContent = `Top: ${loc.top_m}m`;
    } else {
      pillBase.style.display = "none";
      pillTop.style.display = "none";
    }
  }

  // ========= FORECAST RENDER =========
  function renderPanelLoading(){
    document.getElementById("panelBody").innerHTML = `
      <div class="muted">Forecast (Open-Meteo)</div>
      <div class="hint" style="margin-top:10px;">Loading‚Ä¶</div>
    `;
  }

  function wireForecastEvents(){
    const dp = document.getElementById("datePick");
    if (dp){
      dp.onchange = () => {
        state.date = dp.value;
        rerenderForecast(true);
      };
    }

    document.querySelectorAll(".dayCard").forEach(c => {
      c.onclick = () => {
        state.date = c.dataset.date;
        rerenderForecast(true);
        const dp2 = document.getElementById("datePick");
        if (dp2) dp2.value = state.date;
      };
    });

    document.querySelectorAll(".hourlySeg button").forEach(b => {
      b.onclick = () => {
        state.metric = b.dataset.m;
        rerenderForecast(false);
      };
    });
  }

  function rerenderForecast(updateTempFromDaily){
    if (!LAST_WEATHER_DATA || !state.date) return;
    const day = pickDailyByDate(LAST_WEATHER_DATA.daily, state.date);
    renderForecast(day);

    // Auto-set temperature from forecast day (kept)
    if (updateTempFromDaily && day && typeof day.tmin === "number" && typeof day.tmax === "number"){
      state.tempC = Math.round((day.tmin + day.tmax) / 2);
      const range = document.getElementById("tempRange");
      if (range) range.value = state.tempC;
      updateSetupUI();
    }
  }

  function renderForecast(day){
    const body = document.getElementById("panelBody");
    const d = LAST_WEATHER_DATA;
    const dailyTimes = d?.daily?.time || [];

    const minDate = dailyTimes[0] || "";
    const maxDate = dailyTimes[dailyTimes.length - 1] || "";

    const dailyStrip = (dailyTimes.length ? `
      <div class="dailyRow">
        ${dailyTimes.map((dt, i) => {
          const dd = pickDaily(d.daily, i);
          const emo = weatherCodeToEmoji(dd.code);
          const wday = new Date(dt).toLocaleDateString(undefined, { weekday: "short" });
          const active = dt === state.date ? "active" : "";
          const tmax = (typeof dd.tmax === "number") ? Math.round(dd.tmax) : "‚Äî";
          const tmin = (typeof dd.tmin === "number") ? Math.round(dd.tmin) : "‚Äî";
          return `
            <div class="dayCard ${active}" data-date="${dt}">
              <div class="dayName">${wday}</div>
              <div class="dayEmoji">${emo}</div>
              <div class="dayTemps"><b>${tmax}¬∞</b> / ${tmin}¬∞</div>
            </div>
          `;
        }).join("")}
      </div>
    ` : "");

    const controls = `
      <div class="row" style="margin-top:0;">
        <div class="pill">Date</div>
        <input id="datePick" type="date" value="${state.date || ""}" min="${minDate}" max="${maxDate}">
      </div>
      ${dailyStrip}
    `;

    if (!day){
      body.innerHTML = `
        <div class="muted">Forecast (Open-Meteo)</div>
        ${controls}
        <div class="hint" style="margin-top:10px;">No forecast for this date (try another).</div>
      `;
      wireForecastEvents();
      return;
    }

    const base = weatherCodeToText(day.code);
    const emoji = weatherCodeToEmoji(day.code);

    const hours = pickHourlyForDate(d.hourly, day.date);
    const hourlyHtml = renderHourlyForecast(hours);

    body.innerHTML = `
      <div class="muted">Forecast (Open-Meteo)</div>
      ${controls}

      <div class="row" style="margin-top:10px;">
        <div class="pill">${emoji} ${base}</div>
        <div class="pill">Min: ${Math.round(day.tmin)}¬∞C</div>
        <div class="pill">Max: ${Math.round(day.tmax)}¬∞C</div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="pill">Precip: ${day.precip ?? "n/a"} mm</div>
        <div class="pill">Snow: ${day.snow ?? "n/a"} cm</div>
        <div class="pill">Wind max: ${day.windMax ?? "n/a"} km/h</div>
      </div>

      <div class="divider"></div>
      <div class="hint">Tip: date affects outfit temperature suggestion.</div>

      ${hourlyHtml}
    `;

    wireForecastEvents();
  }

  async function updateWeatherFor(loc){
    renderPanelLoading();
    try{
      const data = await getWeather(loc.lat, loc.lon);
      if (selectedLocationId !== loc.id) return;

      LAST_WEATHER_DATA = data;

      const dailyTimes = data.daily?.time || [];
      const today = data.current_weather?.time?.slice(0,10);

      state.date = state.date || today || (dailyTimes[0] ?? null);
      if (dailyTimes.length && state.date && !dailyTimes.includes(state.date)) state.date = dailyTimes[0];

      const day = state.date ? pickDailyByDate(data.daily, state.date) : null;
      renderForecast(day);

      if (day && typeof day.tmin === "number" && typeof day.tmax === "number") {
        state.tempC = Math.round((day.tmin + day.tmax) / 2);
        const range = document.getElementById("tempRange");
        if (range) range.value = state.tempC;
        updateSetupUI();
      }
    }catch(e){
      console.error(e);
      document.getElementById("panelBody").innerHTML = `
        <div class="muted">Forecast (Open-Meteo)</div>
        <div class="hint" style="margin-top:10px;">
          Couldn‚Äôt load forecast. Try refresh (Ctrl+F5).<br/>
          <span class="muted">${e.message}</span>
        </div>
      `;
    }
  }

  function renderLocation(loc){
    selectedLocationId = loc.id;
    CURRENT_LOC = loc;
    setInfoImage(loc.image);
    setHeroText(loc);
    updateSetupUI();
    updateWeatherFor(loc);
  }

  
  // ========= MAP SEARCH (UI) =========
  const MARKER_BY_ID = new Map();

  function normStr(s){
    return (s || "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function setSearchOpen(open){
    const box = document.getElementById("mapSearch");
    if (!box) return;
    box.classList.toggle("collapsed", !open);
    if (open){
      const inp = document.getElementById("mapSearchInput");
      if (inp) setTimeout(() => inp.focus(), 0);
    }
  }

  function renderSearchResults(qRaw){
    const q = normStr(qRaw).trim();
    const resultsEl = document.getElementById("mapSearchResults");
    if (!resultsEl) return;

    if (!q){
      resultsEl.innerHTML = `<div class="mapSearchItem"><span>Type to search by mountain name or region‚Ä¶</span></div>`;
      return;
    }

    const hits = (LOCATIONS || []).filter(l => {
      const hay = normStr(`${l.name} ${l.region} ${l.country}`);
      return hay.includes(q);
    }).slice(0, 10);

    if (!hits.length){
      resultsEl.innerHTML = `<div class="mapSearchItem"><span>No matches.</span></div>`;
      return;
    }

    resultsEl.innerHTML = hits.map(l => `
      <div class="mapSearchItem" data-id="${l.id}">
        <b>${l.name}</b>
        <span>${l.region}, ${l.country}</span>
      </div>
    `).join("");

    resultsEl.querySelectorAll(".mapSearchItem[data-id]").forEach(node => {
      node.addEventListener("click", () => {
        const id = node.getAttribute("data-id");
        const loc = (LOCATIONS || []).find(x => String(x.id) === String(id));
        if (!loc) return;

        // Select location (updates hero + forecast + outfit)
        renderLocation(loc);

        // Move map + open popup
        const m = MARKER_BY_ID.get(String(loc.id));
        map.setView([loc.lat, loc.lon], Math.max(map.getZoom(), 12), { animate:true });

        // MarkerCluster: make sure marker becomes visible before opening popup
        if (m && markersLayer && typeof markersLayer.zoomToShowLayer === "function"){
          markersLayer.zoomToShowLayer(m, () => m.openPopup());
        } else if (m){
          m.openPopup();
        }
// Keep input text + close panel (nice on mobile)
        const inp = document.getElementById("mapSearchInput");
        if (inp) inp.value = loc.name;
        setSearchOpen(false);
      });
    });
  }

  function wireMapSearch(){
    const btn = document.getElementById("mapSearchBtn");
    const inp = document.getElementById("mapSearchInput");
    const box = document.getElementById("mapSearch");

    if (!btn || !inp || !box) return;

    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isCollapsed = box.classList.contains("collapsed");
      setSearchOpen(isCollapsed);
      renderSearchResults(inp.value);
    });

    inp.addEventListener("input", () => renderSearchResults(inp.value));

    // Close when clicking outside
    document.addEventListener("click", (e) => {
      if (!box.contains(e.target)) setSearchOpen(false);
    });

    // First paint
    renderSearchResults("");
  }


// ========= MARKERS =========
  let LOCATIONS = [];
  function addMarkers(){
    markersLayer.clearLayers();
    MARKER_BY_ID.clear();

    LOCATIONS.forEach(loc => {
      const m = L.marker([loc.lat, loc.lon]);
      m.bindPopup(`<b>${loc.name}</b><br>${loc.region}, ${loc.country}`);
      m.on("click", () => renderLocation(loc));
      markersLayer.addLayer(m);

      // for search ‚Üí quick focus + popup
      MARKER_BY_ID.set(String(loc.id), m);
    });
  }

  // ========= INIT =========
  wireSetupControls();
    setHeroText(null);

    // Layout editor wiring (button + panel) after DOM is ready
    window.addEventListener('DOMContentLoaded', () => {
      try { wireLayoutEditor(); } catch (e) { console.warn(e); }
    });

  (async () => {
    try{
      LOCATIONS = await loadLocations();
      addMarkers();
      wireMapSearch();
      const bounds = L.latLngBounds(LOCATIONS.map(l => [l.lat, l.lon]));
      map.fitBounds(bounds.pad(0.2));
      setTimeout(() => map.invalidateSize(), 200);
    }catch(e){
      console.error(e);
      document.getElementById("panelBody").innerHTML = `
        <h2 class="title">Error loading locations</h2>
        <div class="muted">${e.message}</div>
        <div class="hint" style="margin-top:10px;">
          Check that <code>data/locations.geojson</code> exists and is committed.
        </div>
      `;
    }
  })();

  // First paint avatar
  applyOutfit();
  updateAvatarScale();
</script>

  <!-- ===== LAYOUT EDITOR (toggle button) ===== -->
  <button id="layoutEditBtn" class="layoutEditBtn" type="button" title="Edit outfit positions (dev tool)">
    üõ† Layout editor
  </button>

  <div id="layoutEditPanel" class="layoutEditPanel" aria-hidden="true">
    <div class="layoutEditHeader">
      <div class="layoutEditTitle">Outfit layout editor</div>
      <button id="layoutEditClose" class="layoutEditClose" type="button" aria-label="Close">‚úï</button>
    </div>

    <div class="layoutEditBody">
      <div class="layoutEditRow">
        <label class="layoutEditLabel">Item</label>
        <select id="layoutEditSelect" class="layoutEditSelect"></select>
      </div>

      <div class="layoutEditGrid">
        <div class="layoutEditField">
          <label class="layoutEditLabel">x</label>
          <input id="layoutEditX" type="number" step="1" class="layoutEditInput">
        </div>
        <div class="layoutEditField">
          <label class="layoutEditLabel">y</label>
          <input id="layoutEditY" type="number" step="1" class="layoutEditInput">
        </div>
        <div class="layoutEditField">
          <label class="layoutEditLabel">r (deg)</label>
          <input id="layoutEditR" type="number" step="0.1" class="layoutEditInput">
        </div>
        <div class="layoutEditField">
          <label class="layoutEditLabel">z</label>
          <input id="layoutEditZ" type="number" step="1" class="layoutEditInput">
        </div>
      </div>

      <div class="layoutEditHint">
        Tip: change values ‚Üí it updates live. When you're happy, click ‚ÄúCopy POS JSON‚Äù and paste it back into the file (const POS = {...}).
      </div>

      <div class="layoutEditActions">
        <button id="layoutEditCopy" class="layoutEditActionBtn" type="button">Copy POS JSON</button>
        <button id="layoutEditReset" class="layoutEditActionBtn ghost" type="button">Reset</button>
      </div>
    </div>
  </div>

</body>
</html>
























































































