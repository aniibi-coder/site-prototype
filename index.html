<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meow Meow Land</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --text:#eaf0ff; --muted:#9fb0d0; --line:#24304a; --blue:#2a6dff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      overflow-y:auto;
    }
    header{
      height:56px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      gap:12px;
      position:sticky;
      top:0;
      background:rgba(11,18,32,0.92);
      backdrop-filter: blur(8px);
      z-index: 50;
    }
    header .badge{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px; border-radius:999px;
    }

    /* ===== MAIN GRID ===== */
    .wrap{
      min-height: calc(100vh - 56px);
      display:grid;
      grid-template-columns: 1.15fr 1fr;
      grid-template-rows: 360px auto auto;
      gap:12px;
      padding:12px;
      align-content:start;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      overflow:hidden;
      min-height:0;
    }
    .title{ font-size:18px; margin:0 0 6px 0; }
    .muted{ color:var(--muted); font-size:13px; }
    .hint{ font-size:13px; color:var(--muted); line-height:1.4; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center; }
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:13px;
      color:var(--muted);
      background: rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
      white-space:nowrap;
    }

    /* ===== TOP LEFT: MAP ===== */
    #mapCard{ grid-column:1; grid-row:1; padding:0; }
    #map{ width:100%; height:100%; border-radius:14px; }

    /* ===== TOP RIGHT: INFO ===== */
    #infoCard{
      grid-column:2; grid-row:1;
      padding:0;
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:100%;
    }

    .infoHero{
      position:relative;
      height:112px;
      background:#0d1426;
      overflow:hidden;
      border-bottom:1px solid var(--line);
      flex:0 0 auto;
    }
    .infoHero .bg{
      position:absolute;
      inset:0;
      background-size: cover;
      background-position:center;
      filter: blur(6px);
      transform: scale(1.04);
      opacity: 0.75;
    }
    .infoHero .overlay{
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.80));
    }
    .infoHeroContent{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding:12px 14px;
      z-index:2;
    }
    .infoHeroTopRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .infoHeroTitle{
      margin:0;
      font-size:20px;
      font-weight:900;
      text-shadow: 0 6px 30px rgba(0,0,0,0.55);
    }
    .infoHeroSub{
      margin-top:2px;
      color:rgba(234,240,255,0.78);
      font-size:13px;
      text-shadow: 0 6px 30px rgba(0,0,0,0.55);
    }

    .infoBody{
      padding:14px;
      overflow:auto;
      flex:1 1 auto;
    }

    .divider{ height:1px; background:var(--line); margin:12px 0; opacity:0.9; }

    /* Date input */
    #datePick{
      background:rgba(0,0,0,0.18);
      border:1px solid var(--line);
      color:var(--text);
      padding:7px 10px;
      border-radius:12px;
      outline:none;
    }

    /* ===== DAILY STRIP (cards) ===== */
    .dailyRow{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding-bottom:6px;
      margin-top:10px;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .dayCard{
      flex:0 0 auto;
      width:96px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px;
      background:rgba(0,0,0,0.12);
      cursor:pointer;
      user-select:none;
      text-align:center;
      scroll-snap-align:start;
    }
    .dayCard.active{
      border-color:rgba(42,109,255,0.55);
      background:rgba(42,109,255,0.16);
    }
    .dayName{ font-size:12px; color:var(--muted); }
    .dayEmoji{ font-size:18px; margin-top:6px; }
    .dayTemps{ font-size:12px; margin-top:6px; }
    .dayTemps b{ font-size:13px; }

    /* ===== METRIC BUTTONS (compact) ===== */
    .seg{
      display:flex;
      gap:6px;
      margin-top:10px;
    }
    .seg button{
      flex:1;
      background:transparent;
      border:1px solid var(--line);
      color:var(--muted);
      padding:6px 8px;
      border-radius:10px;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .seg button.active{
      background:rgba(42,109,255,0.18);
      border-color:rgba(42,109,255,0.45);
      color:#dbe8ff;
    }

    /* ===== HOURLY ===== */
    .hourlyWrap{
      margin-top:12px;
      border-top:1px solid var(--line);
      padding-top:12px;
    }
    .hourlyChart{
      width:100%;
      height:76px;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(0,0,0,0.12);
      overflow:hidden;
      margin-top:10px;
    }
    .hourlyRow{
      margin-top:10px;
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding-bottom:6px;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .hourCard{
      flex:0 0 auto;
      width:96px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:rgba(0,0,0,0.12);
      scroll-snap-align:start;
    }
    .hourTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .hourTime{ font-size:12px; color:var(--muted); }
    .hourEmoji{ font-size:16px; }
    .hourBig{ font-size:18px; font-weight:900; margin-top:8px; }
    .hourMeta{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.2; }

    /* ===== OUTFIT ===== */
    #outfitCard{ grid-column:1 / 3; grid-row:2; }
    .outfitGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:10px;
      align-items:start;
      justify-items:center;
    }
    .avatarBox{
      border:1px dashed var(--line);
      border-radius:14px;
      padding:12px;
      background: rgba(255,255,255,0.02);
      width: 100%;
      display:flex;
      flex-direction:column;
      align-items:stretch;   /* ‚úÖ allow grid to use full width */
      justify-content:flex-start;
      gap:14px;
    }

    /* ===== NEW: Left tabs (Base / Shell) next to avatar ===== */
    .avatarRow{
      width:100%;
      max-width:760px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      justify-self:center;
      gap:12px;
    }
    .layerTabs{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:stretch;
      flex:0 0 auto;
      padding-top:6px;
    }
    .layerTabs button{
      width:72px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      border-radius:12px;
      background:rgba(0,0,0,0.15);
      border:1px solid var(--line);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .layerTabs button.active{
      background:rgba(42,109,255,0.18);
      border-color:rgba(42,109,255,0.45);
      color:#dbe8ff;
    }

    /* ====== AVATAR: base coordinate system 715x1138 ====== */
    .avatarStage{
      position:relative;
      width: 715px;          /* ‚úÖ fixed: prevents 0px width in flex/grid */
      max-width: 100%;
      aspect-ratio: 715 / 1138;
      border-radius:12px;
      overflow:hidden;
      background: radial-gradient(circle at 30% 10%, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
    }
    .avatarCanvas{
      position:absolute;
      inset:0;
      width:715px;
      height:1138px;
      transform-origin: 0 0;
      pointer-events:none;
      user-select:none;
    }
    .avatarCanvas img{
      position:absolute;
      width:auto;
      height:auto;
      pointer-events:none;
      user-select:none;
    }
    .avatarLayout{
      width:100%;
      display:grid;
      grid-template-columns: minmax(340px, 760px) 360px;
      gap:16px;
      align-items:start;
      justify-content:center;
    }

.controlsWrap{
  width: 340px;
  max-width: 380px;
  height:auto;
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px;
  background:rgba(0,0,0,0.12);
}

/* Collapsible sets */
details.setBox{
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px 10px 6px 10px;
  background:rgba(0,0,0,0.10);
  margin-top:10px;
}
details.setBox > summary{
  cursor:pointer;
  user-select:none;
  font-weight:900;
  font-size:13px;
  color:#dbe8ff;
  list-style:none;
  outline:none;
}
details.setBox > summary::-webkit-details-marker{ display:none; }
details.setBox > summary:before{
  content:"‚ñ∏";
  display:inline-block;
  margin-right:8px;
  color:rgba(159,176,208,0.9);
  transform: translateY(-1px);
}
details.setBox[open] > summary:before{
  content:"‚ñæ";
}
.setList{
  margin-top:10px;
}
.setItem{
  padding:8px 8px;
  border-top:1px solid rgba(36,48,74,0.7);
}
.setItem:first-child{ border-top:none; }
.setItemTop{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:baseline;
}
.setFile{
  color:rgba(159,176,208,0.95);
  font-size:12px;
  white-space:nowrap;
}
.setDesc{
  margin-top:4px;
  color:rgba(159,176,208,0.9);
  font-size:12px;
  line-height:1.35;
}
    .controlsHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .controlsHeaderTitle{ font-weight:900; }
    .toggle{ display:flex; gap:8px; margin-top:10px; }
    .toggle button{
      flex:1;
      background:transparent;
      border:1px solid var(--line);
      color:var(--muted);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
    }
    .toggle button.active{
      background:var(--blue);
      border-color:var(--blue);
      color:#fff;
    }
    .control{ margin-top:12px; }
    .control label{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    input[type="range"]{ width:100%; margin-top:8px; }
    .kpi{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }

    /* ===== LIST ===== */
    #listCard{ grid-column:1 / 3; grid-row:3; overflow:visible; }
    .item{
      display:grid;
      grid-template-columns: 90px 1fr 120px;
      gap:12px;
      padding:10px;
      border:1px solid var(--line);
      border-radius:14px;
      margin-top:10px;
      align-items:center;
    }
    .thumb{ width:90px; height:70px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,0.03); }
    .item h4{ margin:0 0 4px 0; font-size:14px; }
    .item a{
      display:inline-block;
      text-align:center;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(42,109,255,0.15);
      border:1px solid rgba(42,109,255,0.35);
      color:#cfe0ff;
      text-decoration:none;
      font-weight:900;
    }

    /* ===== MOBILE ===== */
    @media (max-width: 980px){
      .wrap{
        grid-template-columns: 1fr;
        grid-template-rows: 260px auto auto auto;
      }
      #mapCard{ grid-column:1; grid-row:1; }
      #infoCard{ grid-column:1; grid-row:2; height:auto; }
      #outfitCard{ grid-column:1; grid-row:3; }
      #listCard{ grid-column:1; grid-row:4; }

      .avatarStage{ max-width: 520px; }
      .controlsWrap{ max-width: 520px; }

      .avatarLayout{
        grid-template-columns: 1fr;
        justify-items:center;
      }
      .controlsWrap{
        width:100%;
        max-width:520px;
      }

      .avatarRow{
        flex-direction:column;
        align-items:center;
      }
      .layerTabs{
        flex-direction:row;
        padding-top:0;
      }
      .layerTabs button{
        width:auto;
        min-width:92px;
      }
    }
  </style>
</head>

<body>
  <header>
    <div style="font-weight:900;">Ski Touring Gear Finder</div>
    <div class="badge">MVP ‚Ä¢ one page ‚Ä¢ Leaflet</div>
  </header>

  <div class="wrap">
    <!-- MAP -->
    <div class="card" id="mapCard">
      <div id="map"></div>
    </div>

    <!-- INFO -->
    <div class="card" id="infoCard">
      <div class="infoHero">
        <div class="bg" id="infoBg"></div>
        <div class="overlay"></div>

        <div class="infoHeroContent">
          <div class="infoHeroTopRow">
            <div>
              <h2 class="infoHeroTitle" id="infoTitle">Pick a mountain</h2>
              <div class="infoHeroSub" id="infoSub">Click a marker on the map</div>
            </div>
            <div class="row" style="margin-top:0;">
              <div class="pill" id="pillBase" style="display:none;">Base: ‚Äî</div>
              <div class="pill" id="pillTop" style="display:none;">Top: ‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <div class="infoBody" id="panelBody">
        <div class="muted">Forecast (Open-Meteo)</div>
        <div class="hint" style="margin-top:10px;">Pick a mountain to load forecast.</div>
      </div>
    </div>

    <!-- OUTFIT -->
    <div class="card" id="outfitCard">
      <h2 class="title">Outfit preview</h2>
      <div class="muted">Tabs: Base / Shell. Temperature changes the selection inside each tab.</div>

      <div class="outfitGrid">
        <div class="avatarBox">

          <div class="avatarLayout">

          <div class="avatarRow">
            <!-- LEFT TABS -->
            <div class="layerTabs" aria-label="Outfit category">
              <button id="tabBase" class="active" type="button">Base</button>
              <button id="tabShell" type="button">Shell</button>
            </div>

            <!-- AVATAR -->
            <div class="avatarStage" id="avatarStage">
              <div class="avatarCanvas" id="avatarCanvas">
                <!-- Layer order (CSS z-index controls the real stacking):
                     socks -> pants -> head (under tops) -> gloves (under tops) -> base/hood -> shell jacket -->
                <img id="layerSocks" alt="Socks">
                <img id="layerPants" alt="Pants">
                <img id="layerHead" alt="Balaclava / head (UNDER all tops)">
                <img id="layerGloves" alt="Gloves (UNDER tops)">
                <img id="layerBaseTop" alt="Base layer top (Base only)">
                <img id="layerHood" alt="Sweater (Base only)">
                <img id="layerShell" alt="Shell jacket (Shell only)">
              </div>
            </div>
          </div>

          <!-- CONTROLS -->
          <div class="controlsWrap" id="controlsWrap">
            <div class="controlsHeader">
              <div>
                <div class="controlsHeaderTitle">Setup</div>
                <div class="muted" style="margin-top:4px;">Temperature</div>
              </div>
              <div class="pill" id="levelVal">Level: Cold</div>
            </div>
<div class="control">
              <label>
                <span>Temperature</span>
                <span class="pill" id="tempVal">-8¬∞C</span>
              </label>
              <input id="tempRange" type="range" min="-25" max="5" step="1" value="-8">
            </div>

            <div class="kpi">
<div class="pill" id="modeVal">Mode: Base</div>
            </div>

            <div class="divider"></div>

<div class="hint" id="outfitHeader">
  <div><span class="muted">Based on:</span> <b id="outfitLoc">‚Äî</b></div>
  <div style="margin-top:4px;">
    <span class="muted">Day:</span> <b id="outfitDay">‚Äî</b>
    <span class="muted"> ‚Ä¢ Avg temp:</span> <b id="outfitTemp">‚Äî</b>
  </div>
  <div class="muted" style="margin-top:6px;">Recommended now: <b id="outfitModeText">‚Äî</b></div>
</div>

<details class="setBox" open>
  <summary>Base set (layering)</summary>
  <div class="setList" id="setBase">‚Äî</div>
</details>

<details class="setBox">
  <summary>Shell set (wind / snow)</summary>
  <div class="setList" id="setShell">‚Äî</div>
</details>

<div class="hint" style="margin-top:12px;">
              Tip: pick a mountain + day to auto-set temperature from forecast.
            </div>
          </div>

          </div>

        </div>
      </div>
    </div>

    <!-- LIST -->
    <div class="card" id="listCard">
      <h2 class="title">Recommended gear</h2>
      <div class="muted">Placeholder list (next: real items + affiliate links).</div>

      <div class="item">
        <div class="thumb"></div>
        <div>
          <h4>Base layer (merino top)</h4>
          <div class="muted">Warm, breathable, next-to-skin.</div>
        </div>
        <a href="#" onclick="return false;">Link</a>
      </div>

      <div class="item">
        <div class="thumb"></div>
        <div>
          <h4>Shell jacket (Gore-Tex style)</h4>
          <div class="muted">Windproof + waterproof protection.</div>
        </div>
        <a href="#" onclick="return false;">Link</a>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="muted">
          Disclaimer (draft): Recommendations are generic and informational only. Always check real weather & avalanche bulletin before touring.
        </div>
      </div>
    </div>
  </div>

<script>
  // ========= LOAD LOCATIONS =========
  async function loadLocations() {
    const res = await fetch("./data/locations.geojson");
    if (!res.ok) throw new Error("Failed to load GeoJSON: " + res.status);
    const geo = await res.json();

    return geo.features.map(f => {
      const p = f.properties;
      const [lon, lat] = f.geometry.coordinates;
      return {
        id: p.id,
        name: p.name,
        region: p.region,
        country: p.country,
        image: p.image || null,
        lat, lon,
        base_m: p.base_m,
        top_m: p.top_m,
        tempProfile: { mild: p.mild, normal: p.normal, cold: p.cold }
      };
    });
  }

  // ========= MAP INIT =========
  const map = L.map("map", { zoomControl:true }).setView([45.5, 6.6], 8);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  const markersLayer = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true });
  map.addLayer(markersLayer);

  setTimeout(() => map.invalidateSize(), 250);

  // ========= WEATHER (Open-Meteo) =========
  const weatherCache = new Map();
  const WEATHER_TTL_MS = 15 * 60 * 1000;
  function cacheKey(lat, lon){ return `${lat.toFixed(3)},${lon.toFixed(3)}`; }

  function weatherCodeToText(code) {
    const m = {
      0:"Clear",1:"Mostly clear",2:"Partly cloudy",3:"Overcast",45:"Fog",48:"Rime fog",
      51:"Light drizzle",53:"Drizzle",55:"Heavy drizzle",
      61:"Light rain",63:"Rain",65:"Heavy rain",
      71:"Light snow",73:"Snow",75:"Heavy snow",
      80:"Rain showers",85:"Snow showers",
      95:"Thunderstorm"
    };
    return m[code] ?? `Weather code ${code}`;
  }

  function weatherCodeToEmoji(code){
    if (code === 0) return "‚òÄÔ∏è";
    if (code === 1) return "üå§Ô∏è";
    if (code === 2) return "‚õÖ";
    if (code === 3) return "‚òÅÔ∏è";
    if (code === 45 || code === 48) return "üå´Ô∏è";
    if (code >= 51 && code <= 55) return "üå¶Ô∏è";
    if (code >= 61 && code <= 65) return "üåßÔ∏è";
    if (code === 80) return "üå¶Ô∏è";
    if (code === 95) return "‚õàÔ∏è";
    if (code === 71 || code === 73 || code === 75) return "‚ùÑÔ∏è";
    if (code === 85) return "üå®Ô∏è";
    return "üå°Ô∏è";
  }

  async function getWeather(lat, lon){
    const key = cacheKey(lat, lon);
    const cached = weatherCache.get(key);
    if (cached && (Date.now() - cached.ts) < WEATHER_TTL_MS) return cached.data;

    const url =
      `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${encodeURIComponent(lat)}` +
      `&longitude=${encodeURIComponent(lon)}` +
      `&current_weather=true` +
      `&hourly=temperature_2m,precipitation,snowfall,windspeed_10m,weathercode` +
      `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,snowfall_sum,windspeed_10m_max,weathercode` +
      `&forecast_days=16` +
      `&timezone=auto`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`Weather API error: ${res.status}`);
    const data = await res.json();
    weatherCache.set(key, { ts: Date.now(), data });
    return data;
  }

  function pickDaily(daily, idx){
    return {
      date: daily.time?.[idx],
      tmin: daily.temperature_2m_min?.[idx],
      tmax: daily.temperature_2m_max?.[idx],
      precip: daily.precipitation_sum?.[idx],
      snow: daily.snowfall_sum?.[idx],
      windMax: daily.windspeed_10m_max?.[idx],
      code: daily.weathercode?.[idx],
    };
  }

  function pickDailyByDate(daily, dateStr){
    const times = daily?.time || [];
    const idx = times.indexOf(dateStr);
    if (idx === -1) return null;
    return pickDaily(daily, idx);
  }

  function pickHourlyForDate(hourly, dateStr){
    const times = hourly?.time || [];
    const out = [];
    for (let i=0;i<times.length;i++){
      if (times[i].startsWith(dateStr)){
        out.push({
          time: times[i],
          temp: hourly.temperature_2m?.[i],
          precip: hourly.precipitation?.[i],
          snow: hourly.snowfall?.[i],
          wind: hourly.windspeed_10m?.[i],
          code: hourly.weathercode?.[i],
        });
      }
    }
    return out;
  }

  function svgSparkline(values, w=900, h=76, pad=10, unitText=""){
    const nums = values.filter(v => typeof v === "number" && isFinite(v));
    if (!nums.length) return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="100%"></svg>`;

    const minV = Math.min(...nums);
    const maxV = Math.max(...nums);
    const range = (maxV - minV) || 1;

    const stepX = (w - pad*2) / Math.max(values.length - 1, 1);

    const pts = values.map((v, idx) => {
      const safe = (typeof v === "number" && isFinite(v)) ? v : minV;
      const x = pad + idx * stepX;
      const y = pad + (h - pad*2) * (1 - ((safe - minV) / range));
      return `${x.toFixed(1)},${y.toFixed(1)}`;
    }).join(" ");

    const minLabel = `${Math.round(minV)}${unitText}`;
    const maxLabel = `${Math.round(maxV)}${unitText}`;

    return `
      <svg viewBox="0 0 ${w} ${h}" width="100%" height="100%" preserveAspectRatio="none">
        <polyline points="${pts}" fill="none" stroke="rgba(234,240,255,0.85)" stroke-width="2" />
        <text x="${pad}" y="${pad+14}" fill="rgba(159,176,208,0.9)" font-size="12">${minLabel}</text>
        <text x="${w-pad-50}" y="${pad+14}" fill="rgba(159,176,208,0.9)" font-size="12">${maxLabel}</text>
      </svg>
    `;
  }

  function metricSeries(hours, metric){
    if (metric === "precip") return hours.map(h => h.precip);
    if (metric === "wind") return hours.map(h => h.wind);
    return hours.map(h => h.temp);
  }
  function metricUnit(metric){
    if (metric === "precip") return "mm";
    if (metric === "wind") return "km/h";
    return "¬∞C";
  }

  function renderHourlyForecast(hours){
    const slice = hours.slice(0, 24);
    if (!slice.length){
      return `
        <div class="hourlyWrap">
          <div class="muted">Hourly</div>
          <div class="hint" style="margin-top:8px;">No hourly data for this date.</div>
        </div>
      `;
    }

    const series = metricSeries(slice, state.metric);
    const unit = metricUnit(state.metric);
    const chart = svgSparkline(series, 900, 76, 10, unit === "¬∞C" ? "¬∞" : "");

    const cards = slice.map(h => {
      const hh = h.time.split("T")[1]?.slice(0,5) || "";
      const emoji = weatherCodeToEmoji(h.code);
      const txt = weatherCodeToText(h.code);

      const valTemp = (typeof h.temp === "number") ? `${Math.round(h.temp)}¬∞` : "‚Äî";
      const valPrecip = (typeof h.precip === "number") ? `${h.precip.toFixed(1)}mm` : "‚Äî";
      const valSnow = (typeof h.snow === "number") ? `${h.snow.toFixed(1)}cm` : "‚Äî";
      const valWind = (typeof h.wind === "number") ? `${Math.round(h.wind)}km/h` : "‚Äî";

      let big = valTemp;
      let meta1 = `Wind: ${valWind}`;
      let meta2 = `P: ${valPrecip} ‚Ä¢ S: ${valSnow}`;

      if (state.metric === "precip"){
        big = valPrecip;
        meta1 = `Temp: ${valTemp}`;
        meta2 = `Wind: ${valWind} ‚Ä¢ Snow: ${valSnow}`;
      } else if (state.metric === "wind"){
        big = valWind;
        meta1 = `Temp: ${valTemp}`;
        meta2 = `Precip: ${valPrecip} ‚Ä¢ Snow: ${valSnow}`;
      }

      return `
        <div class="hourCard">
          <div class="hourTop">
            <div class="hourTime">${hh}</div>
            <div class="hourEmoji" title="${txt}">${emoji}</div>
          </div>
          <div class="hourBig">${big}</div>
          <div class="hourMeta">${txt}</div>
          <div class="hourMeta">${meta1}</div>
          <div class="hourMeta">${meta2}</div>
        </div>
      `;
    }).join("");

    return `
      <div class="hourlyWrap">
        <div class="muted">Hourly (24h)</div>

        <div class="hourlyChart">${chart}</div>

        <div class="seg hourlySeg" style="margin-top:10px;">
          <button type="button" data-m="temp" class="${state.metric==="temp"?"active":""}">üå°Ô∏è Temp</button>
          <button type="button" data-m="precip" class="${state.metric==="precip"?"active":""}">üåßÔ∏è Precip</button>
          <button type="button" data-m="wind" class="${state.metric==="wind"?"active":""}">üí® Wind</button>
        </div>

        <div class="hourlyRow">${cards}</div>
      </div>
    `;
  }

  // ========= STATE =========
  const state = {
    tempC: -8,
    date: null,
    metric: "temp",
    outfitMode: "base" // "base" | "shell"
  };

  let selectedLocationId = null;
  let LAST_WEATHER_DATA = null;
  let CURRENT_LOC = null;

  function tempLevel(t){
    if (t <= -12) return "Very cold";
    if (t <= -6) return "Cold";
    if (t <= 0) return "Near freezing";
    return "Mild";
  }

  // ========= AVATAR ENGINE (PNG layers) =========
  const AVATAR_BASE_W = 715;
  const AVATAR_BASE_H = 1138;
  const ASSET = (name) => `./assets/outfit/${name}`;

  function updateAvatarScale(){
    const stage = document.getElementById("avatarStage");
    const canvas = document.getElementById("avatarCanvas");
    if (!stage || !canvas) return;
    const scale = stage.clientWidth / AVATAR_BASE_W;
    canvas.style.transform = `scale(${scale})`;
  }
  window.addEventListener("resize", updateAvatarScale);

  function applyLayer(id, cfg){
    const el = document.getElementById(id);
    if (!el) return;

    if (!cfg || !cfg.src){
      el.style.display = "none";
      el.removeAttribute("src");
      return;
    }
    el.src = cfg.src;
    el.style.display = "";

    el.style.left = `${cfg.x ?? 0}px`;
    el.style.top  = `${cfg.y ?? 0}px`;

    const r = cfg.r ?? 0;
    el.style.transform = `rotate(${r}deg)`;
    el.style.transformOrigin = cfg.origin || "50% 20%";
    el.style.zIndex = `${cfg.z ?? 10}`;
  }

  // ===== Positions (from your Figma notes) =====
  const POS = {
    // ‚úÖ FIXED as you said: light_head x=198 y=48
    head_light:   { src: ASSET("light_head.png"),    x:233,   y:48,     r:0,    z:55, origin:"50% 25%" },
    // head light position was changed because it doesn't correspond to Figma for some reason, so now the standart is x 233, y 48
    base_top:     { src: ASSET("light_base.png"),    x:100,   y:139,    r:0,    z:60, origin:"50% 20%" },

    pants_base:   { src: ASSET("base_pants.png"),    x:132,   y:532,    r:0,    z:20, origin:"50% 20%" },
    pants_medium: { src: ASSET("medium_pants.png"),  x:135,   y:508,    r:0,    z:20, origin:"50% 20%" },

    // Shell pants (windproof)
    pants_shell:  { src: ASSET("heavy_pants_2.png"), x:118.28,y:518.63, r:2.45, z:20, origin:"50% 20%" },

    socks_light:  { src: ASSET("light_socks.png"),   x:100,   y:959,    r:0,    z:10, origin:"50% 20%" },
    socks_heavy:  { src: ASSET("heavy_socks.png"),   x:79,    y:983,    r:0,    z:10, origin:"50% 20%" },

    gloves_light: { src: ASSET("light_gloves.png"),  x:162,   y:540,    r:0,    z:50, origin:"50% 50%" },
    gloves_heavy: { src: ASSET("heavy_gloves.png"),  x:138,   y:515,    r:2.94, z:50, origin:"50% 50%" },

    // Shell jacket (always in Shell tab)
    jacket_light:  { src: ASSET("light_jacket.png"),  x:75.16, y:149.61, r:1.3,  z:80, origin:"50% 20%" },
    jacket_medium: { src: ASSET("medium_jacket.png"), x:85.18, y:173.15, r:1.21, z:80, origin:"50% 20%" },
    jacket_heavy:  { src: ASSET("heavy_jacket.png"),  x:85.81, y:150.07, r:0.47, z:80, origin:"50% 20%" },

    // Hood = sweater (Base tab only)
    hood_01: { src: ASSET("heavy_hood_01.png"), x:88,    y:118,    r: 2.23, z:70, origin:"50% 20%" },
    hood_02: { src: ASSET("heavy_hood_2.png"),  x:52,    y:199,    r:-1.24, z:70, origin:"50% 20%" },
    hood_03: { src: ASSET("heavy_hood_3.png"),  x:74.26, y:188.09, r: 1.19, z:70, origin:"50% 20%" },
  };

  // glove overrides when hood variant is used (your notes)
  const GLOVES_OVERRIDE_BY_HOOD = {
    "heavy_hood_01.png": {
      light: { x:167, y:532, r:0 },
      heavy: { x:142, y:506, r:2.94 }
    },
    "heavy_hood_2.png": {
      light: null,
      heavy: { x:139, y:513, r:2.94 }
    },
    "heavy_hood_3.png": {
      light: { x:164, y:539, r:0 },
      heavy: { x:140, y:514, r:2.94 }
    },
  };

  function setGloves(type, hoodFileNameOrNull){
    const base = (type === "heavy") ? POS.gloves_heavy : POS.gloves_light;

    if (hoodFileNameOrNull){
      const o = GLOVES_OVERRIDE_BY_HOOD[hoodFileNameOrNull];
      if (o){
        const adj = (type === "heavy") ? o.heavy : o.light;
        if (adj){
          const cfg = { ...base, x: adj.x, y: adj.y, r: adj.r ?? base.r };
          applyLayer("layerGloves", cfg);
          return cfg;
        }
      }
    }
    applyLayer("layerGloves", base);
    return base;
  }

  // Choose which hood picture to use when hood is enabled
  // ================= Sweater (hood) selection =================
// NOTE: "hood" = sweater / mid-layer top in your project naming.
//
// ‚úÖ THIS IS THE PLACE TO CHANGE HOW SWEATER VARIANTS DEPEND ON TEMPERATURE.
// If you want to force a specific sweater for testing, set HOOD_FORCE_VARIANT
// to: "heavy_hood_01.png" | "heavy_hood_2.png" | "heavy_hood_3.png"
// and refresh.
let HOOD_FORCE_VARIANT = null;

function chooseHoodVariant(tempC){
  // ===== CHANGE HOOD TEMPERATURE THRESHOLDS HERE =====
  // Sweater (hood_01/02/03) changes with temperature.
  // You can tweak these numbers anytime later.
  if (HOOD_FORCE_VARIANT) return HOOD_FORCE_VARIANT;

  if (tempC <= -12) return "heavy_hood_3.png";   // very cold -> warmest sweater
  if (tempC <= -8)  return "heavy_hood_2.png";   // cold
  return "heavy_hood_01.png";                    // slightly cold (-8..-6)
}
// heavy_hood_01.png | heavy_hood_2.png | heavy_hood_3.png

  /*
    ========= TEMPERATURE -> SELECTION (IMPORTANT, –ø–æ–¥–ø–∏—Å–∞–Ω–æ –∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª) =========

    1) Gloves:
       - temp <= -12  -> heavy_gloves
       - else         -> light_gloves

    2) Socks:
       - temp <= -6   -> heavy_socks
       - else         -> light_socks

    3) Base mode (Base tab):
       - Base top: always ON
       - Hood (sweater): ON when temp <= -6, OFF when temp > -6
       - Pants:
           temp <= -6 -> medium_pants
           else       -> base_pants
       - Jacket: OFF (never)

    4) Shell mode (Shell tab):
       - Jacket:
           temp <= -12 -> heavy_jacket
           temp <= -6  -> medium_jacket
           else        -> light_jacket
       - Shell pants (windproof): always ON (heavy_pants_2)
       - Hood: OFF (never)
       - Base top: OFF (optional, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ ‚Äî –≤–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ –µ—Å–ª–∏ –Ω–∞–¥–æ)
  */
  // ===== Outfit text panel (right side) =====
function renderSet(containerId, items){
  const el = document.getElementById(containerId);
  if (!el) return;
  if (!items || !items.length){
    el.textContent = "‚Äî";
    return;
  }
  el.innerHTML = items.map(it => `
    <div class="setItem">
      <div class="setItemTop">
        <b>${it.title}</b>
        <span class="setFile">${it.file}</span>
      </div>
      <div class="setDesc">${it.desc}</div>
    </div>
  `).join("");
}

function buildBaseSet(tempC){
  const socksFile = (tempC <= -6) ? "heavy_socks.png" : "light_socks.png";
  const glovesFile = (tempC <= -12) ? "heavy_gloves.png" : "light_gloves.png";
  const pantsFile = (tempC <= -6) ? "medium_pants.png" : "base_pants.png";

  const items = [
    { title: "Balaclava", file: "light_head.png",
      desc: "Face + neck protection from wind. Breathable so it doesn‚Äôt get wet inside." },

    { title: "Socks", file: socksFile,
      desc: (tempC <= -6) ? "Warm merino / thermal socks for cold mornings." : "Lighter socks for milder days." },

    { title: "Pants (base/mid)", file: pantsFile,
      desc: (tempC <= -6) ? "Mid-layer pants for insulation (still breathable for touring)." : "Light base pants for mobility and sweat management." },

    { title: "Gloves", file: glovesFile,
      desc: (tempC <= -12) ? "Warm gloves for very cold conditions." : "Lighter gloves for active touring." },
  ];

  // In Base tab you said: either Base top OR Sweater (never together)
  if (tempC <= -6){
    const hoodFile = chooseHoodVariant(tempC);
    items.splice(2, 0, {
      title: "Sweater (mid layer)",
      file: hoodFile,
      desc: "Insulating sweater between base and shell. Auto-selected by temperature (see code comment near chooseHoodVariant)."
    });
  } else {
    items.splice(2, 0, {
      title: "Base top",
      file: "light_base.png",
      desc: "Next-to-skin layer that wicks sweat and dries fast."
    });
  }

  return items;
}

function buildShellSet(tempC){
  const socksFile = (tempC <= -6) ? "heavy_socks.png" : "light_socks.png";
  const glovesFile = (tempC <= -12) ? "heavy_gloves.png" : "light_gloves.png";

  const jacketFile =
    (tempC <= -12) ? "heavy_jacket.png" :
    (tempC <= -6)  ? "medium_jacket.png" :
                     "light_jacket.png";

  return [
    { title: "Balaclava", file: "light_head.png",
      desc: "Still useful under shell hood/helmet in wind and snowfall." },

    { title: "Socks", file: socksFile,
      desc: (tempC <= -6) ? "Warm socks for cold + long exposure." : "Lighter socks for comfort when it‚Äôs warmer." },

    { title: "Shell jacket", file: jacketFile,
      desc: "Windproof layer for descents and storms (selection depends on temperature)." },

    { title: "Shell pants (windproof)", file: "heavy_pants_2.png",
      desc: "Windproof pants for strong wind / snow. Keeps you dry and blocks drafts." },

    { title: "Gloves", file: glovesFile,
      desc: "Shown under the jacket sleeves (z-index). Use warm gloves if very cold." },
  ];
}

function updateOutfitPanels(){
  const locName = CURRENT_LOC ? CURRENT_LOC.name : "‚Äî";
  const dayText = state.date || "‚Äî";

  const elLoc  = document.getElementById("outfitLoc");
  const elDay  = document.getElementById("outfitDay");
  const elTemp = document.getElementById("outfitTemp");
  const elMode = document.getElementById("outfitModeText");

  if (elLoc)  elLoc.textContent = locName;
  if (elDay)  elDay.textContent = dayText;
  if (elTemp) elTemp.textContent = `${state.tempC}¬∞C`;
  if (elMode) elMode.textContent = (state.outfitMode === "base") ? "Base" : "Shell";

  renderSet("setBase", buildBaseSet(state.tempC));
  renderSet("setShell", buildShellSet(state.tempC));
}

function applyOutfit(){
  // Reset everything first (avoid mixing)
  applyLayer("layerHood", null);
  applyLayer("layerShell", null);
  applyLayer("layerBaseTop", null);
  applyLayer("layerPants", null);

  // Always visible (and UNDER sweater/jacket/base top)
  applyLayer("layerHead", POS.head_light);

  // Socks depend on temperature (shown in both sets)
  applyLayer("layerSocks", (state.tempC <= -6) ? POS.socks_heavy : POS.socks_light);

  // Gloves depend on temperature, but stay UNDER tops (see z-index in POS)
  const glovesType = (state.tempC <= -12) ? "heavy" : "light";

  if (state.outfitMode === "base"){
    // BASE TAB:
    // - Pants: base or medium
    applyLayer("layerPants", (state.tempC <= -6) ? POS.pants_medium : POS.pants_base);

    // - Either sweater OR base top (never both)
    let hoodFile = null;
    if (state.tempC <= -6){
      hoodFile = chooseHoodVariant(state.tempC);
      if (hoodFile === "heavy_hood_2.png") applyLayer("layerHood", POS.hood_02);
      else if (hoodFile === "heavy_hood_3.png") applyLayer("layerHood", POS.hood_03);
      else applyLayer("layerHood", POS.hood_01);
    } else {
      applyLayer("layerBaseTop", POS.base_top);
    }

    // Gloves with possible override if sweater variant changes hand cutouts
    setGloves(glovesType, hoodFile);

  } else {
    // SHELL TAB:
    // - Jacket always on (windproof)
    const jacketCfg =
      (state.tempC <= -12) ? POS.jacket_heavy :
      (state.tempC <= -6)  ? POS.jacket_medium :
                             POS.jacket_light;
    applyLayer("layerShell", jacketCfg);

    // - Shell pants always on
    applyLayer("layerPants", POS.pants_shell);

    // Gloves (no sweater override)
    setGloves(glovesType, null);
  }

  updateOutfitPanels();
  updateAvatarScale();
}

function updateSetupUI(){
    document.getElementById("tempVal").textContent = `${state.tempC}¬∞C`;    document.getElementById("levelVal").textContent = `Level: ${tempLevel(state.tempC)}`;
    document.getElementById("modeVal").textContent = `Mode: ${state.outfitMode === "base" ? "Base" : "Shell"}`;

    applyOutfit();
  }

  function wireSetupControls(){
    const tempRange = document.getElementById("tempRange");
    const tabBase = document.getElementById("tabBase");
    const tabShell = document.getElementById("tabShell");

    tempRange.value = state.tempC;

    tempRange.addEventListener("input", () => {
      state.tempC = parseInt(tempRange.value, 10);
      updateSetupUI();
    });

    tabBase.addEventListener("click", () => {
      state.outfitMode = "base";
      tabBase.classList.add("active");
      tabShell.classList.remove("active");
      updateSetupUI();
    });

    tabShell.addEventListener("click", () => {
      state.outfitMode = "shell";
      tabShell.classList.add("active");
      tabBase.classList.remove("active");
      updateSetupUI();
    });

    updateSetupUI();
  }

  // ========= INFO HERO RENDER =========
  function setInfoImage(url){
    const bg = document.getElementById("infoBg");
    if (url) {
      bg.style.backgroundImage = `url('${url}')`;
      bg.style.display = "";
    } else {
      bg.style.backgroundImage = "none";
      bg.style.display = "none";
    }
  }

  function setHeroText(loc){
    document.getElementById("infoTitle").textContent = loc ? loc.name : "Pick a mountain";
    document.getElementById("infoSub").textContent = loc ? `${loc.region}, ${loc.country}` : "Click a marker on the map";

    const pillBase = document.getElementById("pillBase");
    const pillTop = document.getElementById("pillTop");

    if (loc){
      pillBase.style.display = "";
      pillTop.style.display = "";
      pillBase.textContent = `Base: ${loc.base_m}m`;
      pillTop.textContent = `Top: ${loc.top_m}m`;
    } else {
      pillBase.style.display = "none";
      pillTop.style.display = "none";
    }
  }

  // ========= FORECAST RENDER =========
  function renderPanelLoading(){
    document.getElementById("panelBody").innerHTML = `
      <div class="muted">Forecast (Open-Meteo)</div>
      <div class="hint" style="margin-top:10px;">Loading‚Ä¶</div>
    `;
  }

  function wireForecastEvents(){
    const dp = document.getElementById("datePick");
    if (dp){
      dp.onchange = () => {
        state.date = dp.value;
        rerenderForecast(true);
      };
    }

    document.querySelectorAll(".dayCard").forEach(c => {
      c.onclick = () => {
        state.date = c.dataset.date;
        rerenderForecast(true);
        const dp2 = document.getElementById("datePick");
        if (dp2) dp2.value = state.date;
      };
    });

    document.querySelectorAll(".hourlySeg button").forEach(b => {
      b.onclick = () => {
        state.metric = b.dataset.m;
        rerenderForecast(false);
      };
    });
  }

  function rerenderForecast(updateTempFromDaily){
    if (!LAST_WEATHER_DATA || !state.date) return;
    const day = pickDailyByDate(LAST_WEATHER_DATA.daily, state.date);
    renderForecast(day);

    // Auto-set temperature from forecast day (kept)
    if (updateTempFromDaily && day && typeof day.tmin === "number" && typeof day.tmax === "number"){
      state.tempC = Math.round((day.tmin + day.tmax) / 2);
      const range = document.getElementById("tempRange");
      if (range) range.value = state.tempC;
      updateSetupUI();
    }
  }

  function renderForecast(day){
    const body = document.getElementById("panelBody");
    const d = LAST_WEATHER_DATA;
    const dailyTimes = d?.daily?.time || [];

    const minDate = dailyTimes[0] || "";
    const maxDate = dailyTimes[dailyTimes.length - 1] || "";

    const dailyStrip = (dailyTimes.length ? `
      <div class="dailyRow">
        ${dailyTimes.map((dt, i) => {
          const dd = pickDaily(d.daily, i);
          const emo = weatherCodeToEmoji(dd.code);
          const wday = new Date(dt).toLocaleDateString(undefined, { weekday: "short" });
          const active = dt === state.date ? "active" : "";
          const tmax = (typeof dd.tmax === "number") ? Math.round(dd.tmax) : "‚Äî";
          const tmin = (typeof dd.tmin === "number") ? Math.round(dd.tmin) : "‚Äî";
          return `
            <div class="dayCard ${active}" data-date="${dt}">
              <div class="dayName">${wday}</div>
              <div class="dayEmoji">${emo}</div>
              <div class="dayTemps"><b>${tmax}¬∞</b> / ${tmin}¬∞</div>
            </div>
          `;
        }).join("")}
      </div>
    ` : "");

    const controls = `
      <div class="row" style="margin-top:0;">
        <div class="pill">Date</div>
        <input id="datePick" type="date" value="${state.date || ""}" min="${minDate}" max="${maxDate}">
      </div>
      ${dailyStrip}
    `;

    if (!day){
      body.innerHTML = `
        <div class="muted">Forecast (Open-Meteo)</div>
        ${controls}
        <div class="hint" style="margin-top:10px;">No forecast for this date (try another).</div>
      `;
      wireForecastEvents();
      return;
    }

    const base = weatherCodeToText(day.code);
    const emoji = weatherCodeToEmoji(day.code);

    const hours = pickHourlyForDate(d.hourly, day.date);
    const hourlyHtml = renderHourlyForecast(hours);

    body.innerHTML = `
      <div class="muted">Forecast (Open-Meteo)</div>
      ${controls}

      <div class="row" style="margin-top:10px;">
        <div class="pill">${emoji} ${base}</div>
        <div class="pill">Min: ${Math.round(day.tmin)}¬∞C</div>
        <div class="pill">Max: ${Math.round(day.tmax)}¬∞C</div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="pill">Precip: ${day.precip ?? "n/a"} mm</div>
        <div class="pill">Snow: ${day.snow ?? "n/a"} cm</div>
        <div class="pill">Wind max: ${day.windMax ?? "n/a"} km/h</div>
      </div>

      <div class="divider"></div>
      <div class="hint">Tip: date affects outfit temperature suggestion.</div>

      ${hourlyHtml}
    `;

    wireForecastEvents();
  }

  async function updateWeatherFor(loc){
    renderPanelLoading();
    try{
      const data = await getWeather(loc.lat, loc.lon);
      if (selectedLocationId !== loc.id) return;

      LAST_WEATHER_DATA = data;

      const dailyTimes = data.daily?.time || [];
      const today = data.current_weather?.time?.slice(0,10);

      state.date = state.date || today || (dailyTimes[0] ?? null);
      if (dailyTimes.length && state.date && !dailyTimes.includes(state.date)) state.date = dailyTimes[0];

      const day = state.date ? pickDailyByDate(data.daily, state.date) : null;
      renderForecast(day);

      if (day && typeof day.tmin === "number" && typeof day.tmax === "number") {
        state.tempC = Math.round((day.tmin + day.tmax) / 2);
        const range = document.getElementById("tempRange");
        if (range) range.value = state.tempC;
        updateSetupUI();
      }
    }catch(e){
      console.error(e);
      document.getElementById("panelBody").innerHTML = `
        <div class="muted">Forecast (Open-Meteo)</div>
        <div class="hint" style="margin-top:10px;">
          Couldn‚Äôt load forecast. Try refresh (Ctrl+F5).<br/>
          <span class="muted">${e.message}</span>
        </div>
      `;
    }
  }

  function renderLocation(loc){
    selectedLocationId = loc.id;
    CURRENT_LOC = loc;
    setInfoImage(loc.image);
    setHeroText(loc);
    updateSetupUI();
    updateWeatherFor(loc);
  }

  // ========= MARKERS =========
  let LOCATIONS = [];
  function addMarkers(){
    markersLayer.clearLayers();
    LOCATIONS.forEach(loc => {
      const m = L.marker([loc.lat, loc.lon]);
      m.bindPopup(`<b>${loc.name}</b><br>${loc.region}, ${loc.country}`);
      m.on("click", () => renderLocation(loc));
      markersLayer.addLayer(m);
    });
  }

  // ========= INIT =========
  wireSetupControls();
  setHeroText(null);

  (async () => {
    try{
      LOCATIONS = await loadLocations();
      addMarkers();
      const bounds = L.latLngBounds(LOCATIONS.map(l => [l.lat, l.lon]));
      map.fitBounds(bounds.pad(0.2));
      setTimeout(() => map.invalidateSize(), 200);
    }catch(e){
      console.error(e);
      document.getElementById("panelBody").innerHTML = `
        <h2 class="title">Error loading locations</h2>
        <div class="muted">${e.message}</div>
        <div class="hint" style="margin-top:10px;">
          Check that <code>data/locations.geojson</code> exists and is committed.
        </div>
      `;
    }
  })();

  // First paint avatar
  applyOutfit();
  updateAvatarScale();
</script>
</body>
</html>


