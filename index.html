<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meow Meow Land</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --text:#eaf0ff; --muted:#9fb0d0; --line:#24304a; --blue:#2a6dff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      overflow-y:auto;
    }
    header{
      height:56px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      gap:12px;
      position:sticky;
      top:0;
      background:rgba(11,18,32,0.92);
      backdrop-filter: blur(8px);
      z-index: 50;
    }
    header .badge{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px; border-radius:999px;
    }

    /* ===== MAIN GRID ===== */
    .wrap{
      min-height: calc(100vh - 56px);
      display:grid;
      grid-template-columns: 1.15fr 1fr;
      grid-template-rows: 320px auto auto;
      gap:12px;
      padding:12px;
      align-content:start;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      overflow:hidden;
      min-height:0;
    }
    .title{ font-size:18px; margin:0 0 6px 0; }
    .muted{ color:var(--muted); font-size:13px; }
    .hint{ font-size:13px; color:var(--muted); line-height:1.4; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center; }
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:13px;
      color:var(--muted);
      background: rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
      white-space:nowrap;
    }

    /* ===== TOP LEFT: MAP ===== */
    #mapCard{ grid-column:1; grid-row:1; padding:0; }
    #map{ width:100%; height:100%; border-radius:14px; }

    /* ===== TOP RIGHT: INFO ===== */
    #infoCard{ grid-column:2; grid-row:1; padding:0; position:relative; overflow:hidden; }
    .infoHero{
      position:relative;
      height:112px;
      background:#0d1426;
      overflow:hidden;
      border-bottom:1px solid var(--line);
    }
    .infoHero .bg{
      position:absolute;
      inset:0;
      background-size: cover;
      background-position:center;
      filter: blur(6px);
      transform: scale(1.04);
      opacity: 0.75;
    }
    .infoHero .overlay{
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.80));
    }
    .infoHeroContent{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding:12px 14px;
      z-index:2;
    }
    .infoHeroTopRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .infoHeroTitle{
      margin:0;
      font-size:20px;
      font-weight:900;
      text-shadow: 0 6px 30px rgba(0,0,0,0.55);
    }
    .infoHeroSub{
      margin-top:2px;
      color:rgba(234,240,255,0.78);
      font-size:13px;
      text-shadow: 0 6px 30px rgba(0,0,0,0.55);
    }
    .infoBody{ padding:14px; }
    .divider{ height:1px; background:var(--line); margin:12px 0; opacity:0.9; }

    /* Date input */
    #datePick{
      background:rgba(0,0,0,0.18);
      border:1px solid var(--line);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      outline:none;
    }

    /* Metric toggle inside info card */
    .seg{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .seg button{
      flex:1;
      background:transparent;
      border:1px solid var(--line);
      color:var(--muted);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .seg button.active{
      background:rgba(42,109,255,0.18);
      border-color:rgba(42,109,255,0.45);
      color:#dbe8ff;
    }

    /* Hourly "Google-like" */
    .hourlyWrap{
      margin-top:12px;
      border-top:1px solid var(--line);
      padding-top:12px;
    }
    .hourlyChart{
      width:100%;
      height:76px;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(0,0,0,0.12);
      overflow:hidden;
    }
    .hourlyRow{
      margin-top:10px;
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding-bottom:6px;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .hourCard{
      flex:0 0 auto;
      width:96px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:rgba(0,0,0,0.12);
      scroll-snap-align:start;
    }
    .hourTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .hourTime{ font-size:12px; color:var(--muted); }
    .hourEmoji{ font-size:16px; }
    .hourBig{ font-size:18px; font-weight:900; margin-top:8px; }
    .hourMeta{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.2; }

    /* ===== OUTFIT ===== */
    #outfitCard{ grid-column:1 / 3; grid-row:2; }
    .outfitGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:10px;
      align-items:start;
      justify-items:center;
    }
    .avatarBox{
      border:1px dashed var(--line);
      border-radius:14px;
      padding:12px;
      background: rgba(255,255,255,0.02);
      width: 100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap:14px;
    }
    .avatarStage{
      position:relative;
      width: 100%;
      max-width: 820px;
      height: 720px;
      border-radius:12px;
      overflow:hidden;
      background: radial-gradient(circle at 30% 10%, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
    }
    .avatarStage img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      pointer-events:none;
      user-select:none;
    }

    .controlsWrap{
      width: 100%;
      max-width: 820px;
      height:auto;
      border:none;
      border-radius:0;
      padding:0;
      background:transparent;
    }
    .controlsHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .controlsHeaderTitle{ font-weight:900; }
    .toggle{ display:flex; gap:8px; margin-top:10px; }
    .toggle button{
      flex:1;
      background:transparent;
      border:1px solid var(--line);
      color:var(--muted);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
    }
    .toggle button.active{
      background:var(--blue);
      border-color:var(--blue);
      color:#fff;
    }
    .control{ margin-top:12px; }
    .control label{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    input[type="range"]{ width:100%; margin-top:8px; }
    .kpi{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }

    /* ===== LIST ===== */
    #listCard{ grid-column:1 / 3; grid-row:3; overflow:visible; }
    .item{
      display:grid;
      grid-template-columns: 90px 1fr 120px;
      gap:12px;
      padding:10px;
      border:1px solid var(--line);
      border-radius:14px;
      margin-top:10px;
      align-items:center;
    }
    .thumb{ width:90px; height:70px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,0.03); }
    .item h4{ margin:0 0 4px 0; font-size:14px; }
    .item a{
      display:inline-block;
      text-align:center;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(42,109,255,0.15);
      border:1px solid rgba(42,109,255,0.35);
      color:#cfe0ff;
      text-decoration:none;
      font-weight:900;
    }

    /* ===== MOBILE ===== */
    @media (max-width: 980px){
      .wrap{
        grid-template-columns: 1fr;
        grid-template-rows: 260px auto auto auto;
      }
      #mapCard{ grid-column:1; grid-row:1; }
      #infoCard{ grid-column:1; grid-row:2; }
      #outfitCard{ grid-column:1; grid-row:3; }
      #listCard{ grid-column:1; grid-row:4; }

      .avatarStage{ max-width: 720px; height: 560px; }
      .controlsWrap{ max-width: 720px; }
    }
  </style>
</head>

<body>
  <header>
    <div style="font-weight:900;">Ski Touring Gear Finder</div>
    <div class="badge">MVP ‚Ä¢ one page ‚Ä¢ Leaflet</div>
  </header>

  <div class="wrap">
    <!-- MAP -->
    <div class="card" id="mapCard">
      <div id="map"></div>
    </div>

    <!-- INFO -->
    <div class="card" id="infoCard">
      <div class="infoHero">
        <div class="bg" id="infoBg"></div>
        <div class="overlay"></div>

        <div class="infoHeroContent" id="infoHeroContent">
          <div class="infoHeroTopRow">
            <div>
              <h2 class="infoHeroTitle" id="infoTitle">Pick a mountain</h2>
              <div class="infoHeroSub" id="infoSub">Click a marker on the map</div>
            </div>
            <div class="row" style="margin-top:0;">
              <div class="pill" id="pillBase" style="display:none;">Base: ‚Äî</div>
              <div class="pill" id="pillTop" style="display:none;">Top: ‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <div class="infoBody" id="panelBody">
        <div class="muted">Forecast (Open-Meteo)</div>
        <div class="row">
          <div class="pill">Date</div>
          <input id="datePick" type="date">
        </div>
        <div class="seg" role="tablist" aria-label="Hourly chart metric">
          <button id="mTemp" class="active" type="button">üå°Ô∏è Temp</button>
          <button id="mPrecip" type="button">üåßÔ∏è Precip</button>
          <button id="mWind" type="button">üí® Wind</button>
        </div>
        <div class="hint" style="margin-top:10px;">Pick a mountain to load forecast.</div>
      </div>
    </div>

    <!-- OUTFIT -->
    <div class="card" id="outfitCard">
      <h2 class="title">Outfit preview</h2>
      <div class="muted">Base model + layers (later PNG). Controls are inside this card.</div>

      <div class="outfitGrid">
        <div class="avatarBox">
          <div class="avatarStage">
            <img id="charBase" alt="Character base">
            <img id="layerHair" alt="Hair">
            <img id="layerBase" alt="Base layer">
            <img id="layerMid" alt="Mid layer">
            <img id="layerShell" alt="Shell">
            <img id="layerPants" alt="Pants">
            <img id="layerGloves" alt="Gloves">
          </div>

          <div class="controlsWrap" id="controlsWrap">
            <div class="controlsHeader">
              <div>
                <div class="controlsHeaderTitle">Setup</div>
                <div class="muted" style="margin-top:4px;">Sport + temperature (budget hidden for now)</div>
              </div>
              <div class="pill" id="levelVal">Level: Cold</div>
            </div>

            <div class="toggle" role="tablist" aria-label="Sport switch">
              <button id="btnSki" class="active" type="button">Ski</button>
              <button id="btnSnow" type="button">Snowboard</button>
            </div>

            <div class="control">
              <label>
                <span>Temperature</span>
                <span class="pill" id="tempVal">-8¬∞C</span>
              </label>
              <input id="tempRange" type="range" min="-25" max="5" step="1" value="-8">
            </div>

            <div class="kpi">
              <div class="pill" id="sportVal">Sport: Ski</div>
            </div>

            <div class="hint" style="margin-top:12px;">
              Tip: pick a mountain + date to auto-set temperature from forecast.
            </div>
          </div>
        </div>
      </div>

      <div class="hint" style="margin-top:10px;">
        Later: drop PNGs into <code>assets/character/</code> and <code>assets/gear/</code> and we‚Äôll swap layers by logic.
      </div>
    </div>

    <!-- LIST -->
    <div class="card" id="listCard">
      <h2 class="title">Recommended gear</h2>
      <div class="muted">Placeholder list (next: real items + affiliate links).</div>

      <div class="item">
        <div class="thumb"></div>
        <div>
          <h4>Base layer (merino top)</h4>
          <div class="muted">Warm, breathable, next-to-skin.</div>
        </div>
        <a href="#" onclick="return false;">Link</a>
      </div>

      <div class="item">
        <div class="thumb"></div>
        <div>
          <h4>Shell jacket (Gore-Tex style)</h4>
          <div class="muted">Windproof + waterproof protection.</div>
        </div>
        <a href="#" onclick="return false;">Link</a>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="muted">
          Disclaimer (draft): Recommendations are generic and informational only. Always check real weather & avalanche bulletin before touring.
        </div>
      </div>
    </div>
  </div>

<script>
  // ========= LOAD LOCATIONS =========
  async function loadLocations() {
    const res = await fetch("./data/locations.geojson");
    if (!res.ok) throw new Error("Failed to load GeoJSON: " + res.status);
    const geo = await res.json();

    return geo.features.map(f => {
      const p = f.properties;
      const [lon, lat] = f.geometry.coordinates;
      return {
        id: p.id,
        name: p.name,
        region: p.region,
        country: p.country,
        image: p.image || null,
        lat, lon,
        base_m: p.base_m,
        top_m: p.top_m,
        tempProfile: { mild: p.mild, normal: p.normal, cold: p.cold }
      };
    });
  }

  // ========= MAP INIT =========
  const map = L.map("map", { zoomControl:true }).setView([45.5, 6.6], 8);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  const markersLayer = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true });
  map.addLayer(markersLayer);

  setTimeout(() => map.invalidateSize(), 250);

  // ========= WEATHER (Open-Meteo) =========
  const weatherCache = new Map();
  const WEATHER_TTL_MS = 15 * 60 * 1000;
  function cacheKey(lat, lon){ return `${lat.toFixed(3)},${lon.toFixed(3)}`; }

  function weatherCodeToText(code) {
    const m = {
      0:"Clear",1:"Mostly clear",2:"Partly cloudy",3:"Overcast",45:"Fog",48:"Rime fog",
      51:"Light drizzle",53:"Drizzle",55:"Heavy drizzle",
      61:"Light rain",63:"Rain",65:"Heavy rain",
      71:"Light snow",73:"Snow",75:"Heavy snow",
      80:"Rain showers",85:"Snow showers",
      95:"Thunderstorm"
    };
    return m[code] ?? `Weather code ${code}`;
  }

  function weatherCodeToEmoji(code){
    if (code === 0) return "‚òÄÔ∏è";
    if (code === 1) return "üå§Ô∏è";
    if (code === 2) return "‚õÖ";
    if (code === 3) return "‚òÅÔ∏è";
    if (code === 45 || code === 48) return "üå´Ô∏è";
    if (code >= 51 && code <= 55) return "üå¶Ô∏è";
    if (code >= 61 && code <= 65) return "üåßÔ∏è";
    if (code === 80) return "üå¶Ô∏è";
    if (code === 95) return "‚õàÔ∏è";
    if (code === 71 || code === 73 || code === 75) return "‚ùÑÔ∏è";
    if (code === 85) return "üå®Ô∏è";
    return "üå°Ô∏è";
  }

  async function getWeather(lat, lon){
    const key = cacheKey(lat, lon);
    const cached = weatherCache.get(key);
    if (cached && (Date.now() - cached.ts) < WEATHER_TTL_MS) return cached.data;

    const url =
      `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${encodeURIComponent(lat)}` +
      `&longitude=${encodeURIComponent(lon)}` +
      `&current_weather=true` +
      `&hourly=temperature_2m,precipitation,snowfall,windspeed_10m,weathercode` +
      `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,snowfall_sum,windspeed_10m_max,weathercode` +
      `&forecast_days=16` +
      `&timezone=auto`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`Weather API error: ${res.status}`);
    const data = await res.json();
    weatherCache.set(key, { ts: Date.now(), data });
    return data;
  }

  function pickDailyByDate(daily, dateStr){
    const times = daily?.time || [];
    const idx = times.indexOf(dateStr);
    if (idx === -1) return null;
    return {
      date: dateStr,
      tmin: daily.temperature_2m_min?.[idx],
      tmax: daily.temperature_2m_max?.[idx],
      precip: daily.precipitation_sum?.[idx],
      snow: daily.snowfall_sum?.[idx],
      windMax: daily.windspeed_10m_max?.[idx],
      code: daily.weathercode?.[idx],
    };
  }

  function pickHourlyForDate(hourly, dateStr){
    const times = hourly?.time || [];
    const out = [];
    for (let i=0;i<times.length;i++){
      if (times[i].startsWith(dateStr)){
        out.push({
          time: times[i], // "YYYY-MM-DDTHH:MM"
          temp: hourly.temperature_2m?.[i],
          precip: hourly.precipitation?.[i],
          snow: hourly.snowfall?.[i],
          wind: hourly.windspeed_10m?.[i],
          code: hourly.weathercode?.[i],
        });
      }
    }
    return out;
  }

  function svgSparkline(values, w=900, h=76, pad=10, unitText=""){
    const nums = values.filter(v => typeof v === "number" && isFinite(v));
    if (!nums.length) return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="100%"></svg>`;

    const minV = Math.min(...nums);
    const maxV = Math.max(...nums);
    const range = (maxV - minV) || 1;

    const stepX = (w - pad*2) / Math.max(values.length - 1, 1);

    const pts = values.map((v, idx) => {
      const safe = (typeof v === "number" && isFinite(v)) ? v : minV;
      const x = pad + idx * stepX;
      const y = pad + (h - pad*2) * (1 - ((safe - minV) / range));
      return `${x.toFixed(1)},${y.toFixed(1)}`;
    }).join(" ");

    const minLabel = `${Math.round(minV)}${unitText}`;
    const maxLabel = `${Math.round(maxV)}${unitText}`;

    return `
      <svg viewBox="0 0 ${w} ${h}" width="100%" height="100%" preserveAspectRatio="none">
        <polyline points="${pts}" fill="none" stroke="rgba(234,240,255,0.85)" stroke-width="2" />
        <text x="${pad}" y="${pad+14}" fill="rgba(159,176,208,0.9)" font-size="12">${minLabel}</text>
        <text x="${w-pad-50}" y="${pad+14}" fill="rgba(159,176,208,0.9)" font-size="12">${maxLabel}</text>
      </svg>
    `;
  }

  function metricSeries(hours, metric){
    if (metric === "precip") return hours.map(h => h.precip);
    if (metric === "wind") return hours.map(h => h.wind);
    return hours.map(h => h.temp);
  }

  function metricUnit(metric){
    if (metric === "precip") return "mm";
    if (metric === "wind") return "km/h";
    return "¬∞C";
  }

  function renderHourlyForecast(hours, metric){
    const slice = hours.slice(0, 24);
    if (!slice.length){
      return `
        <div class="hourlyWrap">
          <div class="muted">Hourly</div>
          <div class="hint" style="margin-top:8px;">No hourly data for this date.</div>
        </div>
      `;
    }

    const series = metricSeries(slice, metric);
    const unit = metricUnit(metric);
    const chart = svgSparkline(series, 900, 76, 10, unit === "¬∞C" ? "¬∞" : "");

    const cards = slice.map(h => {
      const hh = h.time.split("T")[1]?.slice(0,5) || "";
      const emoji = weatherCodeToEmoji(h.code);
      const txt = weatherCodeToText(h.code);

      const valTemp = (typeof h.temp === "number") ? `${Math.round(h.temp)}¬∞` : "‚Äî";
      const valPrecip = (typeof h.precip === "number") ? `${h.precip.toFixed(1)}mm` : "‚Äî";
      const valSnow = (typeof h.snow === "number") ? `${h.snow.toFixed(1)}cm` : "‚Äî";
      const valWind = (typeof h.wind === "number") ? `${Math.round(h.wind)}km/h` : "‚Äî";

      let big = valTemp;
      let meta1 = `Wind: ${valWind}`;
      let meta2 = `P: ${valPrecip} ‚Ä¢ S: ${valSnow}`;

      if (metric === "precip"){
        big = valPrecip;
        meta1 = `Temp: ${valTemp}`;
        meta2 = `Wind: ${valWind} ‚Ä¢ Snow: ${valSnow}`;
      } else if (metric === "wind"){
        big = valWind;
        meta1 = `Temp: ${valTemp}`;
        meta2 = `Precip: ${valPrecip} ‚Ä¢ Snow: ${valSnow}`;
      }

      return `
        <div class="hourCard">
          <div class="hourTop">
            <div class="hourTime">${hh}</div>
            <div class="hourEmoji" title="${txt}">${emoji}</div>
          </div>
          <div class="hourBig">${big}</div>
          <div class="hourMeta">${txt}</div>
          <div class="hourMeta">${meta1}</div>
          <div class="hourMeta">${meta2}</div>
        </div>
      `;
    }).join("");

    return `
      <div class="hourlyWrap">
        <div class="muted">Hourly (24h)</div>
        <div class="hourlyChart">${chart}</div>
        <div class="hourlyRow">${cards}</div>
      </div>
    `;
  }

  // ========= STATE (Controls) =========
  const state = { sport:"ski", tempC:-8, budget:800, date:null, metric:"temp" };
  let selectedLocationId = null;
  let LAST_WEATHER_DATA = null;

  function tempLevel(t){
    if (t <= -12) return "Very cold";
    if (t <= -6) return "Cold";
    if (t <= 0) return "Near freezing";
    return "Mild";
  }

  function updateSetupUI(){
    document.getElementById("tempVal").textContent = `${state.tempC}¬∞C`;
    document.getElementById("sportVal").textContent = `Sport: ${state.sport === "ski" ? "Ski" : "Snowboard"}`;
    document.getElementById("levelVal").textContent = `Level: ${tempLevel(state.tempC)}`;
  }

  function wireSetupControls(){
    const tempRange = document.getElementById("tempRange");
    const btnSki = document.getElementById("btnSki");
    const btnSnow = document.getElementById("btnSnow");

    tempRange.value = state.tempC;

    tempRange.addEventListener("input", () => {
      state.tempC = parseInt(tempRange.value, 10);
      updateSetupUI();
    });

    btnSki.addEventListener("click", () => {
      state.sport = "ski";
      btnSki.classList.add("active");
      btnSnow.classList.remove("active");
      updateSetupUI();
    });

    btnSnow.addEventListener("click", () => {
      state.sport = "snow";
      btnSnow.classList.add("active");
      btnSki.classList.remove("active");
      updateSetupUI();
    });

    updateSetupUI();
  }

  function setMetricUI(){
    const bT = document.getElementById("mTemp");
    const bP = document.getElementById("mPrecip");
    const bW = document.getElementById("mWind");
    if (!bT || !bP || !bW) return;
    bT.classList.toggle("active", state.metric === "temp");
    bP.classList.toggle("active", state.metric === "precip");
    bW.classList.toggle("active", state.metric === "wind");
  }

  function wireMetricButtons(){
    const bT = document.getElementById("mTemp");
    const bP = document.getElementById("mPrecip");
    const bW = document.getElementById("mWind");
    if (!bT || !bP || !bW) return;

    bT.onclick = () => { state.metric = "temp"; setMetricUI(); rerenderForecast(); };
    bP.onclick = () => { state.metric = "precip"; setMetricUI(); rerenderForecast(); };
    bW.onclick = () => { state.metric = "wind"; setMetricUI(); rerenderForecast(); };

    setMetricUI();
  }

  function wireDatePicker(){
    const el = document.getElementById("datePick");
    if (!el) return;

    if (state.date && !el.value) el.value = state.date;

    el.onchange = () => {
      state.date = el.value;
      rerenderForecast(true);
    };
  }

  function rerenderForecast(updateTempFromDaily=false){
    if (!LAST_WEATHER_DATA || !state.date) return;

    const day = pickDailyByDate(LAST_WEATHER_DATA.daily, state.date);
    renderForecast(day);

    if (updateTempFromDaily && day && typeof day.tmin === "number" && typeof day.tmax === "number"){
      state.tempC = Math.round((day.tmin + day.tmax) / 2);
      const range = document.getElementById("tempRange");
      if (range) range.value = state.tempC;
      updateSetupUI();
    }
  }

  function renderForecast(day){
    const body = document.getElementById("panelBody");

    const dateRow = `
      <div class="row">
        <div class="pill">Date</div>
        <input id="datePick" type="date" value="${state.date || ""}">
      </div>
      <div class="seg" role="tablist" aria-label="Hourly chart metric">
        <button id="mTemp" type="button">üå°Ô∏è Temp</button>
        <button id="mPrecip" type="button">üåßÔ∏è Precip</button>
        <button id="mWind" type="button">üí® Wind</button>
      </div>
    `;

    if (!day){
      body.innerHTML = `
        <div class="muted">Forecast (Open-Meteo)</div>
        ${dateRow}
        <div class="hint" style="margin-top:10px;">No forecast for this date (try another).</div>
      `;
      wireDatePicker();
      wireMetricButtons();
      setMetricUI();
      return;
    }

    const base = weatherCodeToText(day.code);
    const emoji = weatherCodeToEmoji(day.code);

    // hourly block
    const hours = pickHourlyForDate(LAST_WEATHER_DATA.hourly, day.date);
    const hourlyHtml = renderHourlyForecast(hours, state.metric);

    body.innerHTML = `
      <div class="muted">Forecast (Open-Meteo)</div>
      ${dateRow}

      <div class="row" style="margin-top:10px;">
        <div class="pill">${emoji} ${base}</div>
        <div class="pill">Min: ${Math.round(day.tmin)}¬∞C</div>
        <div class="pill">Max: ${Math.round(day.tmax)}¬∞C</div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="pill">Precip: ${day.precip ?? "n/a"} mm</div>
        <div class="pill">Snow: ${day.snow ?? "n/a"} cm</div>
        <div class="pill">Wind max: ${day.windMax ?? "n/a"} km/h</div>
      </div>

      <div class="divider"></div>
      <div class="hint">Tip: date affects outfit temperature suggestion.</div>

      ${hourlyHtml}
    `;

    wireDatePicker();
    wireMetricButtons();
    setMetricUI();
  }

  // ========= INFO HERO RENDER =========
  function setInfoImage(url){
    const bg = document.getElementById("infoBg");
    if (url) {
      bg.style.backgroundImage = `url('${url}')`;
      bg.style.display = "";
    } else {
      bg.style.backgroundImage = "none";
      bg.style.display = "none";
    }
  }

  function setHeroText(loc){
    document.getElementById("infoTitle").textContent = loc ? loc.name : "Pick a mountain";
    document.getElementById("infoSub").textContent = loc ? `${loc.region}, ${loc.country}` : "Click a marker on the map";

    const pillBase = document.getElementById("pillBase");
    const pillTop = document.getElementById("pillTop");

    if (loc){
      pillBase.style.display = "";
      pillTop.style.display = "";
      pillBase.textContent = `Base: ${loc.base_m}m`;
      pillTop.textContent = `Top: ${loc.top_m}m`;
    } else {
      pillBase.style.display = "none";
      pillTop.style.display = "none";
    }
  }

  function renderPanelLoading(){
    const body = document.getElementById("panelBody");
    body.innerHTML = `
      <div class="muted">Forecast (Open-Meteo)</div>
      <div class="row">
        <div class="pill">Date</div>
        <input id="datePick" type="date" value="${state.date || ""}">
      </div>
      <div class="seg" role="tablist" aria-label="Hourly chart metric">
        <button id="mTemp" type="button">üå°Ô∏è Temp</button>
        <button id="mPrecip" type="button">üåßÔ∏è Precip</button>
        <button id="mWind" type="button">üí® Wind</button>
      </div>
      <div class="hint" style="margin-top:10px;">Loading‚Ä¶</div>
    `;
    wireDatePicker();
    wireMetricButtons();
    setMetricUI();
  }

  function renderPanelError(msg){
    const body = document.getElementById("panelBody");
    body.innerHTML = `
      <div class="muted">Forecast (Open-Meteo)</div>
      <div class="row">
        <div class="pill">Date</div>
        <input id="datePick" type="date" value="${state.date || ""}">
      </div>
      <div class="seg" role="tablist" aria-label="Hourly chart metric">
        <button id="mTemp" type="button">üå°Ô∏è Temp</button>
        <button id="mPrecip" type="button">üåßÔ∏è Precip</button>
        <button id="mWind" type="button">üí® Wind</button>
      </div>
      <div class="hint" style="margin-top:10px;">
        Couldn‚Äôt load forecast. Try refresh (Ctrl+F5).<br/>
        <span class="muted">${msg}</span>
      </div>
    `;
    wireDatePicker();
    wireMetricButtons();
    setMetricUI();
  }

  async function updateWeatherFor(loc){
    renderPanelLoading();
    try{
      const data = await getWeather(loc.lat, loc.lon);
      if (selectedLocationId !== loc.id) return;

      LAST_WEATHER_DATA = data;

      // set min/max for date picker from daily range
      const dailyTimes = data.daily?.time || [];
      const today = data.current_weather?.time?.slice(0,10);
      state.date = state.date || today || (dailyTimes[0] ?? null);

      if (dailyTimes.length && state.date && !dailyTimes.includes(state.date)) {
        state.date = dailyTimes[0];
      }

      // render forecast (daily + hourly)
      const day = state.date ? pickDailyByDate(data.daily, state.date) : null;
      renderForecast(day);

      // set input min/max after render
      const dp = document.getElementById("datePick");
      if (dp && dailyTimes.length){
        dp.min = dailyTimes[0];
        dp.max = dailyTimes[dailyTimes.length - 1];
      }

      // auto-set outfit temperature from daily avg
      if (day && typeof day.tmin === "number" && typeof day.tmax === "number") {
        state.tempC = Math.round((day.tmin + day.tmax) / 2);
        document.getElementById("tempRange").value = state.tempC;
        updateSetupUI();
      }

    }catch(e){
      console.error(e);
      renderPanelError(e.message);
    }
  }

  function renderLocation(loc){
    selectedLocationId = loc.id;
    setInfoImage(loc.image);
    setHeroText(loc);
    updateWeatherFor(loc);
  }

  // ========= MARKERS =========
  let LOCATIONS = [];
  function addMarkers(){
    markersLayer.clearLayers();
    LOCATIONS.forEach(loc => {
      const m = L.marker([loc.lat, loc.lon]);
      m.bindPopup(`<b>${loc.name}</b><br>${loc.region}, ${loc.country}`);
      m.on("click", () => renderLocation(loc));
      markersLayer.addLayer(m);
    });
  }

  // ========= INIT =========
  wireSetupControls();
  setHeroText(null);
  wireMetricButtons();
  wireDatePicker();

  (async () => {
    try{
      LOCATIONS = await loadLocations();
      addMarkers();
      const bounds = L.latLngBounds(LOCATIONS.map(l => [l.lat, l.lon]));
      map.fitBounds(bounds.pad(0.2));
      setTimeout(() => map.invalidateSize(), 200);
    }catch(e){
      console.error(e);
      document.getElementById("panelBody").innerHTML = `
        <h2 class="title">Error loading locations</h2>
        <div class="muted">${e.message}</div>
        <div class="hint" style="margin-top:10px;">
          Check that <code>data/locations.geojson</code> exists and is committed.
        </div>
      `;
    }
  })();

  // ========= AVATAR PLACEHOLDER =========
  function setAvatarSrc(id, src){
    const el = document.getElementById(id);
    if (!el) return;
    if (!src) { el.style.display = 'none'; el.removeAttribute('src'); return; }
    el.src = src;
    el.style.display = '';
  }

  setAvatarSrc("charBase", "");
  setAvatarSrc("layerHair", "");
  setAvatarSrc("layerBase", "");
  setAvatarSrc("layerMid", "");
  setAvatarSrc("layerShell", "");
  setAvatarSrc("layerPants", "");
  setAvatarSrc("layerGloves", "");
</script>
</body>
</html>


