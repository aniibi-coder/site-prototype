<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ski Touring Gear Finder</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --text:#eaf0ff; --muted:#9fb0d0; --line:#24304a; --blue:#2a6dff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      /* важно: НЕ фиксируем высоту, чтобы была прокрутка */
      overflow-y:auto;
    }
    header{
      height:56px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      gap:12px;
      position:sticky;
      top:0;
      background:rgba(11,18,32,0.92);
      backdrop-filter: blur(8px);
      z-index: 50;
    }
    header .badge{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px; border-radius:999px;
    }

    /* ===== MAIN GRID ===== */
    .wrap{
      min-height: calc(100vh - 56px);
      display:grid;
      grid-template-columns: 1.15fr 1fr;
      grid-template-rows: 320px auto auto;
      gap:12px;
      padding:12px;
      align-content:start;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      overflow:hidden;
      min-height:0;
    }
    .title{ font-size:18px; margin:0 0 6px 0; }
    .muted{ color:var(--muted); font-size:13px; }
    .hint{ font-size:13px; color:var(--muted); line-height:1.4; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:13px;
      color:var(--muted);
      background: rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
    }

    /* ===== TOP LEFT: MAP ===== */
    #mapCard{ grid-column:1; grid-row:1; padding:0; }
    #map{ width:100%; height:100%; border-radius:14px; }

    /* ===== TOP RIGHT: INFO (image fill + text overlay) ===== */
    #infoCard{ grid-column:2; grid-row:1; padding:0; position:relative; overflow:hidden; }

    /* шапка с картинкой (меньше на ~25%: было 150px -> 112px) */
    .infoHero{
      position:relative;
      height:112px;
      background:#0d1426;
      overflow:hidden;
      border-bottom:1px solid var(--line);
    }
    .infoHero .bg{
      position:absolute;
      inset:0;
      background-size: cover;
      background-position:center;
      filter: blur(6px);         /* blur меньше */
      transform: scale(1.04);    /* меньше scale */
      opacity: 0.75;
    }
    .infoHero .overlay{
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.80));
    }

    /* ВАЖНО: текст и плашки ПОВЕРХ картинки */
    .infoHeroContent{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding:12px 14px;
      z-index:2;
    }
    .infoHeroTopRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .infoHeroTitle{
      margin:0;
      font-size:20px;
      font-weight:900;
      text-shadow: 0 6px 30px rgba(0,0,0,0.55);
    }
    .infoHeroSub{
      margin-top:2px;
      color:rgba(234,240,255,0.78);
      font-size:13px;
      text-shadow: 0 6px 30px rgba(0,0,0,0.55);
    }

    /* контент под шапкой */
    .infoBody{ padding:14px; }
    .divider{ height:1px; background:var(--line); margin:12px 0; opacity:0.9; }

    /* ===== MIDDLE: OUTFIT (FULL WIDTH, TALLER) ===== */
    #outfitCard{ grid-column:1 / 3; grid-row:2; }
    .outfitGrid{
      display:grid;
      grid-template-columns: 1fr 520px;
      gap:12px;
      margin-top:10px;
      align-items:stretch;
    }

    .avatarBox{
      border:1px dashed var(--line);
      border-radius:14px;
      padding:12px;
      background: rgba(255,255,255,0.02);
      /* тут мы увеличиваем превью вниз */
      min-height: 940px;  /* было ~320 -> делаем сильно больше */
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .avatarStage{
      position:relative;
      width: 100%;
      max-width: 700px;
      height: 100%;
      border-radius:12px;
      overflow:hidden;
      background: radial-gradient(circle at 30% 10%, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
    }
    .avatarStage img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      pointer-events:none;
      user-select:none;
    }

    /* setup внутри outfit */
    .setupBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background: rgba(255,255,255,0.02);
      height:100%;
    }
    .control{ margin-top:10px; }
    .control label{
      display:flex; justify-content:space-between; align-items:center;
      font-size:13px; color:var(--muted);
    }
    input[type="range"]{ width:100%; margin-top:8px; }

    .toggle{ display:flex; gap:8px; margin-top:10px; }
    .toggle button{
      flex:1;
      width:auto;
      margin-top:0;
      background:transparent;
      border:1px solid var(--line);
      color:var(--muted);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
    }
    .toggle button.active{
      background:var(--blue);
      border-color:var(--blue);
      color:#fff;
    }
    .kpi{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    /* ===== BOTTOM: LIST (FULL WIDTH) ===== */
    #listCard{ grid-column:1 / 3; grid-row:3; overflow:visible; }
    .item{
      display:grid;
      grid-template-columns: 90px 1fr 120px;
      gap:12px;
      padding:10px;
      border:1px solid var(--line);
      border-radius:14px;
      margin-top:10px;
      align-items:center;
    }
    .thumb{ width:90px; height:70px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,0.03); }
    .item h4{ margin:0 0 4px 0; font-size:14px; }
    .item a{
      display:inline-block;
      text-align:center;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(42,109,255,0.15);
      border:1px solid rgba(42,109,255,0.35);
      color:#cfe0ff;
      text-decoration:none;
      font-weight:900;
    }

    /* ===== MOBILE ===== */
    @media (max-width: 980px){
      .wrap{
        grid-template-columns: 1fr;
        grid-template-rows: 260px auto auto auto;
      }
      #mapCard{ grid-column:1; grid-row:1; }
      #infoCard{ grid-column:1; grid-row:2; }
      #outfitCard{ grid-column:1; grid-row:3; }
      #listCard{ grid-column:1; grid-row:4; }

      .outfitGrid{ grid-template-columns: 1fr; }
      .avatarBox{ min-height: 480px; }
    }
  </style>
</head>

<body>
  <header>
    <div style="font-weight:900;">Ski Touring Gear Finder</div>
    <div class="badge">MVP • one page • Leaflet</div>
  </header>

  <div class="wrap">
    <!-- MAP -->
    <div class="card" id="mapCard">
      <div id="map"></div>
    </div>

    <!-- INFO -->
    <div class="card" id="infoCard">
      <div class="infoHero">
        <div class="bg" id="infoBg"></div>
        <div class="overlay"></div>

        <!-- overlay text -->
        <div class="infoHeroContent" id="infoHeroContent">
          <div class="infoHeroTopRow">
            <div>
              <h2 class="infoHeroTitle" id="infoTitle">Pick a mountain</h2>
              <div class="infoHeroSub" id="infoSub">Click a marker on the map</div>
            </div>
            <div class="row" style="margin-top:0;">
              <div class="pill" id="pillBase" style="display:none;">Base: —</div>
              <div class="pill" id="pillTop" style="display:none;">Top: —</div>
            </div>
          </div>
        </div>
      </div>

      <div class="infoBody" id="panelBody">
        <div class="muted">Live weather (Open-Meteo)</div>
        <div class="hint" style="margin-top:6px;">Pick a mountain to load live weather.</div>
      </div>
    </div>

    <!-- OUTFIT -->
    <div class="card" id="outfitCard">
      <h2 class="title">Outfit preview</h2>
      <div class="muted">Base model + layers (later PNG). Controls are inside this card.</div>

      <div class="outfitGrid">
        <!-- avatar -->
        <div class="avatarBox">
          <div class="avatarStage">
            <img id="charBase" alt="Character base">
            <img id="layerHair" alt="Hair">
            <img id="layerBase" alt="Base layer">
            <img id="layerMid" alt="Mid layer">
            <img id="layerShell" alt="Shell">
            <img id="layerPants" alt="Pants">
            <img id="layerGloves" alt="Gloves">
          </div>
        </div>

        <!-- setup -->
        <div class="setupBox" id="controlsCard">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div style="font-weight:900;">Setup</div>
            <div class="pill" id="levelVal">Level: Cold • Mid</div>
          </div>

          <div class="toggle" role="tablist" aria-label="Sport switch">
            <button id="btnSki" class="active" type="button">Ski</button>
            <button id="btnSnow" type="button">Snowboard</button>
          </div>

          <div class="control">
            <label>
              <span>Temperature</span>
              <span class="pill" id="tempVal">-8°C</span>
            </label>
            <input id="tempRange" type="range" min="-25" max="5" step="1" value="-8">
          </div>

          <div class="control">
            <label>
              <span>Budget</span>
              <span class="pill" id="budgetVal">€800</span>
            </label>
            <input id="budgetRange" type="range" min="300" max="2000" step="50" value="800">
          </div>

          <div class="kpi">
            <div class="pill" id="sportVal">Sport: Ski</div>
            <div class="pill" id="budgetTierVal">Budget: Mid</div>
          </div>

          <div class="hint" style="margin-top:10px;">
            Tip: when you click a mountain, we auto-set temperature from live weather.
          </div>
        </div>
      </div>

      <div class="hint" style="margin-top:10px;">
        Later: drop PNGs into <code>assets/character/</code> and <code>assets/gear/</code> and we’ll swap layers by logic.
      </div>
    </div>

    <!-- LIST -->
    <div class="card" id="listCard">
      <h2 class="title">Recommended gear</h2>
      <div class="muted">Placeholder list (next: real items + affiliate links).</div>

      <div class="item">
        <div class="thumb"></div>
        <div>
          <h4>Base layer (merino top)</h4>
          <div class="muted">Warm, breathable, next-to-skin.</div>
        </div>
        <a href="#" onclick="return false;">Link</a>
      </div>

      <div class="item">
        <div class="thumb"></div>
        <div>
          <h4>Shell jacket (Gore-Tex style)</h4>
          <div class="muted">Windproof + waterproof protection.</div>
        </div>
        <a href="#" onclick="return false;">Link</a>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="muted">
          Disclaimer (draft): Recommendations are generic and informational only. Always check real weather & avalanche bulletin before touring.
        </div>
      </div>
    </div>
  </div>

<script>
  // ========= LOAD LOCATIONS =========
  async function loadLocations() {
    const res = await fetch("./data/locations.geojson");
    if (!res.ok) throw new Error("Failed to load GeoJSON: " + res.status);
    const geo = await res.json();

    return geo.features.map(f => {
      const p = f.properties;
      const [lon, lat] = f.geometry.coordinates;
      return {
        id: p.id,
        name: p.name,
        region: p.region,
        country: p.country,
        image: p.image || null,
        lat, lon,
        base_m: p.base_m,
        top_m: p.top_m,
        tempProfile: { mild: p.mild, normal: p.normal, cold: p.cold }
      };
    });
  }

  // ========= MAP INIT =========
  const map = L.map("map", { zoomControl:true }).setView([45.5, 6.6], 8);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  const markersLayer = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true });
  map.addLayer(markersLayer);

  // Leaflet иногда нужно “перепосчитать размер” внутри grid
  setTimeout(() => map.invalidateSize(), 250);

  // ========= WEATHER (Open-Meteo) =========
  const weatherCache = new Map();
  const WEATHER_TTL_MS = 15 * 60 * 1000;
  function cacheKey(lat, lon){ return `${lat.toFixed(3)},${lon.toFixed(3)}`; }

  function weatherCodeToText(code) {
    const m = {
      0:"Clear",1:"Mostly clear",2:"Partly cloudy",3:"Overcast",45:"Fog",48:"Rime fog",
      51:"Light drizzle",53:"Drizzle",55:"Heavy drizzle",
      61:"Light rain",63:"Rain",65:"Heavy rain",
      71:"Light snow",73:"Snow",75:"Heavy snow",
      80:"Rain showers",85:"Snow showers",
      95:"Thunderstorm"
    };
    return m[code] ?? `Weather code ${code}`;
  }
  function degToCompass(deg){
    const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
    const i = Math.round((deg % 360)/22.5) % 16;
    return dirs[i];
  }

  async function getWeather(lat, lon){
    const key = cacheKey(lat, lon);
    const cached = weatherCache.get(key);
    if (cached && (Date.now() - cached.ts) < WEATHER_TTL_MS) return cached.data;

    const url =
      `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${encodeURIComponent(lat)}` +
      `&longitude=${encodeURIComponent(lon)}` +
      `&current_weather=true` +
      `&hourly=precipitation,snowfall,cloudcover` +
      `&timezone=auto`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`Weather API error: ${res.status}`);
    const data = await res.json();
    weatherCache.set(key, { ts: Date.now(), data });
    return data;
  }

  function pickHourlyAtTime(hourly, targetTimeStr){
    const times = hourly?.time || [];
    const idx = times.indexOf(targetTimeStr);
    if (idx === -1) return null;
    return {
      precipitation: hourly.precipitation?.[idx] ?? null,
      snowfall: hourly.snowfall?.[idx] ?? null,
      cloudcover: hourly.cloudcover?.[idx] ?? null
    };
  }

  function deriveConditions(current, hourlyAt){
    const temp = current.temperature;
    const wind = current.windspeed;
    const base = weatherCodeToText(current.weathercode);

    const snow = hourlyAt?.snowfall ?? 0;
    const rain = hourlyAt?.precipitation ?? 0;
    const cloud = hourlyAt?.cloudcover ?? null;

    let tags = [];
    if (snow >= 0.2) tags.push("Snowfall");
    else if (rain >= 0.5) tags.push("Wet");

    if (wind >= 35) tags.push("Very windy");
    else if (wind >= 20) tags.push("Windy");

    if (temp <= -12) tags.push("Very cold");
    else if (temp <= -6) tags.push("Cold");
    else if (temp <= 0) tags.push("Near freezing");
    else tags.push("Mild");

    if (cloud !== null){
      if (cloud >= 80) tags.push("Overcast");
      else if (cloud >= 40) tags.push("Cloudy");
      else tags.push("Sunny-ish");
    }
    return { base, tags };
  }

  // ========= STATE (Controls) =========
  const state = { sport:"ski", tempC:-8, budget:800 };
  let selectedLocationId = null;

  function budgetTier(b){
    if (b < 600) return "Low";
    if (b < 1200) return "Mid";
    return "High";
  }
  function tempLevel(t){
    if (t <= -12) return "Very cold";
    if (t <= -6) return "Cold";
    if (t <= 0) return "Near freezing";
    return "Mild";
  }

  function updateSetupUI(){
    document.getElementById("tempVal").textContent = `${state.tempC}°C`;
    document.getElementById("budgetVal").textContent = `€${state.budget}`;
    document.getElementById("sportVal").textContent = `Sport: ${state.sport === "ski" ? "Ski" : "Snowboard"}`;
    document.getElementById("budgetTierVal").textContent = `Budget: ${budgetTier(state.budget)}`;
    document.getElementById("levelVal").textContent = `Level: ${tempLevel(state.tempC)} • ${budgetTier(state.budget)}`;
    // TODO next: updateOutfitPreview(state)
  }

  function wireSetupControls(){
    const tempRange = document.getElementById("tempRange");
    const budgetRange = document.getElementById("budgetRange");
    const btnSki = document.getElementById("btnSki");
    const btnSnow = document.getElementById("btnSnow");

    tempRange.value = state.tempC;
    budgetRange.value = state.budget;

    tempRange.addEventListener("input", () => {
      state.tempC = parseInt(tempRange.value, 10);
      updateSetupUI();
    });

    budgetRange.addEventListener("input", () => {
      state.budget = parseInt(budgetRange.value, 10);
      updateSetupUI();
    });

    btnSki.addEventListener("click", () => {
      state.sport = "ski";
      btnSki.classList.add("active");
      btnSnow.classList.remove("active");
      updateSetupUI();
    });

    btnSnow.addEventListener("click", () => {
      state.sport = "snow";
      btnSnow.classList.add("active");
      btnSki.classList.remove("active");
      updateSetupUI();
    });

    updateSetupUI();
  }

  // ========= INFO RENDER =========
  function setInfoImage(url){
    const bg = document.getElementById("infoBg");
    if (url) {
      bg.style.backgroundImage = `url('${url}')`;
      bg.style.display = "";
    } else {
      bg.style.backgroundImage = "none";
      bg.style.display = "none";
    }
  }

  function setHeroText(loc){
    document.getElementById("infoTitle").textContent = loc ? loc.name : "Pick a mountain";
    document.getElementById("infoSub").textContent = loc ? `${loc.region}, ${loc.country}` : "Click a marker on the map";

    const pillBase = document.getElementById("pillBase");
    const pillTop = document.getElementById("pillTop");

    if (loc){
      pillBase.style.display = "";
      pillTop.style.display = "";
      pillBase.textContent = `Base: ${loc.base_m}m`;
      pillTop.textContent = `Top: ${loc.top_m}m`;
    } else {
      pillBase.style.display = "none";
      pillTop.style.display = "none";
    }
  }

  function renderPanelBodyLoading(){
    const body = document.getElementById("panelBody");
    body.innerHTML = `
      <div class="muted">Live weather (Open-Meteo)</div>
      <div class="hint" style="margin-top:6px;">Loading…</div>
    `;
  }

  function renderPanelBodyWeather(current, hourlyAt, cond){
    const windDir = degToCompass(current.winddirection);
    const precip = hourlyAt?.precipitation;
    const snow = hourlyAt?.snowfall;
    const cloud = hourlyAt?.cloudcover;

    const body = document.getElementById("panelBody");
    body.innerHTML = `
      <div class="muted">Live weather (Open-Meteo)</div>

      <div class="row" style="margin-top:10px;">
        <div class="pill">Temp: ${Math.round(current.temperature)}°C</div>
        <div class="pill">Wind: ${Math.round(current.windspeed)} km/h ${windDir}</div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="pill">${cond.base}</div>
        ${cond.tags.map(t => `<div class="pill">${t}</div>`).join("")}
      </div>

      <div class="divider"></div>

      <div class="hint">
        ${precip != null ? `Precip: ${precip} mm/h` : "Precip: n/a"} •
        ${snow != null ? `Snow: ${snow} cm/h` : "Snow: n/a"} •
        ${cloud != null ? `Cloud: ${cloud}%` : "Cloud: n/a"}<br/>
        Updated: ${current.time}
      </div>
    `;
  }

  function renderPanelBodyError(msg){
    const body = document.getElementById("panelBody");
    body.innerHTML = `
      <div class="muted">Live weather (Open-Meteo)</div>
      <div class="hint" style="margin-top:6px;">
        Couldn’t load weather. Try refresh (Ctrl+F5).<br/>
        <span class="muted">${msg}</span>
      </div>
    `;
  }

  async function updateWeatherFor(loc){
    renderPanelBodyLoading();
    try{
      const data = await getWeather(loc.lat, loc.lon);
      if (selectedLocationId !== loc.id) return;

      const current = data.current_weather;
      const hourlyAt = pickHourlyAtTime(data.hourly, current.time);
      const cond = deriveConditions(current, hourlyAt);

      // auto-sync temperature slider
      state.tempC = Math.round(current.temperature);
      document.getElementById("tempRange").value = state.tempC;
      updateSetupUI();

      renderPanelBodyWeather(current, hourlyAt, cond);
    }catch(e){
      console.error(e);
      renderPanelBodyError(e.message);
    }
  }

  function renderLocation(loc){
    selectedLocationId = loc.id;
    setInfoImage(loc.image);
    setHeroText(loc);
    updateWeatherFor(loc);
  }

  // ========= MARKERS =========
  let LOCATIONS = [];
  function addMarkers(){
    markersLayer.clearLayers();
    LOCATIONS.forEach(loc => {
      const m = L.marker([loc.lat, loc.lon]);
      m.bindPopup(`<b>${loc.name}</b><br>${loc.region}, ${loc.country}`);
      m.on("click", () => renderLocation(loc));
      markersLayer.addLayer(m);
    });
  }

  // ========= INIT =========
  wireSetupControls();
  setHeroText(null);

  (async () => {
    try{
      LOCATIONS = await loadLocations();
      addMarkers();
      const bounds = L.latLngBounds(LOCATIONS.map(l => [l.lat, l.lon]));
      map.fitBounds(bounds.pad(0.2));
      setTimeout(() => map.invalidateSize(), 200);
    }catch(e){
      console.error(e);
      document.getElementById("panelBody").innerHTML = `
        <h2 class="title">Error loading locations</h2>
        <div class="muted">${e.message}</div>
        <div class="hint" style="margin-top:10px;">
          Check that <code>data/locations.geojson</code> exists and is committed.
        </div>
      `;
    }
  })();

  // ========= AVATAR PLACEHOLDER (optional) =========
  function setAvatarSrc(id, src){
    const el = document.getElementById(id);
    if (!el) return;
    if (!src) { el.style.display = 'none'; el.removeAttribute('src'); return; }
    el.src = src;
    el.style.display = '';
  }

  // позже сюда вставишь свои PNG:
  setAvatarSrc("charBase", "");
  setAvatarSrc("layerHair", "");
  setAvatarSrc("layerBase", "");
  setAvatarSrc("layerMid", "");
  setAvatarSrc("layerShell", "");
  setAvatarSrc("layerPants", "");
  setAvatarSrc("layerGloves", "");
</script>
</body>
</html>


