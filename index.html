<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meow meow land</title>
  
<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#eaf0ff; --muted:#9fb0d0; --line:#24304a; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    header { padding:14px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:12px; }
    header .badge { font-size:12px; color:var(--muted); border:1px solid var(--line); padding:4px 8px; border-radius:999px; }
    .wrap { display:grid; grid-template-columns: 1.6fr 1fr; height: calc(100vh - 56px); }
    #map { height:100%; }
    .side { padding:14px; border-left:1px solid var(--line); overflow:auto; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:12px; }
    .title { font-size:18px; margin:0 0 6px 0; }
    .muted { color:var(--muted); font-size:13px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .pill { border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:13px; color:var(--muted); }
    button { cursor:pointer; width:100%; border:0; border-radius:12px; padding:10px 12px; background:#2a6dff; color:white; font-weight:600; margin-top:12px; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .hint { font-size:13px; color:var(--muted); line-height:1.4; }
    @media (max-width: 900px){
      .wrap { grid-template-columns: 1fr; }
      .side { border-left:0; border-top:1px solid var(--line); height:42vh; }
      #map { height: calc(58vh); }
    }
  </style>
</head>

<body>
  <header>
    <div style="font-weight:700;">Ski Touring Gear Finder</div>
    <div class="badge">MVP • one page • Leaflet</div>
  </header>

  <div class="wrap">
    <div id="map"></div>

    <div class="side">
      <div class="card" id="panel">
        <h2 class="title">Pick a mountain</h2>
        <div class="hint">Click a marker on the map. Today we set up the map + locations. Next: temperature & budget logic.</div>
      </div>

      <div class="card">
        <div class="muted">
          Disclaimer (draft): Recommendations are generic and informational only. Always check real weather & avalanche bulletin before touring.
        </div>
      </div>
    </div>
  </div>

<script>
  // --- 1) Data (Day 1): a small, editable list of places ---
  // tempProfile is "typical" for now: will be replaced/extended later.
  
  async function loadLocations() {
  const res = await fetch("./data/locations.geojson");
  if (!res.ok) throw new Error("Failed to load GeoJSON: " + res.status);
  const geo = await res.json();

  return geo.features.map(f => {
    const p = f.properties;
    const [lon, lat] = f.geometry.coordinates;

    return {
      id: p.id,
      name: p.name,
      region: p.region,
      country: p.country,
      lat, lon,
      base_m: p.base_m,
      top_m: p.top_m,
      tempProfile: { mild: p.mild, normal: p.normal, cold: p.cold }
    };
  });
}
  
  // --- 2) Map init ---
  const map = L.map('map', { zoomControl:true }).setView([45.5, 6.6], 8);

  // Free tiles (OpenStreetMap)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const markersLayer = L.markerClusterGroup({
  showCoverageOnHover: false,
  spiderfyOnMaxZoom: true
});
map.addLayer(markersLayer);
  
// ---------- Weather (Open-Meteo) ----------
const weatherCache = new Map(); // key -> { ts, data }
const WEATHER_TTL_MS = 15 * 60 * 1000; // 15 minutes

function cacheKey(lat, lon) {
  // округлим, чтобы кеш работал стабильнее
  return `${lat.toFixed(3)},${lon.toFixed(3)}`;
}

function weatherCodeToText(code) {
  const map = {
    0: "Clear",
    1: "Mostly clear",
    2: "Partly cloudy",
    3: "Overcast",
    45: "Fog",
    48: "Depositing rime fog",
    51: "Light drizzle",
    53: "Drizzle",
    55: "Heavy drizzle",
    56: "Freezing drizzle",
    57: "Heavy freezing drizzle",
    61: "Light rain",
    63: "Rain",
    65: "Heavy rain",
    66: "Freezing rain",
    67: "Heavy freezing rain",
    71: "Light snow",
    73: "Snow",
    75: "Heavy snow",
    77: "Snow grains",
    80: "Rain showers",
    81: "Rain showers",
    82: "Violent rain showers",
    85: "Snow showers",
    86: "Heavy snow showers",
    95: "Thunderstorm",
    96: "Thunderstorm + hail",
    99: "Thunderstorm + heavy hail"
  };
  return map[code] ?? `Weather code ${code}`;
}

function degToCompass(deg) {
  const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  const i = Math.round((deg % 360) / 22.5) % 16;
  return dirs[i];
}

async function getWeather(lat, lon) {
  const key = cacheKey(lat, lon);
  const cached = weatherCache.get(key);
  if (cached && (Date.now() - cached.ts) < WEATHER_TTL_MS) return cached.data;

  const url =
    `https://api.open-meteo.com/v1/forecast` +
    `?latitude=${encodeURIComponent(lat)}` +
    `&longitude=${encodeURIComponent(lon)}` +
    `&current_weather=true` +
    `&hourly=precipitation,snowfall,cloudcover` +
    `&timezone=auto`;

  const res = await fetch(url);
  if (!res.ok) throw new Error(`Weather API error: ${res.status}`);
  const data = await res.json();

  weatherCache.set(key, { ts: Date.now(), data });
  return data;
}

function pickHourlyAtTime(hourly, targetTimeStr) {
  // targetTimeStr обычно как "2026-01-02T10:00"
  const times = hourly?.time || [];
  const idx = times.indexOf(targetTimeStr);
  if (idx === -1) return null;
  return {
    precipitation: hourly.precipitation?.[idx] ?? null,
    snowfall: hourly.snowfall?.[idx] ?? null,
    cloudcover: hourly.cloudcover?.[idx] ?? null
  };
}

function deriveConditions(current, hourlyAt) {
  const temp = current.temperature;
  const wind = current.windspeed;
  const code = current.weathercode;
  const base = weatherCodeToText(code);

  const snow = hourlyAt?.snowfall ?? 0;
  const rain = hourlyAt?.precipitation ?? 0;
  const cloud = hourlyAt?.cloudcover ?? null;

  // простая “человеческая” метка для условий (для MVP)
  let tags = [];

  if (snow >= 0.2) tags.push("Snowfall");
  else if (rain >= 0.5) tags.push("Wet");

  if (wind >= 35) tags.push("Very windy");
  else if (wind >= 20) tags.push("Windy");

  if (temp <= -12) tags.push("Very cold");
  else if (temp <= -6) tags.push("Cold");
  else if (temp <= 0) tags.push("Near freezing");
  else tags.push("Mild");

  if (cloud !== null) {
    if (cloud >= 80) tags.push("Overcast");
    else if (cloud >= 40) tags.push("Cloudy");
    else tags.push("Sunny-ish");
  }

  return { base, tags };
}

let selectedLocationId = null;

function renderPanel(loc){
  selectedLocationId = loc.id;

  const panel = document.getElementById('panel');
  panel.innerHTML = `
    <h2 class="title">${loc.name}</h2>
    <div class="muted">${loc.region}, ${loc.country}</div>

    <div class="row">
      <div class="pill">Base: ${loc.base_m} m</div>
      <div class="pill">Top: ${loc.top_m} m</div>
    </div>

    <div style="margin-top:12px;" id="weatherBox">
      <div class="muted">Live weather (Open-Meteo)</div>
      <div class="hint" style="margin-top:6px;">Loading…</div>
    </div>

    <button id="nextBtn">Next: budget + gear logic</button>
    <div class="hint" style="margin-top:10px;">
      Next we add: budget slider + gear recommendation using these conditions.
    </div>
  `;

  document.getElementById('nextBtn').onclick = () => {
    alert("Nice. Next: budget + gear logic.");
  };

  // загрузка погоды (асинхронно)
  updateWeatherFor(loc);
}

async function updateWeatherFor(loc) {
  const box = document.getElementById('weatherBox');
  try {
    const data = await getWeather(loc.lat, loc.lon);

    // если пользователь уже кликнул другую гору — не обновляем старую карточку
    if (selectedLocationId !== loc.id) return;

    const current = data.current_weather;
    const hourlyAt = pickHourlyAtTime(data.hourly, current.time);
    const cond = deriveConditions(current, hourlyAt);

    const windDir = degToCompass(current.winddirection);

    const precip = hourlyAt?.precipitation;
    const snow = hourlyAt?.snowfall;
    const cloud = hourlyAt?.cloudcover;

    box.innerHTML = `
      <div class="muted">Live weather (Open-Meteo)</div>

      <div class="row" style="margin-top:8px;">
        <div class="pill">Temp: ${Math.round(current.temperature)}°C</div>
        <div class="pill">Wind: ${Math.round(current.windspeed)} km/h ${windDir}</div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="pill">${cond.base}</div>
        ${cond.tags.map(t => `<div class="pill">${t}</div>`).join("")}
      </div>

      <div class="hint" style="margin-top:10px;">
        ${precip != null ? `Precip: ${precip} mm/h` : "Precip: n/a"} •
        ${snow != null ? `Snow: ${snow} cm/h` : "Snow: n/a"} •
        ${cloud != null ? `Cloud: ${cloud}%` : "Cloud: n/a"} •
        Updated: ${current.time}
      </div>
    `;
  } catch (e) {
    console.error(e);
    box.innerHTML = `
      <div class="muted">Live weather (Open-Meteo)</div>
      <div class="hint" style="margin-top:6px;">
        Couldn’t load weather. Try refresh (Ctrl+F5).<br/>
        <span class="muted">${e.message}</span>
      </div>
    `;
  }
}
  
let LOCATIONS = [];

(async () => {
  try {
    LOCATIONS = await loadLocations();
    addMarkers();

    const bounds = L.latLngBounds(LOCATIONS.map(l => [l.lat, l.lon]));
    map.fitBounds(bounds.pad(0.35));
  } catch (e) {
    console.error(e);
    document.getElementById('panel').innerHTML = `
      <h2 class="title">Error loading locations</h2>
      <div class="muted">${e.message}</div>
      <div class="hint" style="margin-top:10px;">
        Check that <code>data/locations.geojson</code> exists and is committed.
      </div>
    `;
  }
})();

  function addMarkers(){
    markersLayer.clearLayers();
    LOCATIONS.forEach(loc => {
      const m = L.marker([loc.lat, loc.lon]);
      m.bindPopup(`<b>${loc.name}</b><br>${loc.region}, ${loc.country}`);
      m.on('click', () => renderPanel(loc));
      markersLayer.addLayer(m);
    });
  }
</script>
</body>
</html>
