<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ski Touring Gear Finder</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --text:#eaf0ff; --muted:#9fb0d0; --line:#24304a; --blue:#2a6dff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      overflow-y:auto;
    }
    header{
      height:56px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      gap:12px;
      position:sticky;
      top:0;
      background:rgba(11,18,32,0.92);
      backdrop-filter: blur(8px);
      z-index: 50;
    }
    header .badge{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px; border-radius:999px;
    }

    /* ===== MAIN GRID ===== */
    .wrap{
      min-height: calc(100vh - 56px);
      display:grid;
      grid-template-columns: 1.15fr 1fr;
      grid-template-rows: 320px auto auto;
      gap:12px;
      padding:12px;
      align-content:start;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      overflow:hidden;
      min-height:0;
    }
    .title{ font-size:18px; margin:0 0 6px 0; }
    .muted{ color:var(--muted); font-size:13px; }
    .hint{ font-size:13px; color:var(--muted); line-height:1.4; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:13px;
      color:var(--muted);
      background: rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
    }

    /* ===== TOP LEFT: MAP ===== */
    #mapCard{ grid-column:1; grid-row:1; padding:0; }
    #map{ width:100%; height:100%; border-radius:14px; }

    /* ===== TOP RIGHT: INFO ===== */
    #infoCard{ grid-column:2; grid-row:1; padding:0; position:relative; overflow:hidden; }
    .infoHero{
      position:relative;
      height:112px;
      background:#0d1426;
      overflow:hidden;
      border-bottom:1px solid var(--line);
    }
    .infoHero .bg{
      position:absolute;
      inset:0;
      background-size: cover;
      background-position:center;
      filter: blur(6px);
      transform: scale(1.04);
      opacity: 0.75;
    }
    .infoHero .overlay{
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.80));
    }
    .infoHeroContent{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding:12px 14px;
      z-index:2;
    }
    .infoHeroTopRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .infoHeroTitle{
      margin:0;
      font-size:20px;
      font-weight:900;
      text-shadow: 0 6px 30px rgba(0,0,0,0.55);
    }
    .infoHeroSub{
      margin-top:2px;
      color:rgba(234,240,255,0.78);
      font-size:13px;
      text-shadow: 0 6px 30px rgba(0,0,0,0.55);
    }
    .infoBody{ padding:14px; }
    .divider{ height:1px; background:var(--line); margin:12px 0; opacity:0.9; }

    /* ===== OUTFIT ===== */
    #outfitCard{ grid-column:1 / 3; grid-row:2; }
    .outfitGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:10px;
      align-items:start;
      justify-items:center;
    }
    .avatarBox{
      border:1px dashed var(--line);
      border-radius:14px;
      padding:12px;
      background: rgba(255,255,255,0.02);
      width: 100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap:14px;
    }
    .avatarStage{
      position:relative;
      width: 100%;
      max-width: 820px;
      height: 720px;
      border-radius:12px;
      overflow:hidden;
      background: radial-gradient(circle at 30% 10%, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
    }
    .avatarStage img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      pointer-events:none;
      user-select:none;
    }

    .controlsWrap{
      width: 100%;
      max-width: 820px;
      height:auto;
      border:none;
      border-radius:0;
      padding:0;
      background:transparent;
    }
    .controlsHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .controlsHeaderTitle{ font-weight:900; }
    .toggle{ display:flex; gap:8px; margin-top:10px; }
    .toggle button{
      flex:1;
      background:transparent;
      border:1px solid var(--line);
      color:var(--muted);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
    }
    .toggle button.active{
      background:var(--blue);
      border-color:var(--blue);
      color:#fff;
    }
    .control{ margin-top:12px; }
    .control label{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    input[type="range"]{ width:100%; margin-top:8px; }
    .kpi{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }

    /* Date input */
    #datePick{
      background:rgba(0,0,0,0.18);
      border:1px solid var(--line);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      outline:none;
    }

    /* ===== LIST ===== */
    #listCard{ grid-column:1 / 3; grid-row:3; overflow:visible; }
    .item{
      display:grid;
      grid-template-columns: 90px 1fr 120px;
      gap:12px;
      padding:10px;
      border:1px solid var(--line);
      border-radius:14px;
      margin-top:10px;
      align-items:center;
    }
    .thumb{ width:90px; height:70px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,0.03); }
    .item h4{ margin:0 0 4px 0; font-size:14px; }
    .item a{
      display:inline-block;
      text-align:center;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(42,109,255,0.15);
      border:1px solid rgba(42,109,255,0.35);
      color:#cfe0ff;
      text-decoration:none;
      font-weight:900;
    }

    /* ===== MOBILE ===== */
    @media (max-width: 980px){
      .wrap{
        grid-template-columns: 1fr;
        grid-template-rows: 260px auto auto auto;
      }
      #mapCard{ grid-column:1; grid-row:1; }
      #infoCard{ grid-column:1; grid-row:2; }
      #outfitCard{ grid-column:1; grid-row:3; }
      #listCard{ grid-column:1; grid-row:4; }

      .avatarStage{ max-width: 720px; height: 560px; }
      .controlsWrap{ max-width: 720px; }
    }
  </style>
</head>

<body>
  <header>
    <div style="font-weight:900;">Ski Touring Gear Finder</div>
    <div class="badge">MVP • one page • Leaflet</div>
  </header>

  <div class="wrap">
    <!-- MAP -->
    <div class="card" id="mapCard">
      <div id="map"></div>
    </div>

    <!-- INFO -->
    <div class="card" id="infoCard">
      <div class="infoHero">
        <div class="bg" id="infoBg"></div>
        <div class="overlay"></div>

        <div class="infoHeroContent" id="infoHeroContent">
          <div class="infoHeroTopRow">
            <div>
              <h2 class="infoHeroTitle" id="infoTitle">Pick a mountain</h2>
              <div class="infoHeroSub" id="infoSub">Click a marker on the map</div>
            </div>
            <div class="row" style="margin-top:0;">
              <div class="pill" id="pillBase" style="display:none;">Base: —</div>
              <div class="pill" id="pillTop" style="display:none;">Top: —</div>
            </div>
          </div>
        </div>
      </div>

      <div class="infoBody" id="panelBody">
        <div class="muted">Forecast (Open-Meteo)</div>
        <div class="row" style="margin-top:10px; align-items:center;">
          <div class="pill">Date</div>
          <input id="datePick" type="date">
        </div>
        <div class="hint" style="margin-top:10px;">Pick a mountain to load forecast.</div>
      </div>
    </div>

    <!-- OUTFIT -->
    <div class="card" id="outfitCard">
      <h2 class="title">Outfit preview</h2>
      <div class="muted">Base model + layers (later PNG). Controls are inside this card.</div>

      <div class="outfitGrid">
        <div class="avatarBox">
          <div class="avatarStage">
            <img id="charBase" alt="Character base">
            <img id="layerHair" alt="Hair">
            <img id="layerBase" alt="Base layer">
            <img id="layerMid" alt="Mid layer">
            <img id="layerShell" alt="Shell">
            <img id="layerPants" alt="Pants">
            <img id="layerGloves" alt="Gloves">
          </div>

          <div class="controlsWrap" id="controlsWrap">
            <div class="controlsHeader">
              <div>
                <div class="controlsHeaderTitle">Setup</div>
                <div class="muted" style="margin-top:4px;">Sport + temperature (budget hidden for now)</div>
              </div>
              <div class="pill" id="levelVal">Level: Cold</div>
            </div>

            <div class="toggle" role="tablist" aria-label="Sport switch">
              <button id="btnSki" class="active" type="button">Ski</button>
              <button id="btnSnow" type="button">Snowboard</button>
            </div>

            <div class="control">
              <label>
                <span>Temperature</span>
                <span class="pill" id="tempVal">-8°C</span>
              </label>
              <input id="tempRange" type="range" min="-25" max="5" step="1" value="-8">
            </div>

            <div class="kpi">
              <div class="pill" id="sportVal">Sport: Ski</div>
            </div>

            <div class="hint" style="margin-top:12px;">
              Tip: pick a mountain + date to auto-set temperature from forecast.
            </div>
          </div>
        </div>
      </div>

      <div class="hint" style="margin-top:10px;">
        Later: drop PNGs into <code>assets/character/</code> and <code>assets/gear/</code> and we’ll swap layers by logic.
      </div>
    </div>

    <!-- LIST -->
    <div class="card" id="listCard">
      <h2 class="title">Recommended gear</h2>
      <div class="muted">Placeholder list (next: real items + affiliate links).</div>

      <div class="item">
        <div class="thumb"></div>
        <div>
          <h4>Base layer (merino top)</h4>
          <div class="muted">Warm, breathable, next-to-skin.</div>
        </div>
        <a href="#" onclick="return false;">Link</a>
      </div>

      <div class="item">
        <div class="thumb"></div>
        <div>
          <h4>Shell jacket (Gore-Tex style)</h4>
          <div class="muted">Windproof + waterproof protection.</div>
        </div>
        <a href="#" onclick="return false;">Link</a>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="muted">
          Disclaimer (draft): Recommendations are generic and informational only. Always check real weather & avalanche bulletin before touring.
        </div>
      </div>
    </div>
  </div>

<script>
  // ========= LOAD LOCATIONS =========
  async function loadLocations() {
    const res = await fetch("./data/locations.geojson");
    if (!res.ok) throw new Error("Failed to load GeoJSON: " + res.status);
    const geo = await res.json();

    return geo.features.map(f => {
      const p = f.properties;
      const [lon, lat] = f.geometry.coordinates;
      return {
        id: p.id,
        name: p.name,
        region: p.region,
        country: p.country,
        image: p.image || null,
        lat, lon,
        base_m: p.base_m,
        top_m: p.top_m,
        tempProfile: { mild: p.mild, normal: p.normal, cold: p.cold }
      };
    });
  }

  // ========= MAP INIT =========
  const map = L.map("map", { zoomControl:true }).setView([45.5, 6.6], 8);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  const markersLayer = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true });
  map.addLayer(markersLayer);

  setTimeout(() => map.invalidateSize(), 250);

  // ========= WEATHER (Open-Meteo) =========
  const weatherCache = new Map();
  const WEATHER_TTL_MS = 15 * 60 * 1000;
  function cacheKey(lat, lon){ return `${lat.toFixed(3)},${lon.toFixed(3)}`; }

  function weatherCodeToText(code) {
    const m = {
      0:"Clear",1:"Mostly clear",2:"Partly cloudy",3:"Overcast",45:"Fog",48:"Rime fog",
      51:"Light drizzle",53:"Drizzle",55:"Heavy drizzle",
      61:"Light rain",63:"Rain",65:"Heavy rain",
      71:"Light snow",73:"Snow",75:"Heavy snow",
      80:"Rain showers",85:"Snow showers",
      95:"Thunderstorm"
    };
    return m[code] ?? `Weather code ${code}`;
  }

  async function getWeather(lat, lon){
    const key = cacheKey(lat, lon);
    const cached = weatherCache.get(key);
    if (cached && (Date.now() - cached.ts) < WEATHER_TTL_MS) return cached.data;

    const url =
      `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${encodeURIComponent(lat)}` +
      `&longitude=${encodeURIComponent(lon)}` +
      `&current_weather=true` +
      `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,snowfall_sum,windspeed_10m_max,weathercode` +
      `&forecast_days=16` +
      `&timezone=auto`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`Weather API error: ${res.status}`);
    const data = await res.json();
    weatherCache.set(key, { ts: Date.now(), data });
    return data;
  }

  function pickDailyByDate(daily, dateStr){
    const times = daily?.time || [];
    const idx = times.indexOf(dateStr);
    if (idx === -1) return null;
    return {
      date: dateStr,
      tmin: daily.temperature_2m_min?.[idx],
      tmax: daily.temperature_2m_max?.[idx],
      precip: daily.precipitation_sum?.[idx],
      snow: daily.snowfall_sum?.[idx],
      windMax: daily.windspeed_10m_max?.[idx],
      code: daily.weathercode?.[idx],
    };
  }

  function renderDailyForecast(day){
    const body = document.getElementById("panelBody");

    if (!day){
      body.innerHTML = `
        <div class="muted">Forecast (Open-Meteo)</div>
        <div class="row" style="margin-top:10px; align-items:center;">
          <div class="pill">Date</div>
          <input id="datePick" type="date">
        </div>
        <div class="hint" style="margin-top:10px;">No forecast for this date (try another).</div>
      `;
      wireDatePicker();
      return;
    }

    const base = weatherCodeToText(day.code);

    body.innerHTML = `
      <div class="muted">Forecast (Open-Meteo)</div>

      <div class="row" style="margin-top:10px; align-items:center;">
        <div class="pill">Date</div>
        <input id="datePick" type="date" value="${day.date}">
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="pill">${base}</div>
        <div class="pill">Min: ${Math.round(day.tmin)}°C</div>
        <div class="pill">Max: ${Math.round(day.tmax)}°C</div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="pill">Precip: ${day.precip ?? "n/a"} mm</div>
        <div class="pill">Snow: ${day.snow ?? "n/a"} cm</div>
        <div class="pill">Wind max: ${day.windMax ?? "n/a"} km/h</div>
      </div>

      <div class="divider"></div>

      <div class="hint">Tip: date affects outfit temperature suggestion.</div>
    `;

    wireDatePicker();
  }

  // ========= STATE (Controls) =========
  const state = { sport:"ski", tempC:-8, budget:800, date:null };
  let selectedLocationId = null;
  let LAST_WEATHER_DATA = null;

  function tempLevel(t){
    if (t <= -12) return "Very cold";
    if (t <= -6) return "Cold";
    if (t <= 0) return "Near freezing";
    return "Mild";
  }

  function updateSetupUI(){
    document.getElementById("tempVal").textContent = `${state.tempC}°C`;
    document.getElementById("sportVal").textContent = `Sport: ${state.sport === "ski" ? "Ski" : "Snowboard"}`;
    document.getElementById("levelVal").textContent = `Level: ${tempLevel(state.tempC)}`;
  }

  function wireSetupControls(){
    const tempRange = document.getElementById("tempRange");
    const btnSki = document.getElementById("btnSki");
    const btnSnow = document.getElementById("btnSnow");

    tempRange.value = state.tempC;

    tempRange.addEventListener("input", () => {
      state.tempC = parseInt(tempRange.value, 10);
      updateSetupUI();
    });

    btnSki.addEventListener("click", () => {
      state.sport = "ski";
      btnSki.classList.add("active");
      btnSnow.classList.remove("active");
      updateSetupUI();
    });

    btnSnow.addEventListener("click", () => {
      state.sport = "snow";
      btnSnow.classList.add("active");
      btnSki.classList.remove("active");
      updateSetupUI();
    });

    updateSetupUI();
  }

  function wireDatePicker(){
    const el = document.getElementById("datePick");
    if (!el) return;

    // set default if we know one
    if (state.date && !el.value) el.value = state.date;

    el.onchange = () => {
      state.date = el.value;
      if (!LAST_WEATHER_DATA) return;

      const day = pickDailyByDate(LAST_WEATHER_DATA.daily, state.date);
      if (day && typeof day.tmin === "number" && typeof day.tmax === "number"){
        state.tempC = Math.round((day.tmin + day.tmax) / 2);
        const range = document.getElementById("tempRange");
        if (range) range.value = state.tempC;
        updateSetupUI();
      }
      renderDailyForecast(day);
    };
  }

  // ========= INFO RENDER =========
  function setInfoImage(url){
    const bg = document.getElementById("infoBg");
    if (url) {
      bg.style.backgroundImage = `url('${url}')`;
      bg.style.display = "";
    } else {
      bg.style.backgroundImage = "none";
      bg.style.display = "none";
    }
  }

  function setHeroText(loc){
    document.getElementById("infoTitle").textContent = loc ? loc.name : "Pick a mountain";
    document.getElementById("infoSub").textContent = loc ? `${loc.region}, ${loc.country}` : "Click a marker on the map";

    const pillBase = document.getElementById("pillBase");
    const pillTop = document.getElementById("pillTop");

    if (loc){
      pillBase.style.display = "";
      pillTop.style.display = "";
      pillBase.textContent = `Base: ${loc.base_m}m`;
      pillTop.textContent = `Top: ${loc.top_m}m`;
    } else {
      pillBase.style.display = "none";
      pillTop.style.display = "none";
    }
  }

  function renderPanelBodyLoading(){
    const body = document.getElementById("panelBody");
    body.innerHTML = `
      <div class="muted">Forecast (Open-Meteo)</div>
      <div class="row" style="margin-top:10px; align-items:center;">
        <div class="pill">Date</div>
        <input id="datePick" type="date">
      </div>
      <div class="hint" style="margin-top:6px;">Loading…</div>
    `;
    wireDatePicker();
  }

  function renderPanelBodyError(msg){
    const body = document.getElementById("panelBody");
    body.innerHTML = `
      <div class="muted">Forecast (Open-Meteo)</div>
      <div class="row" style="margin-top:10px; align-items:center;">
        <div class="pill">Date</div>
        <input id="datePick" type="date">
      </div>
      <div class="hint" style="margin-top:10px;">
        Couldn’t load forecast. Try refresh (Ctrl+F5).<br/>
        <span class="muted">${msg}</span>
      </div>
    `;
    wireDatePicker();
  }

  async function updateWeatherFor(loc){
    renderPanelBodyLoading();
    try{
      const data = await getWeather(loc.lat, loc.lon);
      if (selectedLocationId !== loc.id) return;

      LAST_WEATHER_DATA = data;

      // default date = today (YYYY-MM-DD)
      const today = data.current_weather?.time?.slice(0,10);
      state.date = state.date || today || (data.daily?.time?.[0] ?? null);

      // ensure date in available range
      const dailyTimes = data.daily?.time || [];
      if (dailyTimes.length && state.date && !dailyTimes.includes(state.date)) {
        state.date = dailyTimes[0];
      }

      const day = state.date ? pickDailyByDate(data.daily, state.date) : null;
      renderDailyForecast(day);

      // auto-set outfit temperature from forecast day (if available)
      if (day && typeof day.tmin === "number" && typeof day.tmax === "number") {
        state.tempC = Math.round((day.tmin + day.tmax) / 2);
        document.getElementById("tempRange").value = state.tempC;
        updateSetupUI();
      }

    }catch(e){
      console.error(e);
      renderPanelBodyError(e.message);
    }
  }

  function renderLocation(loc){
    selectedLocationId = loc.id;
    setInfoImage(loc.image);
    setHeroText(loc);
    updateWeatherFor(loc);
  }

  // ========= MARKERS =========
  let LOCATIONS = [];
  function addMarkers(){
    markersLayer.clearLayers();
    LOCATIONS.forEach(loc => {
      const m = L.marker([loc.lat, loc.lon]);
      m.bindPopup(`<b>${loc.name}</b><br>${loc.region}, ${loc.country}`);
      m.on("click", () => renderLocation(loc));
      markersLayer.addLayer(m);
    });
  }

  // ========= INIT =========
  wireSetupControls();
  setHeroText(null);
  wireDatePicker();

  (async () => {
    try{
      LOCATIONS = await loadLocations();
      addMarkers();
      const bounds = L.latLngBounds(LOCATIONS.map(l => [l.lat, l.lon]));
      map.fitBounds(bounds.pad(0.2));
      setTimeout(() => map.invalidateSize(), 200);
    }catch(e){
      console.error(e);
      document.getElementById("panelBody").innerHTML = `
        <h2 class="title">Error loading locations</h2>
        <div class="muted">${e.message}</div>
        <div class="hint" style="margin-top:10px;">
          Check that <code>data/locations.geojson</code> exists and is committed.
        </div>
      `;
    }
  })();

  // ========= AVATAR PLACEHOLDER =========
  function setAvatarSrc(id, src){
    const el = document.getElementById(id);
    if (!el) return;
    if (!src) { el.style.display = 'none'; el.removeAttribute('src'); return; }
    el.src = src;
    el.style.display = '';
  }

  setAvatarSrc("charBase", "");
  setAvatarSrc("layerHair", "");
  setAvatarSrc("layerBase", "");
  setAvatarSrc("layerMid", "");
  setAvatarSrc("layerShell", "");
  setAvatarSrc("layerPants", "");
  setAvatarSrc("layerGloves", "");
</script>
</body>
</html>





